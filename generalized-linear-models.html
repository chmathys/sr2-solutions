<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Week 5: Generalized Linear Models | Statistical Rethinking: Solutions (2nd Edition)</title>
<meta name="author" content="Jake Thompson">
<meta name="description" content="The fifth week covers Chapter 10 (Big Entropy and the Generalized Linear Model), and Chapter 11 (God Spiked the Integers).  5.1 Lectures Lecture 9:  Lecture 10:   5.2 Exercises  5.2.1 Chapter 10...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Week 5: Generalized Linear Models | Statistical Rethinking: Solutions (2nd Edition)">
<meta property="og:type" content="book">
<meta property="og:url" content="https://sr2-solutions.wjakethompson.com/generalized-linear-models.html">
<meta property="og:description" content="The fifth week covers Chapter 10 (Big Entropy and the Generalized Linear Model), and Chapter 11 (God Spiked the Integers).  5.1 Lectures Lecture 9:  Lecture 10:   5.2 Exercises  5.2.1 Chapter 10...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Week 5: Generalized Linear Models | Statistical Rethinking: Solutions (2nd Edition)">
<meta name="twitter:site" content="@wjakethompson">
<meta name="twitter:description" content="The fifth week covers Chapter 10 (Big Entropy and the Generalized Linear Model), and Chapter 11 (God Spiked the Integers).  5.1 Lectures Lecture 9:  Lecture 10:   5.2 Exercises  5.2.1 Chapter 10...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/_Source%20Sans%20Pro-0.4.0.9000/font.css" rel="stylesheet">
<link href="libs/_Fira%20Code-0.4.0.9000/font.css" rel="stylesheet">
<link href="libs/_Oxygen-0.4.0.9000/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="assets/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Statistical Rethinking: Solutions (2nd Edition)</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="bayesian-inference.html"><span class="header-section-number">1</span> Bayesian Inference</a></li>
<li><a class="" href="linear-models-causal-inference.html"><span class="header-section-number">2</span> Linear Models &amp; Causal Inference</a></li>
<li><a class="" href="causes-confounds-colliders.html"><span class="header-section-number">3</span> Causes, Confounds &amp; Colliders</a></li>
<li><a class="" href="overfitting-mcmc.html"><span class="header-section-number">4</span> Overfitting / MCMC</a></li>
<li><a class="active" href="generalized-linear-models.html"><span class="header-section-number">5</span> Generalized Linear Models</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/wjakethompson/sr2-solutions">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="generalized-linear-models" class="section level1" number="5">
<h1>
<span class="header-section-number">Week 5:</span> Generalized Linear Models<a class="anchor" aria-label="anchor" href="#generalized-linear-models"><i class="fas fa-link"></i></a>
</h1>
<p>The fifth week covers <a href="https://bookdown.org/content/4857/big-entropy-and-the-generalized-linear-model.html">Chapter 10 (Big Entropy and the Generalized Linear Model)</a>, and <a href="https://bookdown.org/content/4857/god-spiked-the-integers.html">Chapter 11 (God Spiked the Integers)</a>.</p>
<div id="lectures-4" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Lectures<a class="anchor" aria-label="anchor" href="#lectures-4"><i class="fas fa-link"></i></a>
</h2>
<p>Lecture 9:</p>
<iframe src="https://www.youtube.com/embed/nPi5yGbfxuo" width="100%" height="400px" data-external="1">
</iframe>
<p>Lecture 10:</p>
<iframe src="https://www.youtube.com/embed/YrwL6t0kW2I" width="100%" height="400px" data-external="1">
</iframe>
</div>
<div id="exercises-4" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-4"><i class="fas fa-link"></i></a>
</h2>
<div id="chapter-10" class="section level3" number="5.2.1">
<h3>
<span class="header-section-number">5.2.1</span> Chapter 10<a class="anchor" aria-label="anchor" href="#chapter-10"><i class="fas fa-link"></i></a>
</h3>
<p>Chapter 10 is a conceptual chapter, so there are no exercises to complete.</p>
</div>
<div id="chapter-11" class="section level3" number="5.2.2">
<h3>
<span class="header-section-number">5.2.2</span> Chapter 11<a class="anchor" aria-label="anchor" href="#chapter-11"><i class="fas fa-link"></i></a>
</h3>
<div class="question">
<blockquote>
<p><strong>11E1.</strong> If an event has probability 0.35, what are the log-odds of this event?</p>
</blockquote>
</div>
<p>The log-odds are given by the logit link:</p>
<p><span class="math display">\[
\log\frac{p}{1-p}
\]</span></p>
<p>In code:</p>
<div class="sourceCode" id="cb250"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">0.35</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">0.35</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] -0.619</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>11E2.</strong> If an event has log-odds 3.2, what is the probability of this event?</p>
</blockquote>
</div>
<p>To convert from log-odds to probability, we use the inverse logit, which is given by:</p>
<p><span class="math display">\[
\frac{\exp(\alpha)}{\exp(\alpha) + 1}
\]</span>
In code:</p>
<div class="sourceCode" id="cb251"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">3.2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">3.2</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.961</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>11E3.</strong> Suppose that a coefficient in a logistic regression has value 1.7. What does this imply about the proportional change in odds of the outcome?</p>
</blockquote>
</div>
<p>We can calculate the proportional odds by exponentiating the coefficient.</p>
<div class="sourceCode" id="cb252"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fl">1.7</span><span class="op">)</span>
<span class="co">#&gt; [1] 5.47</span></code></pre></div>
<p>A proportional odds of about 5.5 means that each unit increase in the predictor multiplies the odds of the outcome occurring by 5.5.</p>
<div class="question">
<blockquote>
<p><strong>11E4.</strong> Why do Poisson regressions sometimes require the use of an <em>offset</em>? Provide an example.</p>
</blockquote>
</div>
<p>An offset is the duration that a count was accumulated during. If all of the observations were accumulated during the same observation periods, then an offset is not needed. However, if there are differences (e.g., some counts are weekly while others are daily), an offset is needed.</p>
<p>As an example, say you were modeling how many houses Realtor sells. If some Realtors provide you data with weekly counts of houses sold, and some provide monthly data, you will need an offset to account for the fact that we expect larger counts from longer periods of time.</p>
<div class="question">
<blockquote>
<p><strong>11M1.</strong> As explained in the chapter, binomial data can be organized in aggregated and disaggregated forms, without any impact on inference. But the likelihood of the data does change when the data are converted between the two formats. Can you explain why?</p>
</blockquote>
</div>
<p>The likelihood of the aggregated binomial includes a multiplicative term to account for all the different ways that we could get the observed number of counts. For example, say we saw 2 success in 5 trials. In aggregated form, the likelihood hood is:</p>
<p><span class="math display">\[
\frac{5!}{2!(5-2)!}p^2(1-p)^{5-2}
\]</span>
The fraction out front is the multiplicative term, accounting for all the ways we could see 2 successes out of five trials. In the long disaggregated format, the likelihood would only be:</p>
<p><span class="math display">\[
p^2(1-p)^{5-2}
\]</span></p>
<p>This is because we know exactly how we got 2 out 5 from the series of 1s and 0s. Because there is no multiplicative factor the likelihoods will be different. However, because that multiplicative factor is not a function of <span class="math inline">\(p\)</span>, the posterior distributions, and therefore the inferences, are unaffected.</p>
<div class="question">
<blockquote>
<p><strong>11M2.</strong> If a coefficient in a Poisson regression has value 1.7, what does this imply about the change in the outcome?</p>
</blockquote>
</div>
<p>There is no straightforward answer. Poisson models typically use the log link. Therefore, a change in the outcome resulting from a 1.7 unit change in the predictor depends on the values of the other parameters, and the scale of the predictor. The best we can do is calculate a proportional change in the odds. Doing that, this question is the same as <strong>11E3.</strong>, and a 1.7 unit change in the predictor results in 5.5 times increase in the odds.</p>
<div class="question">
<blockquote>
<p><strong>11M3.</strong> Explain why the logit link is appropriate for a binomial generalized linear model.</p>
</blockquote>
</div>
<p>In binomial models, we need to map the continuous values from the linear model to the probability space constrained between 0 and 1. The logit link is on possible way to do this. Other link function can accomplish the same thing (e.g., the probit link), but any function that will map continuous values to a [0,1] bounded space will do the trick.</p>
<div class="question">
<blockquote>
<p><strong>11M4.</strong> Explain why the log link is appropriate for a Poisson generalized linear model.</p>
</blockquote>
</div>
<p>Similar to the previous question, we now need a function that maps the continuous linear model to a strictly positive space. The log link accomplishes this. The inverse of the log link is the exponential, and any value that is exponentiated will be positive.</p>
<div class="question">
<blockquote>
<p><strong>11M5.</strong> What would it imply to use a logit link for the mean of a Poisson generalized linear model? Can you think of a real research problem for which this would make sense?</p>
</blockquote>
</div>
<p>A logit link would imply a model with a known maximum count. Normally, this value is 1, but it could be any arbitrary number such as, where <span class="math inline">\(M\)</span> is the maximum count:</p>
<p><span class="math display">\[
\begin{align}
  y_i &amp;\sim \text{Poisson}(\mu_i) \\
  \log\frac{\mu_i}{M - \mu_i} &amp;= \alpha + \beta x_i
\end{align}
\]</span>
Usually, if there is a known maximum, it makes more sense to use a binomial model. However, if <span class="math inline">\(M\)</span> is very large such that you may never reach it, and the probability is low, this type of logit-Poisson could be used.</p>
<div class="question">
<blockquote>
<p><strong>11M6.</strong> State the constraints for which the binomial and Poisson distributions have maximum entropy. Are the constraints different at all for binomial and Poisson? Why or why not?</p>
</blockquote>
</div>
<p>The constraints for the binomial and Poisson are the same because the Poisson is the same as a binomial model where the number of trials is very large and the probability of observing the event is very low. The constraints are:</p>
<ol style="list-style-type: decimal">
<li>Discrete binary outcomes</li>
<li>Constant probability of the event across trials</li>
</ol>
<div class="question">
<blockquote>
<p><strong>11M7.</strong> Use <code>quap</code> to construct a quadratic approximate posterior distribution for the chimpanzee model that includes a unique intercept for each action, <code>m11.4</code> (page 330). Compare the quadratic approximation to the posterior distribution produced instead from MCMC. Can you explain both the differences and the similarities between the approximate and the MCMC distributions? Relax the prior on the actor intercepts to Normal(0,10). Re-estimate the posterior using both <code>ulam</code> and <code>quap</code>. Do the difference increase or decrease? Why?</p>
</blockquote>
</div>
<p>We’ll start by estimating <code>m11.4</code> with both <code><a href="https://rdrr.io/pkg/rethinking/man/quap.html">quap()</a></code> and <code><a href="https://rdrr.io/pkg/brms/man/brm.html">brm()</a></code>.</p>
<div class="sourceCode" id="cb253"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"chimpanzees"</span><span class="op">)</span>

<span class="va">chimp_dat</span> <span class="op">&lt;-</span> <span class="va">chimpanzees</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">prosoc_left</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">condition</span>,
         treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span>,
         actor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">actor</span><span class="op">)</span><span class="op">)</span>

<span class="va">dat_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pulled_left <span class="op">=</span> <span class="va">chimp_dat</span><span class="op">$</span><span class="va">pulled_left</span>,
                 actor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">chimp_dat</span><span class="op">$</span><span class="va">actor</span><span class="op">)</span>,
                 treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">chimp_dat</span><span class="op">$</span><span class="va">treatment</span><span class="op">)</span><span class="op">)</span>

<span class="va">q11.4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/quap.html">quap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">alist</a></span><span class="op">(</span><span class="va">pulled_left</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">dbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">p</span><span class="op">)</span>,
                    <span class="fu">logit</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">a</span><span class="op">[</span><span class="va">actor</span><span class="op">]</span> <span class="op">+</span> <span class="va">b</span><span class="op">[</span><span class="va">treatment</span><span class="op">]</span>,
                    <span class="va">a</span><span class="op">[</span><span class="va">actor</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>,
                    <span class="va">b</span><span class="op">[</span><span class="va">treatment</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,
              data <span class="op">=</span> <span class="va">dat_list</span><span class="op">)</span>

<span class="va">b11.4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">pulled_left</span> <span class="op">~</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span>,
                <span class="va">a</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">actor</span>,
                <span class="va">b</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">treatment</span>,
                nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">chimp_dat</span>, family <span class="op">=</span> <span class="va">bernoulli</span>,
             prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
             iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
             file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11.4"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Looking at the posterior distributions, the quadratic approximation and MCMC are very similar. The only parameter that shows a noticeable difference is Actor 2. Looking a little closer, we see that for Actor 2, MCMC results in a posterior shifted slightly to the right. This is because the MCMC posterior is slightly skewed, whereas the QUAP posterior is forced to be Gaussian. Therefore, more density is given to the lower tail and less to the upper tail than in the MCMC posterior.</p>
<div class="sourceCode" id="cb254"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">q_samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/extract.samples.html">extract.samples</a></span><span class="op">(</span><span class="va">q11.4</span><span class="op">)</span>

<span class="va">q_draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span>
  <span class="va">q_samp</span><span class="op">$</span><span class="va">a</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span>.name_repair <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"b_a_actor"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">q_samp</span><span class="op">$</span><span class="va">a</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">8000</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rowid_to_column</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">".draw"</span><span class="op">)</span>,
  <span class="va">q_samp</span><span class="op">$</span><span class="va">b</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span>.name_repair <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"b_b_treatment"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">q_samp</span><span class="op">$</span><span class="va">b</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">8000</span><span class="op">)</span>
<span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">.draw</span>, names_to <span class="op">=</span> <span class="st">"parameter"</span>, values_to <span class="op">=</span> <span class="st">"QUAP"</span><span class="op">)</span>

<span class="va">b_draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">b11.4</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">lp__</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">.chain</span>, <span class="va">.iteration</span>, <span class="va">.draw</span><span class="op">)</span>,
               names_to <span class="op">=</span> <span class="st">"parameter"</span>, values_to <span class="op">=</span> <span class="st">"MCMC"</span><span class="op">)</span>

<span class="va">post_comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">b_draws</span>, <span class="va">q_draws</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">".draw"</span>, <span class="st">"parameter"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">MCMC</span>, <span class="va">QUAP</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"type"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"b_[a|b]_([a-z]*)([0-9])"</span>,
                                     <span class="st">"\\1 \\2"</span><span class="op">)</span>,
         parameter <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_title</a></span><span class="op">(</span><span class="va">parameter</span><span class="op">)</span><span class="op">)</span>

<span class="va">post_comp</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">parameter</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>key_glyph <span class="op">=</span> <span class="st">"timeseries"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_okabeito</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Value"</span>, y <span class="op">=</span> <span class="st">"Density"</span>, color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-glm_files/figure-html/e11m7-2-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb255"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">post_comp</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">parameter</span> <span class="op">==</span> <span class="st">"Actor 2"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>key_glyph <span class="op">=</span> <span class="st">"timeseries"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_okabeito</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Actor 2"</span>, y <span class="op">=</span> <span class="st">"Density"</span>, color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-glm_files/figure-html/e11m7-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>Now let’s modify our prior distributions. By loosening the prior, we’re letting the actor intercepts take even more extreme values. This should have the effect of letting the posterior become even more skewed.</p>
<div class="sourceCode" id="cb256"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">q11.4_wide</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/quap.html">quap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">alist</a></span><span class="op">(</span><span class="va">pulled_left</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">dbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">p</span><span class="op">)</span>,
                         <span class="fu">logit</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">a</span><span class="op">[</span><span class="va">actor</span><span class="op">]</span> <span class="op">+</span> <span class="va">b</span><span class="op">[</span><span class="va">treatment</span><span class="op">]</span>,
                         <span class="va">a</span><span class="op">[</span><span class="va">actor</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,
                         <span class="va">b</span><span class="op">[</span><span class="va">treatment</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,
                   data <span class="op">=</span> <span class="va">dat_list</span><span class="op">)</span>

<span class="va">b11.4_wide</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">pulled_left</span> <span class="op">~</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span>,
                     <span class="va">a</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">actor</span>,
                     <span class="va">b</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">treatment</span>,
                     nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">chimp_dat</span>, family <span class="op">=</span> <span class="va">bernoulli</span>,
                  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
                            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
                  iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                  file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11.4-wide"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Let’s look at Actor 2 again. We see that the MCMC posterior has much more skew now. However the QUAP posterior is still constrained to be Gaussian. In this case, QUAP is a pretty bad approximation of the true shape of the posterior.</p>
<div class="sourceCode" id="cb257"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">q_samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/extract.samples.html">extract.samples</a></span><span class="op">(</span><span class="va">q11.4_wide</span><span class="op">)</span>

<span class="va">q_draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span>
  <span class="va">q_samp</span><span class="op">$</span><span class="va">a</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span>.name_repair <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"b_a_actor"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">q_samp</span><span class="op">$</span><span class="va">a</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">8000</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rowid_to_column</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">".draw"</span><span class="op">)</span>,
  <span class="va">q_samp</span><span class="op">$</span><span class="va">b</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span>.name_repair <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"b_b_treatment"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">q_samp</span><span class="op">$</span><span class="va">b</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">8000</span><span class="op">)</span>
<span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">.draw</span>, names_to <span class="op">=</span> <span class="st">"parameter"</span>, values_to <span class="op">=</span> <span class="st">"QUAP"</span><span class="op">)</span>

<span class="va">b_draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">b11.4_wide</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">lp__</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">.chain</span>, <span class="va">.iteration</span>, <span class="va">.draw</span><span class="op">)</span>,
               names_to <span class="op">=</span> <span class="st">"parameter"</span>, values_to <span class="op">=</span> <span class="st">"MCMC"</span><span class="op">)</span>

<span class="va">post_comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">b_draws</span>, <span class="va">q_draws</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">".draw"</span>, <span class="st">"parameter"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">MCMC</span>, <span class="va">QUAP</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"type"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"b_[a|b]_([a-z]*)([0-9])"</span>,
                                     <span class="st">"\\1 \\2"</span><span class="op">)</span>,
         parameter <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_title</a></span><span class="op">(</span><span class="va">parameter</span><span class="op">)</span><span class="op">)</span>

<span class="va">post_comp</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">parameter</span> <span class="op">==</span> <span class="st">"Actor 2"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>key_glyph <span class="op">=</span> <span class="st">"timeseries"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_okabeito</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Actor 2"</span>, y <span class="op">=</span> <span class="st">"Density"</span>, color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-glm_files/figure-html/e11m7-5-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>11M8.</strong> Revisit the <code>data(Kline)</code> islands example. This time drop Hawaii from the sample and refit the models. What changes do you observe?</p>
</blockquote>
</div>
<p>First the data and fitting the same model from the chapter.</p>
<div class="sourceCode" id="cb258"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"Kline"</span><span class="op">)</span>

<span class="va">kline_dat</span> <span class="op">&lt;-</span> <span class="va">Kline</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>P <span class="op">=</span> <span class="fu">standardize</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">no_hawaii</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">kline_dat</span>, <span class="va">culture</span> <span class="op">!=</span> <span class="st">"Hawaii"</span><span class="op">)</span>

<span class="va">b11.10b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">total_tools</span> <span class="op">~</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">*</span> <span class="va">P</span>,
                  <span class="va">a</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">contact</span>,
                  <span class="va">b</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">contact</span>,
                  nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">no_hawaii</span>, family <span class="op">=</span> <span class="va">poisson</span>,
               prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
                         <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
               iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
               file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11.10b"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/fit-method-summary.html">summary</a></span><span class="op">(</span><span class="va">b11.10b</span><span class="op">)</span>
<span class="co">#&gt;  Family: poisson </span>
<span class="co">#&gt;   Links: mu = log </span>
<span class="co">#&gt; Formula: total_tools ~ a + b * P </span>
<span class="co">#&gt;          a ~ 0 + contact</span>
<span class="co">#&gt;          b ~ 0 + contact</span>
<span class="co">#&gt;    Data: no_hawaii (Number of observations: 9) </span>
<span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 0; thin = 1;</span>
<span class="co">#&gt;          total post-warmup draws = 8000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Population-Level Effects: </span>
<span class="co">#&gt;               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; a_contacthigh     3.61      0.07     3.46     3.75 1.00     8138     6148</span>
<span class="co">#&gt; a_contactlow      3.18      0.12     2.93     3.41 1.00     6940     5105</span>
<span class="co">#&gt; b_contacthigh     0.19      0.16    -0.12     0.50 1.00     7833     5821</span>
<span class="co">#&gt; b_contactlow      0.19      0.13    -0.06     0.44 1.00     7351     6431</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span>
<span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></code></pre></div>
<p>In this model without Hawaii, the slopes (<code>b_*</code> parameters in the summary) are nearly identical. This is different than the chapter, where high and low contact had different slopes. Thus, it appears that Hawaii was driving the difference in slopes.</p>
<div class="question">
<blockquote>
<p><strong>11H1.</strong> Use WAIC or PSIS to compare the chimpanzee model that includes a unique intercept for each actor, <code>m11.4</code> (page 330), to the simpler models fit in the same section. Interpret the results.</p>
</blockquote>
</div>
<p>There are four models from the chapter that we need to replicate:</p>
<div class="sourceCode" id="cb259"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"chimpanzees"</span><span class="op">)</span>

<span class="va">chimp_dat</span> <span class="op">&lt;-</span> <span class="va">chimpanzees</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">prosoc_left</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">condition</span>,
         treatment <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">treatment</span><span class="op">)</span>,
         actor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">actor</span><span class="op">)</span><span class="op">)</span>

<span class="va">b11.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">pulled_left</span> <span class="op">~</span> <span class="va">a</span>,
                <span class="va">a</span> <span class="op">~</span> <span class="fl">1</span>,
                nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">chimp_dat</span>, family <span class="op">=</span> <span class="va">bernoulli</span>,
             prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span><span class="op">)</span>,
             iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
             file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11.1"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b11.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">pulled_left</span> <span class="op">~</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span>,
                <span class="va">a</span> <span class="op">~</span> <span class="fl">1</span>,
                <span class="va">b</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">treatment</span>,
                nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">chimp_dat</span>, family <span class="op">=</span> <span class="va">bernoulli</span>,
             prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
             iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
             file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11.2"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b11.3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">pulled_left</span> <span class="op">~</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span>,
                <span class="va">a</span> <span class="op">~</span> <span class="fl">1</span>,
                <span class="va">b</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">treatment</span>,
                nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">chimp_dat</span>, family <span class="op">=</span> <span class="va">bernoulli</span>,
             prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
             iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
             file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11.3"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b11.4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">pulled_left</span> <span class="op">~</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span>,
                <span class="va">a</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">actor</span>,
                <span class="va">b</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">treatment</span>,
                nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">chimp_dat</span>, family <span class="op">=</span> <span class="va">bernoulli</span>,
             prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
             iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
             file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11.4"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b11.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b11.1</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="va">b11.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b11.2</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="va">b11.3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b11.3</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="va">b11.4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b11.4</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span></code></pre></div>
<p>Now we can compare using PSIS. The comparison shows pretty strong support for <code>b11.4</code>, which is the model with actor intercepts. Based on what we learned in the chapter, this makes sense. Most of the variation was across individual chimpanzees, rather than across treatments. Thus, adding actor information provides much better predictions.</p>
<div class="sourceCode" id="cb260"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">b11.1</span>, <span class="va">b11.2</span>, <span class="va">b11.3</span>, <span class="va">b11.4</span><span class="op">)</span>
<span class="co">#&gt;       elpd_diff se_diff</span>
<span class="co">#&gt; b11.4   0.0       0.0  </span>
<span class="co">#&gt; b11.3 -75.3       9.2  </span>
<span class="co">#&gt; b11.2 -75.6       9.3  </span>
<span class="co">#&gt; b11.1 -78.0       9.5</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>11H2.</strong> The data contained in <code><a href="http://www.stats.ox.ac.uk/pub/MASS4/">library(MASS);data(eagles)</a></code> are records of salmon pirating attempts by Bald Eagles in Washington State. See <code>?eagles</code> for details. While one eagle feeds, sometime another will swoop in and try to steal the salmon from it. Call the feeding eagle the “victim” and the thief the “pirate.” Use the available data to build a binomial GLM of successful pirating attempts.</p>
</blockquote>
<blockquote>
<ol style="list-style-type: lower-alpha">
<li>Consider the following model:
<span class="math display">\[
\begin{align}
y_i &amp;\sim \text{Binomial}(n_i,p_i) \\
\text{logit}(p_i) &amp;= \alpha + \beta_PP_i + \beta_VV_i + \beta_AA_i \\
\alpha &amp;\sim \text{Normal}(0, 1.5) \\
\beta_P,\beta_V,\beta_A &amp;\sim \text{Normal}(0, 0.5)
\end{align}
\]</span>
</li>
</ol>
</blockquote>
<blockquote>
<p>where <span class="math inline">\(y\)</span> is the number of successful attempts, <span class="math inline">\(n\)</span> is the total number of attempts, <span class="math inline">\(P\)</span> is a dummy variable indicating whether or not the pirate had large body size, <span class="math inline">\(V\)</span> is a dummy variable indicating whether or not the victim had large body size, and finally <span class="math inline">\(A\)</span> is a dummy variable indicating whether or not the pirate was an adult. Fit the model above to the <code>eagles</code> data, using both <code>quap</code> and <code>ulam</code>. Is the quadratic approximation okay?</p>
</blockquote>
</div>
<p>First, the data:</p>
<div class="sourceCode" id="cb261"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">eagles</span>, package <span class="op">=</span> <span class="st">"MASS"</span><span class="op">)</span>

<span class="va">eagle_dat</span> <span class="op">&lt;-</span> <span class="va">eagles</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pirateL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">P</span> <span class="op">==</span> <span class="st">"L"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
         victimL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">V</span> <span class="op">==</span> <span class="st">"L"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
         pirateA <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">A</span> <span class="op">==</span> <span class="st">"A"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Now two models, the first with <code><a href="https://rdrr.io/pkg/rethinking/man/quap.html">quap()</a></code> and the second using {brms}. We can compare the parameter estimates using <code><a href="https://rdrr.io/pkg/rethinking/man/precis.html">precis()</a></code> for the QUAP model and <code><a href="https://rdrr.io/pkg/brms/man/fixef.brmsfit.html">fixef()</a></code> for the {brms} model. Overall, the estimates are very similar. However, it should be noted that all of the {brms} parameters are slightly more extreme than the QUAP versions. This is because the MCMC posteriors do not have to be strictly Gaussian, and therefore can have a little more skew. If we used wider priors, the difference would be even more evident.</p>
<div class="sourceCode" id="cb262"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eagle_quap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/quap.html">quap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">alist</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">dbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">p</span><span class="op">)</span>,
                         <span class="fu">logit</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">a</span> <span class="op">+</span> <span class="va">bP</span> <span class="op">*</span> <span class="va">pirateL</span> <span class="op">+</span> <span class="va">bV</span> <span class="op">*</span> <span class="va">victimL</span> <span class="op">+</span> <span class="va">bA</span> <span class="op">*</span> <span class="va">pirateA</span>,
                         <span class="va">a</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>,
                         <span class="va">bP</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,
                         <span class="va">bV</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,
                         <span class="va">bA</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
                   data <span class="op">=</span> <span class="va">eagle_dat</span><span class="op">)</span>

<span class="va">eagle_brms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">|</span> <span class="fu">trials</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">pirateL</span> <span class="op">+</span> <span class="va">victimL</span> <span class="op">+</span> <span class="va">pirateA</span>,
                  data <span class="op">=</span> <span class="va">eagle_dat</span>, family <span class="op">=</span> <span class="va">binomial</span>,
                  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
                  iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                  file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11h2-1"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/precis.html">precis</a></span><span class="op">(</span><span class="va">eagle_quap</span><span class="op">)</span>
<span class="co">#&gt;      mean    sd   5.5% 94.5%</span>
<span class="co">#&gt; a   0.351 0.479 -0.415  1.12</span>
<span class="co">#&gt; bP  2.581 0.437  1.882  3.28</span>
<span class="co">#&gt; bV -2.711 0.470 -3.463 -1.96</span>
<span class="co">#&gt; bA  0.892 0.407  0.242  1.54</span>

<span class="fu"><a href="https://rdrr.io/pkg/brms/man/fixef.brmsfit.html">fixef</a></span><span class="op">(</span><span class="va">eagle_brms</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.055</span>, <span class="fl">.945</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;           Estimate Est.Error   Q5.5 Q94.5</span>
<span class="co">#&gt; Intercept    0.370     0.511 -0.435  1.20</span>
<span class="co">#&gt; pirateL      2.637     0.446  1.945  3.37</span>
<span class="co">#&gt; victimL     -2.790     0.484 -3.588 -2.04</span>
<span class="co">#&gt; pirateA      0.901     0.419  0.239  1.57</span></code></pre></div>
<div class="question">
<blockquote>
<ol start="2" style="list-style-type: lower-alpha">
<li>Now interpret the estimates. If the quadratic approximation turned out okay, then it’s okay to use the <code>quap</code> estimates. Otherwise stick to <code>ulam</code> estimates. Then plot the posterior predictions. Compute and display both (1) the predicted <strong>probability</strong> of success and its 89% interval for each row (<em>i</em>) in the data, as well as (2) the predicted success <strong>count</strong> and its 89% interval. What different information does each type of posterior prediction provide?</li>
</ol>
</blockquote>
</div>
<p>We’ll use the MCMC estimates from {brms}. Starting with the intercept, this is the log-odds of a successful attempt when all of the predictors are 0 (i.e., a small non-adult pirate and small victim). Just under 60% of these attempts are expected to succeed.</p>
<div class="sourceCode" id="cb263"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">eagle_brms</span>, variable <span class="op">=</span> <span class="st">"b_Intercept"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/inv_logit_scaled.html">inv_logit_scaled</a></span><span class="op">(</span><span class="va">b_Intercept</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">mean_hdi</a></span><span class="op">(</span><span class="va">prob</span>, .width <span class="op">=</span> <span class="fl">0.89</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 × 6</span>
<span class="co">#&gt;    prob .lower .upper .width .point .interval</span>
<span class="co">#&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span>
<span class="co">#&gt; 1 0.586  0.406  0.779   0.89 mean   hdi</span></code></pre></div>
<p>The slopes are hard to interpret in isolation, because the impact of one variable depends on the other variables. The easiest way to interpret is to make the plot of the probabilities and expected counts. For each case type, we can see the probability of a successful attempt, and the number of expected counts. The difference is that the probabilities do not account for sample size. For example we can see that the SIS case (small immature pirate, small victim) has a relatively high expected probability of a successful attempt. However, because we see so few of those cases, the expected number of successful attempts is still very low. If you looked only at the probabilities, you might expect a lot of these cases. On the other hand, if you looked only at the expected counts, you might think that the probability of success is very low. They two outputs provide complementary information.</p>
<div class="sourceCode" id="cb264"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eagle_dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_linpred_draws</a></span><span class="op">(</span><span class="va">eagle_brms</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/inv_logit_scaled.html">inv_logit_scaled</a></span><span class="op">(</span><span class="va">.linpred</span><span class="op">)</span>,
         label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">P</span>, <span class="va">A</span>, <span class="va">V</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">label</span>, y <span class="op">=</span> <span class="va">prob</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_pointinterval.html">stat_pointinterval</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"Posterior"</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.89</span>, size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">eagle_dat</span>, size <span class="op">=</span> <span class="fl">2</span>,
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">P</span>, <span class="va">A</span>, <span class="va">V</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">y</span> <span class="op">/</span> <span class="va">n</span>, color <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Posterior"</span> <span class="op">=</span> <span class="st">"#009FB7"</span>,
                                <span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"#272727"</span><span class="op">)</span>,
                     name <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Case"</span>, y <span class="op">=</span> <span class="st">"Probability"</span><span class="op">)</span>

<span class="va">eagle_dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">eagle_brms</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">P</span>, <span class="va">A</span>, <span class="va">V</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">label</span>, y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_pointinterval.html">stat_pointinterval</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"Posterior"</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.89</span>, size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">eagle_dat</span>, size <span class="op">=</span> <span class="fl">2</span>,
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">P</span>, <span class="va">A</span>, <span class="va">V</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Posterior"</span> <span class="op">=</span> <span class="st">"#009FB7"</span>,
                                <span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"#272727"</span><span class="op">)</span>,
                     name <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Case"</span>, y <span class="op">=</span> <span class="st">"Successes"</span><span class="op">)</span></code></pre></div>
<p><img src="05-glm_files/figure-html/11h2-4-1.png" width="80%" style="display: block; margin: auto;"><img src="05-glm_files/figure-html/11h2-4-2.png" width="80%" style="display: block; margin: auto;"></p>
<div class="question">
<blockquote>
<ol start="3" style="list-style-type: lower-alpha">
<li>Now try to improve the model. Consider an interaction between the pirate’s size and age (immature or adult). Compare this model to the previous one, using WAIC. Interpret.</li>
</ol>
</blockquote>
</div>
<p>First we’ll fit the model with an interaction and add WAIC information to this model and our previous {brms} model. When we add the WAIC information, we get some warnings about <code>p_waic</code> values greater than 0.4. When we compare the WAIC values, we see that there is minimal difference, and the non-interaction model is preferred. Thus, we conclude that the interaction term does not have a large impact on the predictive power of the model.</p>
<div class="sourceCode" id="cb265"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eagle_brms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">|</span> <span class="fu">trials</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">pirateL</span> <span class="op">*</span> <span class="va">pirateA</span> <span class="op">+</span> <span class="va">victimL</span>,
                   data <span class="op">=</span> <span class="va">eagle_dat</span>, family <span class="op">=</span> <span class="va">binomial</span>,
                   prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                             <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
                   iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                   file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11h2-2"</span><span class="op">)</span><span class="op">)</span>

<span class="va">eagle_brms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">eagle_brms</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>
<span class="va">eagle_brms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">eagle_brms2</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">eagle_brms</span>, <span class="va">eagle_brms2</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>
<span class="co">#&gt;             elpd_diff se_diff</span>
<span class="co">#&gt; eagle_brms   0.0       0.0   </span>
<span class="co">#&gt; eagle_brms2 -0.2       0.3</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>11H3.</strong> The data contained in <code>data(salamanders)</code> are counts of salamanders (<em>Plethodon elongatus</em>) from 47 different 49-m<sup>2</sup> plots in northern California. The column <code>SALAMAN</code> is the count in each plot, and the columns <code>PCTCOVER</code> and <code>FORESTAGE</code> are percent of ground cover and age of trees in the plot, respectively. You will model <code>SALAMAN</code> as a Poisson variable.</p>
</blockquote>
<blockquote>
<ol style="list-style-type: lower-alpha">
<li>Model the relationship between density and percent cover, using a log-link (same as the example in the book and lecture). Use weakly informative priors of your choosing. Check the quadratic approximation again, by comparing <code>quap</code> to <code>ulam</code>. Then plot the expected counts and their 89% interval against percent cover. In which ways does the model do a good job? A bad job?</li>
</ol>
</blockquote>
</div>
<p>We’ll start by loading the data and standardizing the predictor variables. Then we can fit both the QUAP and MCMC models. Once again, we see some noticeable differences between the posteriors from the two estimation methods. So moving forward, we’ll use the MCMC model.</p>
<div class="sourceCode" id="cb266"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"salamanders"</span><span class="op">)</span>

<span class="va">salamander_dat</span> <span class="op">&lt;-</span> <span class="va">salamanders</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cov <span class="op">=</span> <span class="fu">standardize</span><span class="op">(</span><span class="va">PCTCOVER</span><span class="op">)</span>,
         age <span class="op">=</span> <span class="fu">standardize</span><span class="op">(</span><span class="va">FORESTAGE</span><span class="op">)</span><span class="op">)</span>

<span class="va">sal_quap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/quap.html">quap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">alist</a></span><span class="op">(</span><span class="va">SALAMAN</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">dpois</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">a</span> <span class="op">+</span> <span class="va">bC</span> <span class="op">*</span> <span class="va">cov</span>,
                       <span class="va">a</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,
                       <span class="va">bC</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,
                 data <span class="op">=</span> <span class="va">salamander_dat</span><span class="op">)</span>

<span class="va">sal_brms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">SALAMAN</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">cov</span>, data <span class="op">=</span> <span class="va">salamander_dat</span>, family <span class="op">=</span> <span class="va">poisson</span>,
                prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
                iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11h3-1"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/precis.html">precis</a></span><span class="op">(</span><span class="va">sal_quap</span><span class="op">)</span>
<span class="co">#&gt;     mean    sd  5.5% 94.5%</span>
<span class="co">#&gt; a  0.508 0.138 0.287 0.729</span>
<span class="co">#&gt; bC 1.032 0.164 0.769 1.294</span>

<span class="fu"><a href="https://rdrr.io/pkg/brms/man/fixef.brmsfit.html">fixef</a></span><span class="op">(</span><span class="va">sal_brms</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.055</span>, <span class="fl">0.945</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;           Estimate Est.Error  Q5.5 Q94.5</span>
<span class="co">#&gt; Intercept    0.491     0.138 0.262 0.701</span>
<span class="co">#&gt; cov          1.047     0.163 0.793 1.316</span></code></pre></div>
<p>Now let’s visualize the expected counts. It looks like the model does pretty well for low values of ground cover, but at high values, there is much more variance that might be expected.</p>
<div class="sourceCode" id="cb267"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">219</span><span class="op">)</span>

<span class="va">epreds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>cov <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">1.5</span>, by <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">sal_brms</span><span class="op">)</span>

<span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>cov <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">1.5</span>, by <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_predicted_draws</a></span><span class="op">(</span><span class="va">sal_brms</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_lineribbon.html">stat_lineribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">preds</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cov</span>, y <span class="op">=</span> <span class="va">.prediction</span>,
                                    fill <span class="op">=</span> <span class="st">"Prediction (89%)"</span><span class="op">)</span>,
                  .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.89</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_lineribbon.html">stat_lineribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">epreds</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cov</span>, y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span>,
                  .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">salamander_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cov</span>, y <span class="op">=</span> <span class="va">SALAMAN</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#F0F0F0"</span>, <span class="fu">ramp_blue</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.2</span>, length.out <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Prediction (89%)"</span>, <span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Ground cover (standardized)"</span>, y <span class="op">=</span> <span class="st">"Observed Salamanders"</span>,
       fill <span class="op">=</span> <span class="st">"Interval"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-glm_files/figure-html/e11h3-2-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<ol start="2" style="list-style-type: lower-alpha">
<li>Can you improve the model by using the other predictor, <code>FORESTAGE</code>? Try any models you think useful. Can you explain why <code>FORESTAGE</code> helps or does not help with prediction?</li>
</ol>
</blockquote>
</div>
<p>Let’s try adding age as a predictor. When we look at the output, we see that <code>age</code> doesn’t add much of anything to the prediction. This is likely because ground cover is a pipe between forest age and the number of salamanders. That is, older forest have more ground cover, which is what leads to more salamanders.</p>
<div class="sourceCode" id="cb268"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sal_brms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">SALAMAN</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">cov</span> <span class="op">+</span> <span class="va">age</span>, data <span class="op">=</span> <span class="va">salamander_dat</span>, family <span class="op">=</span> <span class="va">poisson</span>,
                prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
                iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11h3-2"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/fit-method-summary.html">summary</a></span><span class="op">(</span><span class="va">sal_brms2</span><span class="op">)</span>
<span class="co">#&gt;  Family: poisson </span>
<span class="co">#&gt;   Links: mu = log </span>
<span class="co">#&gt; Formula: SALAMAN ~ 1 + cov + age </span>
<span class="co">#&gt;    Data: salamander_dat (Number of observations: 47) </span>
<span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 0; thin = 1;</span>
<span class="co">#&gt;          total post-warmup draws = 8000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Population-Level Effects: </span>
<span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; Intercept     0.48      0.14     0.19     0.75 1.00     3562     3680</span>
<span class="co">#&gt; cov           1.04      0.18     0.70     1.40 1.00     3285     3984</span>
<span class="co">#&gt; age           0.02      0.09    -0.17     0.20 1.00     4568     4558</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span>
<span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></code></pre></div>
<p>This is supported by next model. When we include only age, we see that age is a strong predictor of salamanders. It’s only when we stratify by ground cover that forest age loses its predictive power. Thus, it seems that forest age is really just a useful proxy if we don’t have actual ground cover data.</p>
<div class="sourceCode" id="cb269"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sal_brms3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">SALAMAN</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">age</span>, data <span class="op">=</span> <span class="va">salamander_dat</span>, family <span class="op">=</span> <span class="va">poisson</span>,
                prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
                iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11h3-3"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/fit-method-summary.html">summary</a></span><span class="op">(</span><span class="va">sal_brms3</span><span class="op">)</span>
<span class="co">#&gt;  Family: poisson </span>
<span class="co">#&gt;   Links: mu = log </span>
<span class="co">#&gt; Formula: SALAMAN ~ 1 + age </span>
<span class="co">#&gt;    Data: salamander_dat (Number of observations: 47) </span>
<span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 0; thin = 1;</span>
<span class="co">#&gt;          total post-warmup draws = 8000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Population-Level Effects: </span>
<span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; Intercept     0.82      0.10     0.62     1.01 1.00     4513     4838</span>
<span class="co">#&gt; age           0.36      0.08     0.20     0.51 1.00     4560     4866</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span>
<span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>11H4.</strong> The data in <code>data(NWOGrants)</code> are outcomes for scientific funding applications for the Netherlands Organization for Scientific Research (NWO) from 2010–2012 <span class="citation">(see <a href="references.html#ref-vanderlee" role="doc-biblioref">van der Lee &amp; Ellemers, 2015</a>, for data and context)</span>. These data have a very similar structure to the <code>UCBAdmit</code> data discussed in the chapter. I want you to consider a similar question: What are the total and direct causal effects of gender on grant awards? Consider a mediation path (a pipe) through discipline. Draw the corresponding DAG and then use one or more binomial GLMs to answer the question. What is your causal interpretation? If NWO’s goal is to equalize rates of funding between men and women, what type of intervention would be most effective?</p>
</blockquote>
</div>
<p>Let’s start with the DAG. We’ll denote gender as <span class="math inline">\(G\)</span>, discipline as <span class="math inline">\(D\)</span>, and award as <span class="math inline">\(A\)</span>. Our DAG can then be defined as in the figure below. Gender influences both whether or not an award is given, as well as which discipline an individual might go into.</p>
<pre><code>#&gt; 
#&gt; Attaching package: 'ggdag'
#&gt; The following object is masked from 'package:stats':
#&gt; 
#&gt;     filter</code></pre>
<div class="inline-figure"><img src="05-glm_files/figure-html/e11h4-1-1.png" width="40%" style="display: block; margin: auto;"></div>
<p>To estimate the total and direct effects, we need two models. For the total effect, we condition only on gender. For the direct effect, we also condition on discipline.</p>
<div class="sourceCode" id="cb271"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"NWOGrants"</span><span class="op">)</span>

<span class="va">nwo_dat</span> <span class="op">&lt;-</span> <span class="va">NWOGrants</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>gender <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">gender</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"m"</span>, <span class="st">"f"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">b11h4_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">awards</span> <span class="op">|</span> <span class="fu">trials</span><span class="op">(</span><span class="va">applications</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">gender</span>, data <span class="op">=</span> <span class="va">nwo_dat</span>,
                   family <span class="op">=</span> <span class="va">binomial</span>,
                   prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                   iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                   file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11h4-total"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b11h4_direct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">awards</span> <span class="op">|</span> <span class="fu">trials</span><span class="op">(</span><span class="va">applications</span><span class="op">)</span> <span class="op">~</span> <span class="va">g</span> <span class="op">+</span> <span class="va">d</span> <span class="op">+</span> <span class="va">i</span>,
                       <span class="va">g</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">gender</span>,
                       <span class="va">d</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">discipline</span>,
                       <span class="va">i</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">gender</span><span class="op">:</span><span class="va">discipline</span>,
                       nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">nwo_dat</span>, family <span class="op">=</span> <span class="va">binomial</span>,
                    prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">g</span><span class="op">)</span>,
                              <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">d</span><span class="op">)</span>,
                              <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">)</span>,
                    iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                    file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11h4-direct"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Let’s look at the difference between males and females in these different models. When looking at the total effect, we see that males are favored by approximately 3 percentage points.</p>
<div class="sourceCode" id="cb272"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">b11h4_total</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>diff_male <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/inv_logit_scaled.html">inv_logit_scaled</a></span><span class="op">(</span><span class="va">b_genderm</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/inv_logit_scaled.html">inv_logit_scaled</a></span><span class="op">(</span><span class="va">b_genderf</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">diff_male</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_sample_slabinterval.html">stat_halfeye</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"#009FB7"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"&amp;beta;&lt;sub&gt;M&lt;/sub&gt; &amp;minus; &amp;beta;&lt;sub&gt;F&lt;/sub&gt;"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-glm_files/figure-html/e11h4-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>When we condition on discipline, we see a slightly different story. The marginal effect of gender across disciplines shows that in some cases females are advantaged and in other cases disadvantaged.</p>
<div class="sourceCode" id="cb273"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">apps_per_dept</span> <span class="op">&lt;-</span> <span class="va">nwo_dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">discipline</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>applications <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">applications</span><span class="op">)</span><span class="op">)</span>

<span class="co"># simulate as if all applications are from males</span>
<span class="va">male_dat</span> <span class="op">&lt;-</span> <span class="va">apps_per_dept</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>gender <span class="op">=</span> <span class="st">"m"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/uncount.html">uncount</a></span><span class="op">(</span><span class="va">applications</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>applications <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>

<span class="co"># simulate as if all applications are from females</span>
<span class="va">female_dat</span> <span class="op">&lt;-</span> <span class="va">apps_per_dept</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>gender <span class="op">=</span> <span class="st">"f"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/uncount.html">uncount</a></span><span class="op">(</span><span class="va">applications</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>applications <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>

<span class="va">marg_eff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">male_dat</span>, <span class="va">b11h4_direct</span><span class="op">)</span>,
                      <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">female_dat</span>, <span class="va">b11h4_direct</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">"gender"</span>, values_from <span class="op">=</span> <span class="st">".epred"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="va">m</span> <span class="op">-</span> <span class="va">f</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">marg_eff</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">diff</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_sample_slabinterval.html">stat_halfeye</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"#009FB7"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Difference in Awards (Male - Female)"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-glm_files/figure-html/e11h4-4-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>Together this indicates that women are relatively more likely to apply for grants in disciplines with lower award rates. Thus, overall women are awarded grants less often. However, within disciplines, there are advantages and disadvantages that tend to even out, at least in this data set. If we were trying to intervene, I would recommend encouraging women to apply for grants in disciplines for which women have relatively lower application rates, but for which there are higher award rates.</p>
<div class="question">
<blockquote>
<p><strong>11H5.</strong> Suppose that the NWO Grants sample has an unobserved confound that influences both choice of discipline and the probability of an award. One example of such a confound could be the career stage of each applicant. Suppose that in some disciplines, junior scholars apply for most of the grants. In other disciplines, scholars from all career stages compete. As a result, career stage influences discipline as well as the probability of being awarded a grant. Add these influences to your DAG from the previous problem. What happens now when you condition on discipline? Does it provide an un-confounded estimate of the direct path from gender to an award? Why or why not? Justify your answer with the backdoor criterion. If you have trouble thinking this though, try simulating fake data, assuming your DAG is true. Then analyze it using the model from the previous problem. What do you conclude? Is it possible for gender to have a real direct causal influence but for a regression conditioning on both gender and discipline to suggest zero influence?</p>
</blockquote>
</div>
<p>Here’s our new DAG, where <span class="math inline">\(S\)</span> is the unobserved career stage. Now, <span class="math inline">\(D\)</span> is a collider. So if we condition on <span class="math inline">\(D\)</span> to get the direct effect, we open a backdoor through <span class="math inline">\(S\)</span> to <span class="math inline">\(A\)</span>. This means it’s not possible to accurately estimate the direct effect of gender on award decisions, using this DAG.</p>
<div class="inline-figure"><img src="05-glm_files/figure-html/e11h5-1-1.png" width="40%" style="display: block; margin: auto;"></div>
<p>We can run a quick simulation to demonstrate this. We’ll generate a data set from this new DAG and estimate the direct effect model from the previous question.</p>
<div class="sourceCode" id="cb274"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
<span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/rbernoulli.html">rbernoulli</a></span><span class="op">(</span><span class="va">n</span>, p <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/rbernoulli.html">rbernoulli</a></span><span class="op">(</span><span class="va">n</span>, p <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/rbernoulli.html">rbernoulli</a></span><span class="op">(</span><span class="va">n</span>, p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/inv_logit_scaled.html">inv_logit_scaled</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">g</span> <span class="op">-</span> <span class="va">s</span><span class="op">)</span><span class="op">)</span>
<span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/rbernoulli.html">rbernoulli</a></span><span class="op">(</span><span class="va">n</span>, p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/inv_logit_scaled.html">inv_logit_scaled</a></span><span class="op">(</span><span class="fl">0</span> <span class="op">*</span> <span class="va">g</span> <span class="op">+</span> <span class="va">d</span> <span class="op">+</span> <span class="va">s</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="va">g</span>, <span class="va">d</span>, <span class="va">a</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">as.integer</span><span class="op">)</span>,
         <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">as.factor</span><span class="op">)</span><span class="op">)</span>

<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">a</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">d</span> <span class="op">+</span> <span class="va">g</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="va">bernoulli</span>,
           prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
           iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>,
           file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11h5-sim"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">mod</span>, variable <span class="op">=</span> <span class="st">"b_g1"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">mean_hdi</a></span><span class="op">(</span><span class="va">b_g1</span>, .width <span class="op">=</span> <span class="fl">0.89</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 × 6</span>
<span class="co">#&gt;    b_g1  .lower .upper .width .point .interval</span>
<span class="co">#&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    </span>
<span class="co">#&gt; 1 0.233 -0.0116  0.468   0.89 mean   hdi</span></code></pre></div>
<p>Here, even though we simulated 0 effect of gender on award status, there is a consistently positive relationship estimated by the model. This is because the collider has opened a non-causal path through career stage, inducing a relationship where in reality none exists. This illustrates that it’s not possible to estimate a non-confounded estimate of the direct effect of gender, given just data on gender, discipline, and award status.</p>
<div class="question">
<blockquote>
<p><strong>11H6.</strong> The data in <code>data(Primates301)</code> are 301 primate species and associated measures. In this problem, you will consider how brain size is associated with social learning. There are three parts.</p>
</blockquote>
<blockquote>
<ol style="list-style-type: lower-alpha">
<li>Model the number of observations of <code>social_learning</code> for each species as a function of the log brain size. Use a Poisson distribution for the <code>social_learning</code> outcome variable. Interpret the resulting posterior.</li>
</ol>
</blockquote>
</div>
<p>As always, we’ll start by prepping the data. In our first model, we are predicting social learning with the standardized log brain size.</p>
<div class="sourceCode" id="cb275"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"Primates301"</span><span class="op">)</span>

<span class="va">primate_dat</span> <span class="op">&lt;-</span> <span class="va">Primates301</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">social_learning</span>, <span class="va">genus</span>, <span class="va">species</span>, <span class="va">brain</span>, <span class="va">research_effort</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>log_brain <span class="op">=</span> <span class="fu">standardize</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">brain</span><span class="op">)</span><span class="op">)</span>,
         log_effort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">research_effort</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rowid_to_column</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">b11h6a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">social_learning</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">log_brain</span>, data <span class="op">=</span> <span class="va">primate_dat</span>,
              family <span class="op">=</span> <span class="va">poisson</span>,
              prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
              iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
              file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11h6a"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/fit-method-summary.html">summary</a></span><span class="op">(</span><span class="va">b11h6a</span><span class="op">)</span>
<span class="co">#&gt;  Family: poisson </span>
<span class="co">#&gt;   Links: mu = log </span>
<span class="co">#&gt; Formula: social_learning ~ 1 + log_brain </span>
<span class="co">#&gt;    Data: primate_dat (Number of observations: 150) </span>
<span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 0; thin = 1;</span>
<span class="co">#&gt;          total post-warmup draws = 8000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Population-Level Effects: </span>
<span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; Intercept    -1.18      0.12    -1.41    -0.95 1.00     1622     2007</span>
<span class="co">#&gt; log_brain     2.76      0.07     2.61     2.90 1.00     1604     2001</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span>
<span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></code></pre></div>
<p>The summary indicates a strong positive relationship between social learning behaviors and brain size. We can check how good the predictions are by looking at the posterior predictive checks. Overall it doesn’t look to bad, but there are definitely some places where we miss pretty badly.</p>
<div class="sourceCode" id="cb276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">preds</span> <span class="op">&lt;-</span> <span class="va">primate_dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_predicted_draws</a></span><span class="op">(</span><span class="va">b11h6a</span><span class="op">)</span>

<span class="va">preds</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">rowid</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">rowid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_pointinterval.html">stat_pointinterval</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.prediction</span>, color <span class="op">=</span> <span class="st">"Posterior"</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.89</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">primate_dat</span>, <span class="va">rowid</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span>,
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">social_learning</span>, color <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Posterior"</span> <span class="op">=</span> <span class="st">"#272727"</span>, <span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"#009FB7"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expand_limits.html">expand_limits</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Case"</span>, y <span class="op">=</span> <span class="st">"Social Learning"</span>, color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>

<span class="va">preds</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">rowid</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">51</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">rowid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_pointinterval.html">stat_pointinterval</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.prediction</span>, color <span class="op">=</span> <span class="st">"Posterior"</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.89</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">primate_dat</span>, <span class="va">rowid</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">51</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span>,
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">social_learning</span>, color <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Posterior"</span> <span class="op">=</span> <span class="st">"#272727"</span>, <span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"#009FB7"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expand_limits.html">expand_limits</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Case"</span>, y <span class="op">=</span> <span class="st">"Social Learning"</span>, color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>

<span class="va">preds</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">rowid</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">101</span><span class="op">:</span><span class="fl">150</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">rowid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_pointinterval.html">stat_pointinterval</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.prediction</span>, color <span class="op">=</span> <span class="st">"Posterior"</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.89</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">primate_dat</span>, <span class="va">rowid</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">101</span><span class="op">:</span><span class="fl">150</span><span class="op">)</span>,
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">social_learning</span>, color <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Posterior"</span> <span class="op">=</span> <span class="st">"#272727"</span>, <span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"#009FB7"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expand_limits.html">expand_limits</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Case"</span>, y <span class="op">=</span> <span class="st">"Social Learning"</span>, color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<p><img src="05-glm_files/figure-html/e11h6-2-1.png" width="80%" style="display: block; margin: auto;"><img src="05-glm_files/figure-html/e11h6-2-2.png" width="80%" style="display: block; margin: auto;"><img src="05-glm_files/figure-html/e11h6-2-3.png" width="80%" style="display: block; margin: auto;"></p>
<div class="question">
<blockquote>
<ol start="2" style="list-style-type: lower-alpha">
<li>Some species are studied much more than others. So the number of reported instances of <code>social_learning</code> could be a product of research effort. Use the <code>research_effort</code> variable, specifically its logarithm, as an additional predictor variable. Interpret the coefficient for log <code>research_effort</code>. How does this model differ from the previous one?</li>
</ol>
</blockquote>
</div>
<p>Let’s add research effort to the model. We now see a slightly weaker relationship between brain size and social learning.</p>
<div class="sourceCode" id="cb277"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b11h6b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">social_learning</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">log_brain</span> <span class="op">+</span> <span class="va">log_effort</span>, data <span class="op">=</span> <span class="va">primate_dat</span>,
              family <span class="op">=</span> <span class="va">poisson</span>,
              prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
              iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
              file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp11"</span>, <span class="st">"b11h6b"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/fit-method-summary.html">summary</a></span><span class="op">(</span><span class="va">b11h6b</span><span class="op">)</span>
<span class="co">#&gt;  Family: poisson </span>
<span class="co">#&gt;   Links: mu = log </span>
<span class="co">#&gt; Formula: social_learning ~ 1 + log_brain + log_effort </span>
<span class="co">#&gt;    Data: primate_dat (Number of observations: 150) </span>
<span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 0; thin = 1;</span>
<span class="co">#&gt;          total post-warmup draws = 8000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Population-Level Effects: </span>
<span class="co">#&gt;            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; Intercept     -6.53      0.33    -7.19    -5.89 1.00     2480     3093</span>
<span class="co">#&gt; log_brain      0.39      0.08     0.23     0.55 1.00     3010     3328</span>
<span class="co">#&gt; log_effort     1.64      0.07     1.51     1.78 1.00     2450     3089</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span>
<span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></code></pre></div>
<p>Where does this model perform better or worse than prior model? Let’s look at the pointwise PSIS-LOO. Points on the right of the plot are those where the second model including research effort provides better predictions. Note that for the most part, these are those with the highest research effort.</p>
<div class="sourceCode" id="cb278"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b11h6a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b11h6a</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="va">b11h6b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b11h6b</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">220</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/yutannihilation/gghighlight/">gghighlight</a></span><span class="op">)</span>

<span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span>
  <span class="va">primate_dat</span>,
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">b11h6a</span><span class="op">$</span><span class="va">criteria</span><span class="op">$</span><span class="va">loo</span><span class="op">$</span><span class="va">pointwise</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>loo1 <span class="op">=</span> <span class="va">elpd_loo</span><span class="op">)</span>,
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">b11h6b</span><span class="op">$</span><span class="va">criteria</span><span class="op">$</span><span class="va">loo</span><span class="op">$</span><span class="va">pointwise</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>loo2 <span class="op">=</span> <span class="va">elpd_loo</span><span class="op">)</span>
<span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="va">loo2</span> <span class="op">-</span> <span class="va">loo1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">diff</span>, y <span class="op">=</span> <span class="va">log_effort</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/gghighlight.html">gghighlight</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, <span class="va">diff</span> <span class="op">&gt;</span> <span class="fl">15</span>, label_key <span class="op">=</span> <span class="va">genus</span>, max_highlight <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"LOO&lt;sub&gt;2&lt;/sub&gt; - LOO&lt;sub&gt;1&lt;/sub&gt;"</span>, y <span class="op">=</span> <span class="st">"Research Effort (log)"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-glm_files/figure-html/e11h6-4-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<ol start="3" style="list-style-type: lower-alpha">
<li>Draw a DAG to represent how you think the variables <code>social_learning</code>, <code>brain</code>, and <code>research_effort</code> interact. Justify the DAG with the measured associations in the two models above (and any other models you used).</li>
</ol>
</blockquote>
</div>
<p>Here is the DAG I would predict based on the previous models, where <span class="math inline">\(B\)</span> is brain size, <span class="math inline">\(E\)</span> is research effort, and <span class="math inline">\(S\)</span> is social learning behaviors. Based on this DAG, brain size influences both research effort and social learning behaviors. Finally, although research effort doesn’t actually influence social learning behaviors, it does influence the social learning variable, because if there is no effort, we won’t observe anything (i.e., false 0s).</p>
<div class="inline-figure"><img src="05-glm_files/figure-html/e11h6-5-1.png" width="40%" style="display: block; margin: auto;"></div>
<p>This is consistent with our models. When we added research effort to the model, the effect of brain size decreased, which is consistent with effort being a pipe between brain size and social learning behaviors. Additionally, if scientists tend to study those primates with large brains, then that could lead to a exaggerated effect of brain size on social learning behaviors, which was observed in the first model.</p>
</div>
</div>
<div id="homework-4" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Homework<a class="anchor" aria-label="anchor" href="#homework-4"><i class="fas fa-link"></i></a>
</h2>
<div class="question">
<blockquote>
<p><strong>1.</strong> The data in <code>data(NWOGrants)</code> are outcomes for scientific funding applications for the Netherlands Organization for Scientific Research (NWO) from 2010–2012 <span class="citation">(see <a href="references.html#ref-vanderlee" role="doc-biblioref">van der Lee &amp; Ellemers, 2015</a>)</span>. These data have a very similar structure to the UCBAdmit data discussed in Chapter 11. Draw a DAG for this sample and then use one or more binomial GLMs to estimate the TOTAL causal effect of gender on grant awards.</p>
</blockquote>
</div>
<p>First, let’s take a look at the data. As the question identified, this data is nearly identical to the <code>UCBAdmit</code> data, with the exception that department has been replaced with discipline.</p>
<div class="sourceCode" id="cb279"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"NWOGrants"</span><span class="op">)</span>

<span class="va">nwo_dat</span> <span class="op">&lt;-</span> <span class="va">NWOGrants</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>gender <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">gender</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"m"</span>, <span class="st">"f"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">nwo_dat</span>
<span class="co">#&gt;             discipline gender applications awards</span>
<span class="co">#&gt; 1    Chemical sciences      m           83     22</span>
<span class="co">#&gt; 2    Chemical sciences      f           39     10</span>
<span class="co">#&gt; 3    Physical sciences      m          135     26</span>
<span class="co">#&gt; 4    Physical sciences      f           39      9</span>
<span class="co">#&gt; 5              Physics      m           67     18</span>
<span class="co">#&gt; 6              Physics      f            9      2</span>
<span class="co">#&gt; 7           Humanities      m          230     33</span>
<span class="co">#&gt; 8           Humanities      f          166     32</span>
<span class="co">#&gt; 9   Technical sciences      m          189     30</span>
<span class="co">#&gt; 10  Technical sciences      f           62     13</span>
<span class="co">#&gt; 11   Interdisciplinary      m          105     12</span>
<span class="co">#&gt; 12   Interdisciplinary      f           78     17</span>
<span class="co">#&gt; 13 Earth/life sciences      m          156     38</span>
<span class="co">#&gt; 14 Earth/life sciences      f          126     18</span>
<span class="co">#&gt; 15     Social sciences      m          425     65</span>
<span class="co">#&gt; 16     Social sciences      f          409     47</span>
<span class="co">#&gt; 17    Medical sciences      m          245     46</span>
<span class="co">#&gt; 18    Medical sciences      f          260     29</span></code></pre></div>
<p>We’ll denote gender as <span class="math inline">\(G\)</span>, discipline as <span class="math inline">\(D\)</span>, and award as <span class="math inline">\(A\)</span>. Our DAG can then be defined as in the figure below. Gender influences both whether or not an award is given, as well as which discipline an individual might go into.</p>
<div class="inline-figure"><img src="05-glm_files/figure-html/w5h1-2-1.png" width="40%" style="display: block; margin: auto;"></div>
<p>For the total effect, we don’t need to condition on any other variables. We can confirm this with {dagitty}.</p>
<div class="sourceCode" id="cb280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.dagitty.net">dagitty</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/dagitty/man/adjustmentSets.html">adjustmentSets</a></span><span class="op">(</span><span class="va">nwo_dag</span>, exposure <span class="op">=</span> <span class="st">"G"</span>, outcome <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span>
<span class="co">#&gt;  {}</span></code></pre></div>
<p>We can now fit our model.</p>
<div class="sourceCode" id="cb281"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">w5h1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">awards</span> <span class="op">|</span> <span class="fu">trials</span><span class="op">(</span><span class="va">applications</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">gender</span>, data <span class="op">=</span> <span class="va">nwo_dat</span>,
            family <span class="op">=</span> <span class="va">binomial</span>,
            prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
            iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
            file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw5"</span>, <span class="st">"w5h1"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/fit-method-summary.html">summary</a></span><span class="op">(</span><span class="va">w5h1</span><span class="op">)</span>
<span class="co">#&gt;  Family: binomial </span>
<span class="co">#&gt;   Links: mu = logit </span>
<span class="co">#&gt; Formula: awards | trials(applications) ~ 0 + gender </span>
<span class="co">#&gt;    Data: nwo_dat (Number of observations: 18) </span>
<span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 0; thin = 1;</span>
<span class="co">#&gt;          total post-warmup draws = 8000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Population-Level Effects: </span>
<span class="co">#&gt;         Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; genderm    -1.53      0.06    -1.66    -1.41 1.00     7943     5028</span>
<span class="co">#&gt; genderf    -1.74      0.08    -1.90    -1.58 1.00     7710     5042</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span>
<span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></code></pre></div>
<p>From the summary, it appears that females are less likely to get be awarded grants, but we need to compute the contrast to know for certain. The plot below shows the contrast for males compared to females. On average, males are favored by about 3 percentage points. The contrast is fairly reliably above 0, indicating some bias in favor of males.</p>
<div class="sourceCode" id="cb282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">w5h1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>diff_male <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/inv_logit_scaled.html">inv_logit_scaled</a></span><span class="op">(</span><span class="va">b_genderm</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/inv_logit_scaled.html">inv_logit_scaled</a></span><span class="op">(</span><span class="va">b_genderf</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">diff_male</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_sample_slabinterval.html">stat_halfeye</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"#009FB7"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"&amp;beta;&lt;sub&gt;M&lt;/sub&gt; &amp;minus; &amp;beta;&lt;sub&gt;F&lt;/sub&gt;"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-glm_files/figure-html/w5h1-5-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>2.</strong> Now estimate the DIRECT causal effect of gender on grant awards. Compute the average direct causal effect of gender, weighting each discipline in proportion to the number of applications in the sample. Refer to the marginal effect example in Lecture 9 for help.</p>
</blockquote>
</div>
<p>For the direct effect we need to condition on the discipline.</p>
<div class="sourceCode" id="cb283"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/dagitty/man/adjustmentSets.html">adjustmentSets</a></span><span class="op">(</span><span class="va">nwo_dag</span>, exposure <span class="op">=</span> <span class="st">"G"</span>, outcome <span class="op">=</span> <span class="st">"A"</span>, effect <span class="op">=</span> <span class="st">"direct"</span><span class="op">)</span>
<span class="co">#&gt; { D }</span></code></pre></div>
<p>Let’s fit the model, stratifying by both gender and discipline.</p>
<div class="sourceCode" id="cb284"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">w5h2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">awards</span> <span class="op">|</span> <span class="fu">trials</span><span class="op">(</span><span class="va">applications</span><span class="op">)</span> <span class="op">~</span> <span class="va">g</span> <span class="op">+</span> <span class="va">d</span> <span class="op">+</span> <span class="va">i</span>,
               <span class="va">g</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">gender</span>,
               <span class="va">d</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">discipline</span>,
               <span class="va">i</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">gender</span><span class="op">:</span><span class="va">discipline</span>,
               nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">nwo_dat</span>, family <span class="op">=</span> <span class="va">binomial</span>,
            prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">g</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">d</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">)</span>,
            iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
            file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw5"</span>, <span class="st">"w5h2"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/fit-method-summary.html">summary</a></span><span class="op">(</span><span class="va">w5h2</span><span class="op">)</span>
<span class="co">#&gt;  Family: binomial </span>
<span class="co">#&gt;   Links: mu = logit </span>
<span class="co">#&gt; Formula: awards | trials(applications) ~ g + d + i </span>
<span class="co">#&gt;          g ~ 0 + gender</span>
<span class="co">#&gt;          d ~ 0 + discipline</span>
<span class="co">#&gt;          i ~ 0 + gender:discipline</span>
<span class="co">#&gt;    Data: nwo_dat (Number of observations: 18) </span>
<span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 0; thin = 1;</span>
<span class="co">#&gt;          total post-warmup draws = 8000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Population-Level Effects: </span>
<span class="co">#&gt;                                        Estimate Est.Error l-95% CI u-95% CI</span>
<span class="co">#&gt; g_genderm                                 -1.10      0.64    -2.33     0.12</span>
<span class="co">#&gt; g_genderf                                 -1.13      0.63    -2.38     0.11</span>
<span class="co">#&gt; d_disciplineChemicalsciences               0.03      0.95    -1.84     1.91</span>
<span class="co">#&gt; d_disciplineEarthDlifesciences            -0.24      0.94    -2.13     1.55</span>
<span class="co">#&gt; d_disciplineHumanities                    -0.34      0.93    -2.20     1.47</span>
<span class="co">#&gt; d_disciplineInterdisciplinary             -0.39      0.96    -2.23     1.49</span>
<span class="co">#&gt; d_disciplineMedicalsciences               -0.45      0.94    -2.28     1.38</span>
<span class="co">#&gt; d_disciplinePhysicalsciences              -0.16      0.94    -2.02     1.66</span>
<span class="co">#&gt; d_disciplinePhysics                       -0.05      0.97    -1.95     1.90</span>
<span class="co">#&gt; d_disciplineSocialsciences                -0.51      0.95    -2.37     1.36</span>
<span class="co">#&gt; d_disciplineTechnicalsciences             -0.28      0.94    -2.09     1.63</span>
<span class="co">#&gt; i_genderm:disciplineChemicalsciences       0.03      0.96    -1.84     1.91</span>
<span class="co">#&gt; i_genderf:disciplineChemicalsciences      -0.01      0.97    -1.90     1.88</span>
<span class="co">#&gt; i_genderm:disciplineEarthDlifesciences     0.19      0.96    -1.64     2.10</span>
<span class="co">#&gt; i_genderf:disciplineEarthDlifesciences    -0.43      0.96    -2.27     1.48</span>
<span class="co">#&gt; i_genderm:disciplineHumanities            -0.36      0.96    -2.21     1.49</span>
<span class="co">#&gt; i_genderf:disciplineHumanities             0.02      0.96    -1.89     1.90</span>
<span class="co">#&gt; i_genderm:disciplineInterdisciplinary     -0.57      0.97    -2.47     1.31</span>
<span class="co">#&gt; i_genderf:disciplineInterdisciplinary      0.21      0.99    -1.72     2.19</span>
<span class="co">#&gt; i_genderm:disciplineMedicalsciences        0.07      0.97    -1.84     1.98</span>
<span class="co">#&gt; i_genderf:disciplineMedicalsciences       -0.51      0.97    -2.39     1.39</span>
<span class="co">#&gt; i_genderm:disciplinePhysicalsciences      -0.18      0.94    -2.05     1.67</span>
<span class="co">#&gt; i_genderf:disciplinePhysicalsciences       0.05      0.98    -1.85     1.91</span>
<span class="co">#&gt; i_genderm:disciplinePhysics                0.13      1.00    -1.83     2.07</span>
<span class="co">#&gt; i_genderf:disciplinePhysics               -0.17      1.06    -2.24     1.92</span>
<span class="co">#&gt; i_genderm:disciplineSocialsciences        -0.11      0.96    -1.98     1.80</span>
<span class="co">#&gt; i_genderf:disciplineSocialsciences        -0.40      0.97    -2.33     1.49</span>
<span class="co">#&gt; i_genderm:disciplineTechnicalsciences     -0.30      0.96    -2.19     1.63</span>
<span class="co">#&gt; i_genderf:disciplineTechnicalsciences      0.05      0.96    -1.84     1.91</span>
<span class="co">#&gt;                                        Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; g_genderm                              1.00     7420     5345</span>
<span class="co">#&gt; g_genderf                              1.00     7452     5142</span>
<span class="co">#&gt; d_disciplineChemicalsciences           1.00     8877     5846</span>
<span class="co">#&gt; d_disciplineEarthDlifesciences         1.00     8520     5222</span>
<span class="co">#&gt; d_disciplineHumanities                 1.00     8616     5858</span>
<span class="co">#&gt; d_disciplineInterdisciplinary          1.00     9211     5567</span>
<span class="co">#&gt; d_disciplineMedicalsciences            1.00     8894     5890</span>
<span class="co">#&gt; d_disciplinePhysicalsciences           1.00     7923     5277</span>
<span class="co">#&gt; d_disciplinePhysics                    1.00     9096     6519</span>
<span class="co">#&gt; d_disciplineSocialsciences             1.00     8734     6004</span>
<span class="co">#&gt; d_disciplineTechnicalsciences          1.00     8373     5770</span>
<span class="co">#&gt; i_genderm:disciplineChemicalsciences   1.00     8939     5983</span>
<span class="co">#&gt; i_genderf:disciplineChemicalsciences   1.00     8895     6237</span>
<span class="co">#&gt; i_genderm:disciplineEarthDlifesciences 1.00     9695     5729</span>
<span class="co">#&gt; i_genderf:disciplineEarthDlifesciences 1.00     8663     5995</span>
<span class="co">#&gt; i_genderm:disciplineHumanities         1.00     8531     5813</span>
<span class="co">#&gt; i_genderf:disciplineHumanities         1.00     8670     5291</span>
<span class="co">#&gt; i_genderm:disciplineInterdisciplinary  1.00     9355     5558</span>
<span class="co">#&gt; i_genderf:disciplineInterdisciplinary  1.00     9395     5567</span>
<span class="co">#&gt; i_genderm:disciplineMedicalsciences    1.00     7963     5397</span>
<span class="co">#&gt; i_genderf:disciplineMedicalsciences    1.00     9254     6110</span>
<span class="co">#&gt; i_genderm:disciplinePhysicalsciences   1.00     8395     5734</span>
<span class="co">#&gt; i_genderf:disciplinePhysicalsciences   1.00     8613     6035</span>
<span class="co">#&gt; i_genderm:disciplinePhysics            1.00     9136     6291</span>
<span class="co">#&gt; i_genderf:disciplinePhysics            1.00     8993     6508</span>
<span class="co">#&gt; i_genderm:disciplineSocialsciences     1.00     9101     5986</span>
<span class="co">#&gt; i_genderf:disciplineSocialsciences     1.00     8303     5710</span>
<span class="co">#&gt; i_genderm:disciplineTechnicalsciences  1.00     8591     6009</span>
<span class="co">#&gt; i_genderf:disciplineTechnicalsciences  1.00     9055     5815</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span>
<span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></code></pre></div>
<p>Now let’s compute the marginal effect. Overall, there is a slight bias toward males, who are on average about 1.5 percentage points more likely to be awarded a grant. The 89% interval is about −0.12 to 0.12. Thus, overall, the advantages are relatively balanced, and after statistically removing the effect of discipline, there does not appear to be a strong effect of gender on the awarding of grants.</p>
<div class="sourceCode" id="cb285"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">apps_per_dept</span> <span class="op">&lt;-</span> <span class="va">nwo_dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">discipline</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>applications <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">applications</span><span class="op">)</span><span class="op">)</span>

<span class="co"># simulate as if all applications are from males</span>
<span class="va">male_dat</span> <span class="op">&lt;-</span> <span class="va">apps_per_dept</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>gender <span class="op">=</span> <span class="st">"m"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/uncount.html">uncount</a></span><span class="op">(</span><span class="va">applications</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>applications <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>

<span class="co"># simulate as if all applications are from females</span>
<span class="va">female_dat</span> <span class="op">&lt;-</span> <span class="va">apps_per_dept</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>gender <span class="op">=</span> <span class="st">"f"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/uncount.html">uncount</a></span><span class="op">(</span><span class="va">applications</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>applications <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>

<span class="va">marg_eff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">male_dat</span>, <span class="va">w5h2</span><span class="op">)</span>,
                      <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">female_dat</span>, <span class="va">w5h2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">"gender"</span>, values_from <span class="op">=</span> <span class="st">".epred"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="va">m</span> <span class="op">-</span> <span class="va">f</span><span class="op">)</span>

<span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">mean_qi</a></span><span class="op">(</span><span class="va">marg_eff</span><span class="op">$</span><span class="va">diff</span>, .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;        y    ymin   ymax .width .point .interval</span>
<span class="co">#&gt; 1 0.0158 -0.0638 0.0832   0.67   mean        qi</span>
<span class="co">#&gt; 2 0.0158 -0.1177 0.1212   0.89   mean        qi</span>
<span class="co">#&gt; 3 0.0158 -0.1682 0.1620   0.97   mean        qi</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">marg_eff</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">diff</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_sample_slabinterval.html">stat_halfeye</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"#009FB7"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Difference in Awards (Male - Female)"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-glm_files/figure-html/w5h2-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>3.</strong> Considering the total effect (problem 1) and direct effect (problem 2) of gender, what causes contribute to the average difference between women and men in award rate in this sample? It is not necessary to say whether or not there is evidence of discrimination. Simply explain how the direct effects you have estimated make sense (or not) of the total effect.</p>
</blockquote>
</div>
<p>The results from the first two problems indicate that 1) total effect of gender is that females are disadvantaged, but also that 2) the direct effect is a balanced disadvantage to both males and females depending on the discipline. This is because, in this data, females tended to apply slightly more to disciplines with lower overall award rates.</p>
<p>The figure below shows, for each discipline, the proportion of female and male applications that were submitted. That is, of all applications submitted by females, just under 35% were submitted to the social sciences. Similarly, about 25% of male applications were to the social sciences. Thus, disciplines below the dashed line are those where a relatively larger proportion of females submitted applications. Finally, the size of the points represents the award rate for each discipline (i.e., granted awards out of total applications).</p>
<p>Overall we see that disciplines above the dashed line (i.e., those where males were relatively more likely to apply) tended to have higher award rates than those below the dashed line. Thus, because females were relatively more likely to apply to disciplines with lower award rates, females were less likely overall to be awarded a grant.</p>
<div class="sourceCode" id="cb286"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nwo_dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">discipline</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">applications</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">gender</span> <span class="op">==</span> <span class="st">"f"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
            m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">applications</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">gender</span> <span class="op">==</span> <span class="st">"m"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
            total_apps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">applications</span><span class="op">)</span>,
            total_awards <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">awards</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>female_pct <span class="op">=</span> <span class="va">f</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>,
         male_pct <span class="op">=</span> <span class="va">m</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>,
         award_pct <span class="op">=</span> <span class="va">total_awards</span> <span class="op">/</span> <span class="va">total_apps</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">female_pct</span>, y <span class="op">=</span> <span class="va">male_pct</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">award_pct</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">female_pct</span> <span class="op">-</span> <span class="va">male_pct</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_label_repel</span><span class="op">(</span>data <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">female_pct</span> <span class="op">-</span> <span class="va">male_pct</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.05</span><span class="op">)</span>,
                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">discipline</span><span class="op">)</span>,
                   max.overlaps <span class="op">=</span> <span class="cn">Inf</span>, nudge_y <span class="op">=</span> <span class="fl">0.03</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_size.html">scale_size</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.3</span>, by <span class="op">=</span> <span class="fl">0.04</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"#009FB7"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expand_limits.html">expand_limits</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.35</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.35</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Female Application Rate"</span>, y <span class="op">=</span> <span class="st">"Male Application Rate"</span>,
       size <span class="op">=</span> <span class="st">"Award Rate"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-glm_files/figure-html/w5h3-1-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>4 - OPTIONAL CHALLENGE.</strong> The data in <code>data(UFClefties)</code> are the outcomes of 205 Ultimate Fighting Championship (UFC) matches (see <code><a href="https://rdrr.io/pkg/rethinking/man/UFClefties.html">?UFClefties</a></code> for details). It is widely believed that left-handed fighters (aka “Southpaws”) have an advantage against right-handed fighters, and left-handed men are indeed over-represented among fighters (and fencers and tennis players) compared to the general population. Estimate the average advantage, if any, that a left-handed fighter has against right-handed fighters. Based upon your estimate, why do you think lefthanders are over-represented among UFC fighters?</p>
</blockquote>
</div>
<p>This question is more complicated that might first appear. This is because our data set is pre-conditioned on a collider. Let’s draw a DAG to illustrate. In the DAG, <span class="math inline">\(L\)</span> is left-handedness, <span class="math inline">\(W\)</span> is win/lose, <span class="math inline">\(Q\)</span> is an indicator for whether or not someone has qualified for the UFC, and <span class="math inline">\(A\)</span> is the ability of the fighters. Looking at the DAG, our data is pre-conditioned on <span class="math inline">\(Q\)</span>, that is, our data contains information only on fighters who qualified for the UFC. Thus, there is a backdoor path open from left-handedness to wins that is confounding the true relationship between left-handedness and winning.</p>
<div class="inline-figure"><img src="05-glm_files/figure-html/w5h4-1-1.png" width="40%" style="display: block; margin: auto;"></div>
<p>We can run a quick simulation to illustrate the problem. Let’s simulate data where there are two ways to get into the UFC: 1) you are high ability, or 2) you have lower ability but are left handed, giving you a slight advantage. Thus, there are only high ability right-handed individuals, and both low and high ability left-handed individuals.</p>
<div class="sourceCode" id="cb287"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">221</span><span class="op">)</span>

<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">5000</span>
<span class="va">L</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/rbernoulli.html">rbernoulli</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>
<span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>

<span class="co"># qualify for UFC if high A, or lower A but left handed</span>
<span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">A</span> <span class="op">&gt;</span> <span class="fl">2</span> <span class="op">|</span> <span class="op">(</span><span class="va">A</span> <span class="op">&gt;</span> <span class="fl">1.25</span> <span class="op">&amp;</span> <span class="va">L</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">)</span>, <span class="fl">1L</span>, <span class="fl">0L</span><span class="op">)</span>

<span class="co"># filter to only qualified individuals</span>
<span class="va">ufc_fighters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>l <span class="op">=</span> <span class="va">L</span>, a <span class="op">=</span> <span class="va">A</span>, q <span class="op">=</span> <span class="va">Q</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">q</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">q</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rowid_to_column</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">"fighter_id"</span><span class="op">)</span>

<span class="co"># create data</span>
<span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">2.0</span>    <span class="co"># importance of ability difference</span>
<span class="va">b</span> <span class="op">&lt;-</span> <span class="fl">0.5</span>    <span class="co"># left-handedness advantage</span>

<span class="va">ufc_sim</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>fighter_1 <span class="op">=</span> <span class="va">ufc_fighters</span><span class="op">$</span><span class="va">fighter_id</span><span class="op">[</span><span class="va">ufc_fighters</span><span class="op">$</span><span class="va">fighter_id</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">2</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>,
         fighter_2 <span class="op">=</span> <span class="va">ufc_fighters</span><span class="op">$</span><span class="va">fighter_id</span><span class="op">[</span><span class="va">ufc_fighters</span><span class="op">$</span><span class="va">fighter_id</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">2</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">ufc_fighters</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"fighter_1"</span> <span class="op">=</span> <span class="st">"fighter_id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">ufc_fighters</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"fighter_2"</span> <span class="op">=</span> <span class="st">"fighter_id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>l1 <span class="op">=</span> <span class="va">l.x</span>, a1 <span class="op">=</span> <span class="va">a.x</span>, l2 <span class="op">=</span> <span class="va">l.y</span>, a2 <span class="op">=</span> <span class="va">a.y</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>score1 <span class="op">=</span> <span class="va">a1</span> <span class="op">+</span> <span class="va">b</span> <span class="op">*</span> <span class="va">l1</span>,
         score2 <span class="op">=</span> <span class="va">a2</span> <span class="op">+</span> <span class="va">b</span> <span class="op">*</span> <span class="va">l2</span>,
         p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/rethinking-internal.html">inv_logit</a></span><span class="op">(</span><span class="va">k</span> <span class="op">*</span> <span class="op">(</span><span class="va">score1</span> <span class="op">-</span> <span class="va">score2</span><span class="op">)</span><span class="op">)</span>,
         fighter1_win <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/rbernoulli.html">rbernoulli</a></span><span class="op">(</span><span class="fl">1</span>, p <span class="op">=</span> <span class="va">p</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">fighter_1</span>, <span class="va">fighter_2</span>, <span class="va">l1</span>, <span class="va">l2</span>, <span class="va">fighter1_win</span><span class="op">)</span></code></pre></div>
<p>Now let’s fit the model and see the effect of left-handedness. Overall, we estimate a slight <em>disadvantage</em> of being left-handed, even though the data was simulated to have an advantage of 0.5. This is our collider bias in action.</p>
<div class="sourceCode" id="cb288"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">w5h4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">fighter1_win</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">b</span> <span class="op">*</span> <span class="op">(</span><span class="va">l1</span> <span class="op">-</span> <span class="va">l2</span><span class="op">)</span>,
               <span class="va">b</span> <span class="op">~</span> <span class="fl">1</span>,
               nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">ufc_sim</span>, family <span class="op">=</span> <span class="va">bernoulli</span>,
            prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
            iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
            file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw5"</span>, <span class="st">"w5h4"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">w5h4</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">b_b_Intercept</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_sample_slabinterval.html">stat_halfeye</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fl">0.89</span>, fill <span class="op">=</span> <span class="st">"#009FB7"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"&amp;beta;&lt;sub&gt;L&lt;/sub&gt;"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="05-glm_files/figure-html/w5h4-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>If we want to close the backdoor path, we need to condition on fighter ability. Unfortunately we don’t have ability estimates in our data. There are ways we could estimate this directly from the data using something like a <a href="">Bradley-Terry</a> model or <a href="">Elo</a> ratings, but we only have a limited number of matches for each of our fighters. The most matches we have for any one fighter is 5. This will make it hard to get reliable estimates of fighter ability with methods we’ve learned so far. This is prime case for multilevel models, but that will come in future weeks.</p>
<div class="sourceCode" id="cb289"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">UFClefties</span><span class="op">)</span>

<span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>fighter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">UFClefties</span><span class="op">$</span><span class="va">fighter1</span>, <span class="va">UFClefties</span><span class="op">$</span><span class="va">fighter2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">fighter</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 244 × 2</span>
<span class="co">#&gt;    fighter     n</span>
<span class="co">#&gt;      &lt;int&gt; &lt;int&gt;</span>
<span class="co">#&gt;  1     123     5</span>
<span class="co">#&gt;  2     232     5</span>
<span class="co">#&gt;  3      19     4</span>
<span class="co">#&gt;  4      58     4</span>
<span class="co">#&gt;  5      62     4</span>
<span class="co">#&gt;  6      63     4</span>
<span class="co">#&gt;  7      71     4</span>
<span class="co">#&gt;  8      78     4</span>
<span class="co">#&gt;  9     113     4</span>
<span class="co">#&gt; 10     175     4</span>
<span class="co">#&gt; # … with 234 more rows</span></code></pre></div>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="overfitting-mcmc.html"><span class="header-section-number">4</span> Overfitting / MCMC</a></div>
<div class="next"><a href="references.html">References</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#generalized-linear-models"><span class="header-section-number">5</span> Generalized Linear Models</a></li>
<li><a class="nav-link" href="#lectures-4"><span class="header-section-number">5.1</span> Lectures</a></li>
<li>
<a class="nav-link" href="#exercises-4"><span class="header-section-number">5.2</span> Exercises</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#chapter-10"><span class="header-section-number">5.2.1</span> Chapter 10</a></li>
<li><a class="nav-link" href="#chapter-11"><span class="header-section-number">5.2.2</span> Chapter 11</a></li>
</ul>
</li>
<li><a class="nav-link" href="#homework-4"><span class="header-section-number">5.3</span> Homework</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/wjakethompson/sr2-solutions/blob/main/05-glm.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/wjakethompson/sr2-solutions/edit/main/05-glm.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Statistical Rethinking: Solutions (2nd Edition)</strong>" was written by Jake Thompson. It was last built on 2022-02-21.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
