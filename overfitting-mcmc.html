<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Week 4: Overfitting / MCMC | Statistical Rethinking: Solutions (2nd Edition)</title>
<meta name="author" content="Jake Thompson">
<meta name="description" content="The fourth week covers Chapter 7 (Ulysses‚Äô Compass), Chapter 8 (Conditional Manatees), and Chapter 9 (Markov Chain Monte Carlo).  4.1 Lectures Lecture 7:  Lecture 8:   4.2 Exercises  4.2.1 Chapter...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Week 4: Overfitting / MCMC | Statistical Rethinking: Solutions (2nd Edition)">
<meta property="og:type" content="book">
<meta property="og:url" content="https://sr2-solutions.wjakethompson.com/overfitting-mcmc.html">
<meta property="og:description" content="The fourth week covers Chapter 7 (Ulysses‚Äô Compass), Chapter 8 (Conditional Manatees), and Chapter 9 (Markov Chain Monte Carlo).  4.1 Lectures Lecture 7:  Lecture 8:   4.2 Exercises  4.2.1 Chapter...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Week 4: Overfitting / MCMC | Statistical Rethinking: Solutions (2nd Edition)">
<meta name="twitter:site" content="@wjakethompson">
<meta name="twitter:description" content="The fourth week covers Chapter 7 (Ulysses‚Äô Compass), Chapter 8 (Conditional Manatees), and Chapter 9 (Markov Chain Monte Carlo).  4.1 Lectures Lecture 7:  Lecture 8:   4.2 Exercises  4.2.1 Chapter...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/_Source%20Sans%20Pro-0.4.0.9000/font.css" rel="stylesheet">
<link href="libs/_Fira%20Code-0.4.0.9000/font.css" rel="stylesheet">
<link href="libs/_Oxygen-0.4.0.9000/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="assets/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Statistical Rethinking: Solutions (2nd Edition)</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="bayesian-inference.html"><span class="header-section-number">1</span> Bayesian Inference</a></li>
<li><a class="" href="linear-models-causal-inference.html"><span class="header-section-number">2</span> Linear Models &amp; Causal Inference</a></li>
<li><a class="" href="causes-confounds-colliders.html"><span class="header-section-number">3</span> Causes, Confounds &amp; Colliders</a></li>
<li><a class="active" href="overfitting-mcmc.html"><span class="header-section-number">4</span> Overfitting / MCMC</a></li>
<li><a class="" href="generalized-linear-models.html"><span class="header-section-number">5</span> Generalized Linear Models</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/wjakethompson/sr2-solutions">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="overfitting-mcmc" class="section level1" number="4">
<h1>
<span class="header-section-number">Week 4:</span> Overfitting / MCMC<a class="anchor" aria-label="anchor" href="#overfitting-mcmc"><i class="fas fa-link"></i></a>
</h1>
<p>The fourth week covers <a href="https://bookdown.org/content/4857/ulysses-compass.html">Chapter 7 (Ulysses‚Äô Compass)</a>, <a href="https://bookdown.org/content/4857/conditional-manatees.html">Chapter 8 (Conditional Manatees)</a>, and <a href="https://bookdown.org/content/4857/markov-chain-monte-carlo.html">Chapter 9 (Markov Chain Monte Carlo)</a>.</p>
<div id="lectures-3" class="section level2" number="4.1">
<h2>
<span class="header-section-number">4.1</span> Lectures<a class="anchor" aria-label="anchor" href="#lectures-3"><i class="fas fa-link"></i></a>
</h2>
<p>Lecture 7:</p>
<iframe src="https://www.youtube.com/embed/odGAAJDlgp8" width="100%" height="400px" data-external="1">
</iframe>
<p>Lecture 8:</p>
<iframe src="https://www.youtube.com/embed/Qqz5AJjyugM" width="100%" height="400px" data-external="1">
</iframe>
</div>
<div id="exercises-3" class="section level2" number="4.2">
<h2>
<span class="header-section-number">4.2</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-3"><i class="fas fa-link"></i></a>
</h2>
<div id="chapter-7" class="section level3" number="4.2.1">
<h3>
<span class="header-section-number">4.2.1</span> Chapter 7<a class="anchor" aria-label="anchor" href="#chapter-7"><i class="fas fa-link"></i></a>
</h3>
<div class="question">
<blockquote>
<p><strong>7E1.</strong> State the three motivating criteria that define information entropy. Try to express each in your own words.</p>
</blockquote>
</div>
<p>Information is defined as <em>the reduction in uncertainty when we learn and outcome</em>. The motivating criteria for defining information entropy revolve around the measure of uncertainty that is used to derive information.</p>
<p>The first is that the measure of uncertainty must be continuous. This prevents large changes in the uncertainty measure resulting from relatively small changes in probabilities. Such a phenomenon often occurs when researchers use a <em>p</em>-value cutoff of .05 to claim ‚Äúsignificance.‚Äù Often, the difference between ‚Äúsignificant‚Äù and ‚Äúnon-significant‚Äù results is itself non-significant ü§Ø.</p>
<p>The second is that the measure of uncertainty should increase as the number of possible events increases. When there are more potential outcomes, there are more predictions that have to be made, and therefore more uncertainty about which outcome will be observed. For example, if your friend asks you to guess a number between 1 and 100, you are much less likely to guess correctly than if you were guessing a number between 1 and 2.</p>
<p>The third and final criteria is that the measure of uncertainty should be additive. These means that if we calculate the uncertainty for two sets of outcomes (e.g., heads or tail on a coin flip and the results of a thrown die), then the uncertainty of combinations of events (e.g., heads and ‚Äú3‚Äù) should be equal to the sum of the uncertainties from the two separate events.</p>
<p>Information entropy is the only function that satisfies all three criteria.</p>
<div class="question">
<blockquote>
<p><strong>7E2.</strong> Suppose a coin is weighted such that, when it is tossed and lands on a table, it comes up heads 70% of the time. What is the entropy of this coin?</p>
</blockquote>
</div>
<p>Entropy is the average log-probability of an event. The formula is given as</p>
<p><span class="math display">\[\begin{equation}
  H(p) = -\text{E}\log(p_i) = -\sum_{i=1}^np_i\log(p_i)
\end{equation}\]</span></p>
<p>Thus, for each probability <span class="math inline">\(p_i\)</span>, we multiply <span class="math inline">\(p_i\)</span> by <span class="math inline">\(\log(p_i)\)</span>, sum all the values, and then multiply the sum by negative one. To implement this, we‚Äôll first write a couple of functions to do the calculations. We could do this without functions, but functions will allow us to handle cases where <span class="math inline">\(p_i = 0\)</span>, as will be the case in a couple of problems. The first function, <code>p_logp()</code>, returns <code>0</code> if <code>p</code> is 0, and returns <code>p * log(p)</code> otherwise. The <code>calc_entropy()</code> function is a wrapper around <code>p_logp()</code>, applying <code>p_logp()</code> to each element of a vector of probabilities, summing the results, and multiplying the sum by -1.</p>
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_logp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">p</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>
  <span class="va">p</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">calc_entropy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">avg_logprob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">p_logp</span><span class="op">)</span><span class="op">)</span>
  <span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="va">avg_logprob</span>
<span class="op">}</span></code></pre></div>
<p>Applying these functions to the probabilities in this problem results in an entropy of about 0.61. Note this is the same as the weather example in the text, because in both cases there were two events with probabilities of 0.3 and 0.7.</p>
<div class="sourceCode" id="cb149"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.3</span><span class="op">)</span>
<span class="fu">calc_entropy</span><span class="op">(</span><span class="va">probs</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.611</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>7E3.</strong> Suppose a four-sided die is loaded such that, when tossed onto a table, it shows ‚Äú1‚Äù 20%, ‚Äú2‚Äù 25%, ‚Äú3‚Äù 25%, and ‚Äú4‚Äù 30% of the time. What is the entropy of this die?</p>
</blockquote>
</div>
<p>Now we have four outcomes. We can reuse our code from above, substituting the new probabilities into the vector <code>probs</code>. This results in an entropy of about 1.38. As expected, because there are now more outcomes, the entropy is higher than what was observed in the previous problem.</p>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.20</span>, <span class="fl">0.25</span>, <span class="fl">0.25</span>, <span class="fl">0.30</span><span class="op">)</span>
<span class="fu">calc_entropy</span><span class="op">(</span><span class="va">probs</span><span class="op">)</span>
<span class="co">#&gt; [1] 1.38</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>7E4.</strong> Suppose another four-sided die is loaded such that it never shows ‚Äú4.‚Äù The other three sides show equally often. What is the entropy of this die?</p>
</blockquote>
</div>
<p>Again, we can copy our code from above, replace the probabilities. Even though there are four outcomes specified, there are effectively three outcomes, as the outcome ‚Äú4‚Äù has probability 0. Thus, we would expect entropy to decrease, as there are fewer possible outcomes than in the previous problem. This is indeed what we find, as this die‚Äôs entropy is about 1.1.</p>
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>
<span class="va">probs</span> <span class="op">&lt;-</span> <span class="va">probs</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">probs</span><span class="op">)</span>
<span class="va">probs</span>
<span class="co">#&gt; [1] 0.333 0.333 0.333 0.000</span>

<span class="fu">calc_entropy</span><span class="op">(</span><span class="va">probs</span><span class="op">)</span>
<span class="co">#&gt; [1] 1.1</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>7M1.</strong> Write down and compare the definitions of AIC and WAIC. Which of these criteria is most general? Which assumptions are required to transform the more general criterion into a less general one?</p>
</blockquote>
</div>
<p>The AIC is defined as follows, where <span class="math inline">\(\text{lppd}\)</span> is the log-pointwise-predictive density, and <span class="math inline">\(p\)</span> is the number of free parameters in the posterior distribution.</p>
<p><span class="math display">\[
\text{AIC} = -2\text{lppd} + 2p
\]</span></p>
<p>In contrast, the WAIC is defined as:</p>
<p><span class="math display">\[
\text{WAIC}(y,\Theta) = -2\Big(\text{lppd} - \sum_i \text{var}_{\theta}\log p(y_i | \theta)\Big)
\]</span></p>
<p>If we distribute the <span class="math inline">\(-2\)</span> through, this looks remarkably similar to the AIC formula, with the exception of the final <span class="math inline">\(p\)</span> term. Whereas the AIC uses 2 times the number of free parameters, the WAIC uses 2 times the sum of the log-probability variances from each observation.</p>
<p>The WAIC is more general than the AIC, as the AIC assumes that priors are flat or overwhelmed by the likelihood, the posterior distribution is approximately multivariate Gaussian, and the sample size is much greater than the number of parameters. If all of these assumptions are met, then we would expect the AIC and WAIC to be about the same.</p>
<div class="question">
<blockquote>
<p><strong>7M2.</strong> Explain the difference between model <em>selection</em> and model <em>comparison</em>. What information is lost under model selection?</p>
</blockquote>
</div>
<p>Model selection refers to just picking the model that has the lowest (i.e., best) criterion value and discarding other models. When we take this approach, we lose information about the relative model accuracy that can be seen across the criterion values for the candidate models. This information can inform how confident we are in the models. Additionally, the model selection paradigm cares only about predictive accuracy and ignores causal inference. Thus, a model may be selected that has confounds or that would not correctly inform an intervention.</p>
<p>In contrast, model comparison uses multiple models to understand how the variables included influence prediction and affect implied conditional independencies in a causal model. Thus, we preserve information and can make more holistic judgments about our data and models.</p>
<div class="question">
<blockquote>
<p><strong>7M3.</strong> When comparing models with an information criterion, why must all models be fit to exactly the same observations? What would happen to the information criterion values, if the models were fit to different numbers of observations? Perform some experiments, if you are not sure.</p>
</blockquote>
</div>
<p>All of the information criteria are defined based on the log-pointwise-predictive density, defined as follows, where <span class="math inline">\(y\)</span> is the data, <span class="math inline">\(\Theta\)</span> is the posterior distribution, <span class="math inline">\(S\)</span> is the number of samples, and <span class="math inline">\(I\)</span> is the number of samples.</p>
<p><span class="math display">\[
\text{lppd}(y,\Theta) = \sum_i\log\frac{1}{S}\sum_sp(y_i|\Theta_s)
\]</span></p>
<p>In words, this means take the log of the average probability across samples of each observation <span class="math inline">\(i\)</span> and sum them together. Thus, a larger sample size will necessarily lead to a smaller log-pointwise-predictive-density, even if the data generating process and models are exactly equivalent (i.e., when the LPPD values are negative, the sum will get more negative as the sample size increases). More observations are entered into the sum, leading to a smaller final lppd, which will in turn increase the information criteria. We can run a quick simulation to demonstrate. For three different sample sizes, we‚Äôll simulate 100 data sets from the exact same data generation process, estimate a the exact same linear model, and then calculate the LPPD, WAIC, and PSIS for each.</p>
<p>Visualizing the distribution of the LPPD, WAIC, and PSIS across simulated data sets with each sample size, we see that the LPPD gets more negative as the sample size increases, even though the data generation process and estimated model are identical. Accordingly, the WAIC and PSIS increase. Note that the WAIC and PSIS values are approximately <span class="math inline">\(-2 \times \text{lppd}\)</span>. Thus, if we fit one model with 100 observations and second model with 1,000 observations, we might conclude from the WAIC and PSIS that the first model with 100 observations has much better predictive accuracy, because the WAIC and PSIS values are lower. However, this would be only an artifact of different sample sizes, and may not actually represent true differences between the models.</p>
<details><summary>
Simulation Code
</summary><div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gen_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span>, mean <span class="op">=</span> <span class="fl">0.3</span> <span class="op">+</span> <span class="fl">0.8</span> <span class="op">*</span> <span class="va">x1</span><span class="op">)</span>,
           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">standardize</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">fit_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html">capture.output</a></span><span class="op">(</span>
    <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">x1</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
               prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                         <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,
                         <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
               iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">3000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span>
  <span class="op">)</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">calc_info</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">mod_lppd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/log_lik.brmsfit.html">log_lik</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span>.name_repair <span class="op">=</span> <span class="st">"minimal"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://purrr.tidyverse.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"obs_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rowid_to_column</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">"iter"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">iter</span>, names_to <span class="op">=</span> <span class="st">"obs"</span>, values_to <span class="op">=</span> <span class="st">"logprob"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">logprob</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>log_prob_score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">log_prob_score</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span>
  
  <span class="va">mod_waic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/waic.brmsfit.html">waic</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"waic"</span>, <span class="st">"Estimate"</span><span class="op">]</span><span class="op">)</span>
  <span class="va">mod_psis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/loo.brmsfit.html">loo</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"looic"</span>, <span class="st">"Estimate"</span><span class="op">]</span><span class="op">)</span>
  
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>lppd <span class="op">=</span> <span class="va">mod_lppd</span>, waic <span class="op">=</span> <span class="va">mod_waic</span>, psis <span class="op">=</span> <span class="va">mod_psis</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">sample_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>sample_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">500</span>, <span class="fl">1000</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sample_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/quap.html">map</a></span><span class="op">(</span><span class="va">sample_size</span>, <span class="va">gen_data</span><span class="op">)</span>,
         model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/quap.html">map</a></span><span class="op">(</span><span class="va">sample_data</span>, <span class="va">fit_model</span><span class="op">)</span>,
         infc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/quap.html">map</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">calc_info</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sample_data</span>, <span class="op">-</span><span class="va">model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">infc</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html">write_rds</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"b7m3-sim.rds"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"gz"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/ggridges/">ggridges</a></span><span class="op">)</span>

<span class="va">sample_sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">lppd</span>, <span class="va">waic</span>, <span class="va">psis</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sample_size <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_inorder</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">sample_size</span><span class="op">)</span><span class="op">)</span>,
         name <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_upper</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span>,
         name <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_inorder</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, y <span class="op">=</span> <span class="va">sample_size</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span>, nrow <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://wilkelab.org/ggridges/reference/geom_density_ridges.html">geom_density_ridges</a></span><span class="op">(</span>bandwidth <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_y_discrete</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2000</span>, <span class="fl">3000</span>, by <span class="op">=</span> <span class="fl">750</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>clip <span class="op">=</span> <span class="st">"off"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Value"</span>, y <span class="op">=</span> <span class="st">"Sample Size"</span><span class="op">)</span></code></pre></div>
</details><div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e7m3-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>7M4.</strong> What happens to the effective number of parameters, as measured by PSIS or WAIC, as a prior becomes more concentrated? Why? Perform some experiments, if you are not sure.</p>
</blockquote>
</div>
<p>The penalty term of the WAIC, <span class="math inline">\(p_{\Tiny\text{WAIC}}\)</span> is defined as shown in the WAIC formula. Specifically, the penalty term is sum of the variances of the log probabilities for each observation.</p>
<p><span class="math display">\[
\text{WAIC}(y,\Theta) = -2\Big(\text{lppd} - \underbrace{\sum_i \text{var}_{\theta}\log p(y_i | \theta)}_{\text{penalty term}}\Big)
\]</span></p>
<p>Smaller variances in log probabilities will results in a lower penalty. If we restrict the prior to become more concentrated, we restrict the plausible range of the parameters. In other words, we restrict the variability in the posterior distribution. As the parameters become more consistent, the log probability of each observation will necessarily become more consistent also. Thus, the penalty term, or effective number of parameters, becomes smaller. We can again confirm with a small simulation.</p>
<p>In this simulation we keep everything constant (i.e., data generation, model), with the exception of the prior for the slope coefficients. We‚Äôll try three different priors: <span class="math inline">\(\text{Normal}(0, 0.1)\)</span>, <span class="math inline">\(\text{Normal}(0, 1)\)</span>, and <span class="math inline">\(\text{Normal}(0, 10)\)</span>. Visualizing the results, we can see that the more constricted prior does indeed result in a smaller penalty or effective number of parameters.</p>
<details><summary>
Simulation Code
</summary><div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gen_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span><span class="op">)</span>,
         x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span><span class="op">)</span>,
         x3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span>, mean <span class="op">=</span> <span class="fl">0.3</span> <span class="op">+</span> <span class="fl">0.8</span> <span class="op">*</span> <span class="va">x1</span> <span class="op">+</span>
                       <span class="fl">0.6</span> <span class="op">*</span> <span class="va">x2</span> <span class="op">+</span> <span class="fl">1.2</span> <span class="op">*</span> <span class="va">x3</span><span class="op">)</span>,
           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">standardize</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">fit_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">p_sd</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html">capture.output</a></span><span class="op">(</span>
    <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span> <span class="op">+</span> <span class="va">x3</span>, data <span class="op">=</span> <span class="va">dat</span>,
               family <span class="op">=</span> <span class="va">gaussian</span>,
               prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                         <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior_string</a></span><span class="op">(</span><span class="fu">glue</span><span class="op">(</span><span class="st">"normal(0, {p_sd})"</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,
                         <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
               iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">3000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span>
  <span class="op">)</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">calc_info</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/waic.brmsfit.html">waic</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span>
  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/loo.brmsfit.html">loo</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span>
  
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>p_waic <span class="op">=</span> <span class="va">w</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"p_waic"</span>, <span class="st">"Estimate"</span><span class="op">]</span>,
         p_loo <span class="op">=</span> <span class="va">p</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"p_loo"</span>, <span class="st">"Estimate"</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">prior_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>sample_size <span class="op">=</span> <span class="fl">20</span>,
                    prior_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sample_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/quap.html">map</a></span><span class="op">(</span><span class="va">sample_size</span>, <span class="va">gen_data</span><span class="op">)</span>,
         model <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op">(</span><span class="va">sample_data</span>, <span class="va">prior_sd</span>, <span class="va">fit_model</span><span class="op">)</span>,
         infc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/quap.html">map</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">calc_info</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sample_data</span>, <span class="op">-</span><span class="va">model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">infc</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html">write_rds</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"b7m4-sim.rds"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"gz"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb155"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prior_sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">p_waic</span>, <span class="va">p_loo</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prior_sd <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"&amp;sigma; = {prior_sd}"</span><span class="op">)</span>,
         prior_sd <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_inorder</a></span><span class="op">(</span><span class="va">prior_sd</span><span class="op">)</span>,
         name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">name</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"p_waic"</span>, <span class="st">"p_loo"</span><span class="op">)</span>,
                       labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"p&lt;sub&gt;WAIC&lt;/sub&gt;"</span>, <span class="st">"p&lt;sub&gt;PSIS&lt;/sub&gt;"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, y <span class="op">=</span> <span class="va">prior_sd</span>, height <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html">stat</a></span><span class="op">(</span><span class="va">density</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://wilkelab.org/ggridges/reference/geom_density_ridges.html">geom_density_ridges</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"binline"</span>, bins <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Effective Parameters"</span>, y <span class="op">=</span> <span class="st">"Prior"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</details><div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e7m4-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>7M5.</strong> Provide an informal explanation of why informative priors reduce overfitting.</p>
</blockquote>
</div>
<p>Informative priors restrict the plausible values for parameters. By using informative priors, we can limit the values of parameters to values that are reasonable, given our scientific knowledge. Thus, we can keep the model from learning too much from our specific sample.</p>
<div class="question">
<blockquote>
<p><strong>7M6.</strong> Provide an informal explanation of why overly informative priors result in underfitting.</p>
</blockquote>
</div>
<p>In contrast to the previous question, making the prior too informative can be too restrictive on the parameter space. This prevents our model from learning enough from our sample. We basically just get our prior distributions back, without learning anything from the data that could help make future predictions.</p>
<div class="question">
<blockquote>
<p><strong>7H1.</strong> In 2007, <em>The Wall Street Journal</em> published an editorial (‚ÄúWe‚Äôre Number One, Alas‚Äù) with a graph of corportate tax rates in 29 countries plotted against tax revenue. A badly fit curve was drawn in (reconstructed at right), seemingly by hand, to make the argument that the relationship between tax rate and tax revenue increases and then declines, such that higher tax rates can actually produce less tax revenue. I want you to actually fit a curve to these data, found in <code>data(Laffer)</code>. Consider models that use tax rate to predict tax revenue. Compare, using WAIC or PSIS, a straight-line model to any curved models you like. What do you conclude about the relationship between tax rate and tax revenue.</p>
</blockquote>
</div>
<p>First, let‚Äôs standardize the data and fit a straight line, a quadratic line, and a spline model.</p>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Laffer</span><span class="op">)</span>

<span class="va">laf_dat</span> <span class="op">&lt;-</span> <span class="va">Laffer</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">standardize</span><span class="op">)</span>,
         tax_rate2 <span class="op">=</span> <span class="va">tax_rate</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span>

<span class="va">laf_line</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">tax_revenue</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">tax_rate</span>, data <span class="op">=</span> <span class="va">laf_dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
                prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
                iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"b7h1-line.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="va">laf_quad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">tax_revenue</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">tax_rate</span> <span class="op">+</span> <span class="va">tax_rate2</span>, data <span class="op">=</span> <span class="va">laf_dat</span>,
                family <span class="op">=</span> <span class="va">gaussian</span>,
                prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
                iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"b7h1-quad.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="va">laf_spln</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">tax_revenue</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/s.html">s</a></span><span class="op">(</span><span class="va">tax_rate</span>, bs <span class="op">=</span> <span class="st">"bs"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">laf_dat</span>,
                family <span class="op">=</span> <span class="va">gaussian</span>,
                prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sds</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
                iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span>,
                file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"bh71-spln.rds"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Let‚Äôs visualize the models:</p>
<details><summary>
Code to reproduce
</summary><div class="sourceCode" id="cb157"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tr_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>tax_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">40</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>tax_rate <span class="op">=</span> <span class="op">(</span><span class="va">tax_rate</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Laffer</span><span class="op">$</span><span class="va">tax_rate</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">Laffer</span><span class="op">$</span><span class="va">tax_rate</span><span class="op">)</span>,
         tax_rate2 <span class="op">=</span> <span class="va">tax_rate</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span>

<span class="va">predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">predicted_draws</a></span><span class="op">(</span><span class="va">laf_line</span>, newdata <span class="op">=</span> <span class="va">tr_seq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fl">0.89</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Linear"</span><span class="op">)</span>,
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">predicted_draws</a></span><span class="op">(</span><span class="va">laf_quad</span>, newdata <span class="op">=</span> <span class="va">tr_seq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fl">0.89</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Quadratic"</span><span class="op">)</span>,
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">predicted_draws</a></span><span class="op">(</span><span class="va">laf_spln</span>, newdata <span class="op">=</span> <span class="va">tr_seq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fl">0.89</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Spline"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">epred_draws</a></span><span class="op">(</span><span class="va">laf_line</span>, newdata <span class="op">=</span> <span class="va">tr_seq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Linear"</span><span class="op">)</span>,
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">epred_draws</a></span><span class="op">(</span><span class="va">laf_quad</span>, newdata <span class="op">=</span> <span class="va">tr_seq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Quadratic"</span><span class="op">)</span>,
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">epred_draws</a></span><span class="op">(</span><span class="va">laf_spln</span>, newdata <span class="op">=</span> <span class="va">tr_seq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Spline"</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">type</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">predictions</span>,
              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">tax_rate</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span>,
              alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/geom_lineribbon.html">geom_lineribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">fits</span>,
                  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">tax_rate</span>, y <span class="op">=</span> <span class="va">.epred</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span>,
                  size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">laf_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">tax_rate</span>, y <span class="op">=</span> <span class="va">tax_revenue</span><span class="op">)</span>,
             alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu">ramp_blue</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">0.1</span>, length.out <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,
                    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Standardized Tax Rate"</span>, y <span class="op">=</span> <span class="st">"Standardized Tax Revenue"</span>,
       fill <span class="op">=</span> <span class="st">"Interval"</span><span class="op">)</span></code></pre></div>
</details><div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e7h1-2-1.png" width="95%" style="display: block; margin: auto;"></div>
<p>They all look pretty similar, but the quadratic and spline models do show a slight curve. Next, we can look at the PSIS (called LOO in {brms} and {rstan}) and WAIC comparisons. Neither the PSIS or WAIC is really able to differentiate the models in a meaningful way. However, it should be noted that both the PSIS and WAIC have Pareto or penalty values that are exceptionally large, which could make the criteria unreliable.</p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/loo/">loo</a></span><span class="op">)</span>

<span class="va">laf_line</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">laf_line</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"loo"</span>, <span class="st">"waic"</span><span class="op">)</span><span class="op">)</span>
<span class="va">laf_quad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">laf_quad</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"loo"</span>, <span class="st">"waic"</span><span class="op">)</span><span class="op">)</span>
<span class="va">laf_spln</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">laf_spln</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"loo"</span>, <span class="st">"waic"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">laf_line</span>, <span class="va">laf_quad</span>, <span class="va">laf_spln</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>
<span class="co">#&gt;          elpd_diff se_diff</span>
<span class="co">#&gt; laf_quad  0.0       0.0   </span>
<span class="co">#&gt; laf_spln -0.1       0.6   </span>
<span class="co">#&gt; laf_line -0.9       0.9</span>
<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">laf_line</span>, <span class="va">laf_quad</span>, <span class="va">laf_spln</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="co">#&gt;          elpd_diff se_diff</span>
<span class="co">#&gt; laf_spln  0.0       0.0   </span>
<span class="co">#&gt; laf_quad  0.0       0.7   </span>
<span class="co">#&gt; laf_line -0.8       0.9</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>7H2.</strong> In the <code>Laffer</code> data, there is one country with a high tax revenue that is an outlier. Use PSIS and WAIC to measure the importance of this outlier in the models you fit in the previous problem. Then use robust regression with a Student‚Äôs t distribution to revist the curve fitting problem. How much does a curved relationship depend upon the outlier point.</p>
</blockquote>
</div>
<p>Because I used <code><a href="https://rdrr.io/pkg/brms/man/brm.html">brms::brm()</a></code> to estimate the models, we can‚Äôt use the convenience functions to get the pointwise values for the PSIS and WAIC that are available in the {rethinking} package. So I‚Äôll write my own, called <code>criteria_influence()</code>. When we plot the Pareto <em>k</em> and <span class="math inline">\(p_{\Tiny\text{WAIC}}\)</span> values, we see that observation 12 is problematic in all three models.</p>
<div class="sourceCode" id="cb159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/yutannihilation/gghighlight/">gghighlight</a></span><span class="op">)</span>

<span class="va">criteria_influence</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mod</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>pareto_k <span class="op">=</span> <span class="va">mod</span><span class="op">$</span><span class="va">criteria</span><span class="op">$</span><span class="va">loo</span><span class="op">$</span><span class="va">diagnostics</span><span class="op">$</span><span class="va">pareto_k</span>,
         p_waic <span class="op">=</span> <span class="va">mod</span><span class="op">$</span><span class="va">criteria</span><span class="op">$</span><span class="va">waic</span><span class="op">$</span><span class="va">pointwise</span><span class="op">[</span>, <span class="st">"p_waic"</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rowid_to_column</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">"obs"</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">influ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="fu">criteria_influence</span><span class="op">(</span><span class="va">laf_line</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Linear"</span><span class="op">)</span>,
  <span class="fu">criteria_influence</span><span class="op">(</span><span class="va">laf_quad</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Quadratic"</span><span class="op">)</span>,
  <span class="fu">criteria_influence</span><span class="op">(</span><span class="va">laf_spln</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Spline"</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">influ</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">pareto_k</span>, y <span class="op">=</span> <span class="va">p_waic</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">type</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.7</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.4</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/gghighlight.html">gghighlight</a></span><span class="op">(</span><span class="va">pareto_k</span> <span class="op">&gt;</span> <span class="fl">0.7</span> <span class="op">|</span> <span class="va">p_waic</span> <span class="op">&gt;</span> <span class="fl">0.4</span>, n <span class="op">=</span> <span class="fl">1</span>, label_key <span class="op">=</span> <span class="va">obs</span>,
              label_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Pareto *k*"</span>, y <span class="op">=</span> <span class="st">"p&lt;sub&gt;WAIC&lt;/sub&gt;"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e7h2-1-1.png" width="95%" style="display: block; margin: auto;"></div>
<p>Let‚Äôs refit the model using a Student‚Äôs t distribution to put larger tails on our outcome distribution, and then visualize our new models.</p>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">laf_line2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">tax_revenue</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">tax_rate</span>, nu <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
                 data <span class="op">=</span> <span class="va">laf_dat</span>, family <span class="op">=</span> <span class="va">student</span>,
                 prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                           <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                           <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
                 iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                 file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"b7h2-line.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="va">laf_quad2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">tax_revenue</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">tax_rate</span> <span class="op">+</span> <span class="va">tax_rate2</span>, nu <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
                 data <span class="op">=</span> <span class="va">laf_dat</span>, family <span class="op">=</span> <span class="va">student</span>,
                 prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                           <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                           <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
                 iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                 file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"b7h2-quad.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="va">laf_spln2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">tax_revenue</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/s.html">s</a></span><span class="op">(</span><span class="va">tax_rate</span>, bs <span class="op">=</span> <span class="st">"bs"</span><span class="op">)</span>, nu <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
                 data <span class="op">=</span> <span class="va">laf_dat</span>, family <span class="op">=</span> <span class="va">student</span>,
                 prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                           <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                           <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sds</span><span class="op">)</span>,
                           <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
                 iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                 control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.99</span><span class="op">)</span>,
                 file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"bh72-spln.rds"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<details><summary>
Code to reproduce
</summary><div class="sourceCode" id="cb161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">predicted_draws</a></span><span class="op">(</span><span class="va">laf_line2</span>, newdata <span class="op">=</span> <span class="va">tr_seq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fl">0.89</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Linear"</span><span class="op">)</span>,
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">predicted_draws</a></span><span class="op">(</span><span class="va">laf_quad2</span>, newdata <span class="op">=</span> <span class="va">tr_seq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fl">0.89</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Quadratic"</span><span class="op">)</span>,
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">predicted_draws</a></span><span class="op">(</span><span class="va">laf_spln2</span>, newdata <span class="op">=</span> <span class="va">tr_seq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fl">0.89</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Spline"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">epred_draws</a></span><span class="op">(</span><span class="va">laf_line2</span>, newdata <span class="op">=</span> <span class="va">tr_seq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Linear"</span><span class="op">)</span>,
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">epred_draws</a></span><span class="op">(</span><span class="va">laf_quad2</span>, newdata <span class="op">=</span> <span class="va">tr_seq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Quadratic"</span><span class="op">)</span>,
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">epred_draws</a></span><span class="op">(</span><span class="va">laf_spln2</span>, newdata <span class="op">=</span> <span class="va">tr_seq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Spline"</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">type</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">predictions</span>,
              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">tax_rate</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span>,
              alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/geom_lineribbon.html">geom_lineribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">fits</span>,
                  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">tax_rate</span>, y <span class="op">=</span> <span class="va">.epred</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span>,
                  size <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">laf_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">tax_rate</span>, y <span class="op">=</span> <span class="va">tax_revenue</span><span class="op">)</span>,
             alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu">ramp_blue</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">0.1</span>, length.out <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,
                    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Standardized Tax Rate"</span>, y <span class="op">=</span> <span class="st">"Standardized Tax Revenue"</span>,
       fill <span class="op">=</span> <span class="st">"Interval"</span><span class="op">)</span></code></pre></div>
</details><div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e7h2-3-1.png" width="95%" style="display: block; margin: auto;"></div>
<p>The prediction intervals are a little bit narrower, which makes sense as the predictions are no longer being as influenced by the outlier. When we look at the new PSIS and WAIC estimates, we are no longer getting warning messages about large Pareto <em>k</em> values; however, we do still see warnings about large <span class="math inline">\(p_{\Tiny\text{WAIC}}\)</span> values. The comparisons also tell the same story as before, with no distinguishable differences between the models.</p>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">laf_line2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">laf_line2</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"loo"</span>, <span class="st">"waic"</span><span class="op">)</span><span class="op">)</span>
<span class="va">laf_quad2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">laf_quad2</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"loo"</span>, <span class="st">"waic"</span><span class="op">)</span><span class="op">)</span>
<span class="va">laf_spln2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">laf_spln2</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"loo"</span>, <span class="st">"waic"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">laf_line2</span>, <span class="va">laf_quad2</span>, <span class="va">laf_spln2</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>
<span class="co">#&gt;           elpd_diff se_diff</span>
<span class="co">#&gt; laf_quad2  0.0       0.0   </span>
<span class="co">#&gt; laf_spln2 -0.3       1.3   </span>
<span class="co">#&gt; laf_line2 -1.1       1.7</span>
<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">laf_line2</span>, <span class="va">laf_quad2</span>, <span class="va">laf_spln2</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="co">#&gt;           elpd_diff se_diff</span>
<span class="co">#&gt; laf_quad2  0.0       0.0   </span>
<span class="co">#&gt; laf_spln2 -0.2       1.2   </span>
<span class="co">#&gt; laf_line2 -1.1       1.7</span></code></pre></div>
<div class="question code-question">
<blockquote>
<p><strong>7H3.</strong> Consider three fictional Polynesian islands. On each there is a Royal Ornithologist charged by the king with surveying the bird population. They have each found the following proportions of 5 important bird species:</p>
</blockquote>
<div class="table-question">
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:left;">
</th>
<th style="text-align:center;">
Species A
</th>
<th style="text-align:center;">
Species B
</th>
<th style="text-align:center;">
Species C
</th>
<th style="text-align:center;">
Species D
</th>
<th style="text-align:center;">
Species E
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Island 1
</td>
<td style="text-align:center;">
0.200
</td>
<td style="text-align:center;">
0.200
</td>
<td style="text-align:center;">
0.200
</td>
<td style="text-align:center;">
0.200
</td>
<td style="text-align:center;">
0.200
</td>
</tr>
<tr>
<td style="text-align:left;">
Island 2
</td>
<td style="text-align:center;">
0.800
</td>
<td style="text-align:center;">
0.100
</td>
<td style="text-align:center;">
0.050
</td>
<td style="text-align:center;">
0.025
</td>
<td style="text-align:center;">
0.025
</td>
</tr>
<tr>
<td style="text-align:left;">
Island 3
</td>
<td style="text-align:center;">
0.050
</td>
<td style="text-align:center;">
0.150
</td>
<td style="text-align:center;">
0.700
</td>
<td style="text-align:center;">
0.050
</td>
<td style="text-align:center;">
0.050
</td>
</tr>
</tbody>
</table></div>
</div>
<blockquote>
<p>Notice that each row sums to 1, all the birds. This problem has two parts. It is not computationally complicated. But it is conceptually tricky. First, compute the entropy of each island‚Äôs bird distribution. Interpret these entropy values. Second, use each island‚Äôs bird distribution to predict the other two. This means to compute the KL divergence of each island from the others, treating each island as if it were a statistical model of the other islands. You should end up with 6 different KL divergence values. Which island predicts the others best? Why?</p>
</blockquote>
</div>
<p>First, lets compute the entropy for each each island.</p>
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">islands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>island <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Island"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>,
       a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.8</span>, <span class="fl">0.05</span><span class="op">)</span>,
       b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.1</span>, <span class="fl">0.15</span><span class="op">)</span>,
       c <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.05</span>, <span class="fl">0.7</span><span class="op">)</span>,
       d <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.025</span>, <span class="fl">0.05</span><span class="op">)</span>,
       e <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.025</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">island</span>, names_to <span class="op">=</span> <span class="st">"species"</span>, values_to <span class="op">=</span> <span class="st">"prop"</span><span class="op">)</span>

<span class="va">islands</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">island</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">prop</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>entropy <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">prop</span>, <span class="va">calc_entropy</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 √ó 3</span>
<span class="co">#&gt;   island   prop      entropy</span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;list&gt;      &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Island 1 &lt;dbl [5]&gt;   1.61 </span>
<span class="co">#&gt; 2 Island 2 &lt;dbl [5]&gt;   0.743</span>
<span class="co">#&gt; 3 Island 3 &lt;dbl [5]&gt;   0.984</span></code></pre></div>
<p>The first island has the highest entropy. This is expected, because it has the most even distribution of bird species. All species are equally likely, so the observation of any one species is not surprising. In contrast, Island 2 has the lowest entropy. This is because the vast majority of birds on this island are Species A. Therefore, observing a bird that is not from Species A would be surprising.</p>
<p>For the second part of the question, we need to compute the KL divergence for each pair of islands. The KL divergence is defined as:</p>
<p><span class="math display">\[
D_{KL} = \sum_i p_i(\log(p_i) - \log(q_i))
\]</span></p>
<p>We‚Äôll write a function to do this calculation.</p>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d_kl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">p</span>, <span class="va">q</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">p</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Now, let‚Äôs calculate <span class="math inline">\(D_{KL}\)</span> for each set of islands.</p>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html">crossing</a></span><span class="op">(</span>model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Island"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>,
         predicts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Island"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">model</span> <span class="op">!=</span> <span class="va">predicts</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">islands</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"model"</span> <span class="op">=</span> <span class="st">"island"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>model_prop <span class="op">=</span> <span class="va">prop</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">islands</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"predicts"</span> <span class="op">=</span> <span class="st">"island"</span>, <span class="st">"species"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>predict_prop <span class="op">=</span> <span class="va">prop</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">predicts</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>q <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">model_prop</span><span class="op">)</span>,
            p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">predict_prop</span><span class="op">)</span>,
            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>kl_distance <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2_dbl</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">q</span>, <span class="va">d_kl</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 √ó 5</span>
<span class="co">#&gt;   model    predicts q         p         kl_distance</span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;    &lt;list&gt;    &lt;list&gt;          &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Island 1 Island 2 &lt;dbl [5]&gt; &lt;dbl [5]&gt;       0.866</span>
<span class="co">#&gt; 2 Island 1 Island 3 &lt;dbl [5]&gt; &lt;dbl [5]&gt;       0.626</span>
<span class="co">#&gt; 3 Island 2 Island 1 &lt;dbl [5]&gt; &lt;dbl [5]&gt;       0.970</span>
<span class="co">#&gt; 4 Island 2 Island 3 &lt;dbl [5]&gt; &lt;dbl [5]&gt;       1.84 </span>
<span class="co">#&gt; 5 Island 3 Island 1 &lt;dbl [5]&gt; &lt;dbl [5]&gt;       0.639</span>
<span class="co">#&gt; 6 Island 3 Island 2 &lt;dbl [5]&gt; &lt;dbl [5]&gt;       2.01</span></code></pre></div>
<p>These results show us that when using Island 1 to predict Island 2, the KL divergence is about 0.87. When we use Island 1 to predict Island 3, the KL divergence is about 0.63, and so on. Overall, the distances are shorter when we used Island 1 as the model. This is because Island 1 has the highest entropy. Thus, we are less surprised by the other islands, so there‚Äôs a shorter distance. In contrast, Island 2 and Island 3 have very concentrated distributions, so predicting the other islands leads to more surprises, and therefore greater distances.</p>
<div class="question">
<blockquote>
<p><strong>7H4.</strong> Recall the marriage, age, and happiness collider bias example from Chapter 6. Run models <code>m6.9</code> and <code>m6.10</code> again (page 178). Compare these two models using WAIC (or PSIS, they will produce identical results). Which model is expected to make better predictions? Which model provides the correct causal inference about the influence of age on happiness? Can you explain why the answers to these two questions disagree?</p>
</blockquote>
</div>
<p>As a reminder, here is the DAG for this example, where <span class="math inline">\(H\)</span> is happiness, <span class="math inline">\(M\)</span> is marriage, and <span class="math inline">\(A\)</span> is age.</p>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.dagitty.net">dagitty</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/malcolmbarrett/ggdag">ggdag</a></span><span class="op">)</span>

<span class="va">hma_dag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dagitty/man/dagitty.html">dagitty</a></span><span class="op">(</span><span class="st">"dag{H -&gt; M &lt;- A}"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/dagitty/man/coordinates.html">coordinates</a></span><span class="op">(</span><span class="va">hma_dag</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>H <span class="op">=</span> <span class="fl">1</span>, M <span class="op">=</span> <span class="fl">2</span>, A <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,
                             y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>H <span class="op">=</span> <span class="fl">1</span>, M <span class="op">=</span> <span class="fl">1</span>, A <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">hma_dag</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggdag/man/geom_dag_text.html">geom_dag_text</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggdag/man/geom_dag_edges.html">geom_dag_edges</a></span><span class="op">(</span>edge_color <span class="op">=</span> <span class="st">"black"</span>, edge_width <span class="op">=</span> <span class="fl">2</span>,
                 arrow_directed <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/arrow.html">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">15</span>, <span class="st">"pt"</span><span class="op">)</span>,
                                              type <span class="op">=</span> <span class="st">"closed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e7h4-1-1.png" width="40%" style="display: block; margin: auto;"></div>
<p>First, let‚Äôs regenerate the data and estimate the models.</p>
<div class="sourceCode" id="cb167"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">sim_happiness</span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1977</span>, N_years <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">age</span> <span class="op">&gt;</span> <span class="fl">17</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>a <span class="op">=</span> <span class="op">(</span><span class="va">age</span> <span class="op">-</span> <span class="fl">18</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">65</span> <span class="op">-</span> <span class="fl">18</span><span class="op">)</span>,
         mid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">married</span> <span class="op">+</span> <span class="fl">1</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"single"</span>, <span class="st">"married"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">b6.9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">happiness</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">mid</span> <span class="op">+</span> <span class="va">a</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
            prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">midmarried</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">midsingle</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
            iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
            file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"b7h4-6.9"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b6.10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">happiness</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">a</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
             prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
             iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
             file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"b7h4-6.10"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>For the model comparison we‚Äôll use PSIS.</p>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b6.9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b6.9</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="va">b6.10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b6.10</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">b6.9</span>, <span class="va">b6.10</span><span class="op">)</span>
<span class="co">#&gt;       elpd_diff se_diff</span>
<span class="co">#&gt; b6.9     0.0       0.0 </span>
<span class="co">#&gt; b6.10 -194.0      17.6</span></code></pre></div>
<p>PSIS shows a strong preference for <code>b6.9</code>, which is the model that includes both age and marriage status. However, <code>b6.10</code> provides the correct causal inference, as no additional conditioning is needed.</p>
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/dagitty/man/adjustmentSets.html">adjustmentSets</a></span><span class="op">(</span><span class="va">hma_dag</span>, exposure <span class="op">=</span> <span class="st">"A"</span>, outcome <span class="op">=</span> <span class="st">"H"</span><span class="op">)</span>
<span class="co">#&gt;  {}</span></code></pre></div>
<p>The reason is that in this model, marital status is a collider. Adding this variable to the model add a real statistical association between happiness and age, which improves the predictions that are made. However, the association is not causal, so intervening on age (if that were possible), would not actually change happiness. Therefore it‚Äôs important to consider the causal implications of your model before selecting one based on PSIS or WAIC alone.</p>
<div class="question">
<blockquote>
<p><strong>7H5.</strong> Revisit the urban fox data, <code>data(foxes)</code>, from the previous chapter‚Äôs practice problems. Use WAIC or PSIS based model comparison on five different models, each using <code>weight</code> as the outcome, and containing these sets of predictor variables:</p>
</blockquote>
<blockquote>
<ol style="list-style-type: decimal">
<li>
<code>avgfood + groupsize + area</code><br>
</li>
<li>
<code>avgfood + groupsize</code><br>
</li>
<li>
<code>groupsize + area</code><br>
</li>
<li>
<code>avgfood</code><br>
</li>
<li><code>area</code></li>
</ol>
</blockquote>
<blockquote>
<p>Can you explain the relative differences in WAIC scores, using the fox DAG from the previous chapter? Be sure to pay attention to the standard error of the score differences (<code>dSE</code>).</p>
</blockquote>
</div>
<p>First, let‚Äôs estimate the five models.</p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">foxes</span><span class="op">)</span>

<span class="va">fox_dat</span> <span class="op">&lt;-</span> <span class="va">foxes</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">area</span>, <span class="va">avgfood</span>, <span class="va">weight</span>, <span class="va">groupsize</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">standardize</span><span class="op">)</span><span class="op">)</span>

<span class="va">b7h5_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">avgfood</span> <span class="op">+</span> <span class="va">groupsize</span> <span class="op">+</span> <span class="va">area</span>, data <span class="op">=</span> <span class="va">fox_dat</span>,
              family <span class="op">=</span> <span class="va">gaussian</span>,
              prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
              iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
              file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"b7h5_1"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b7h5_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">avgfood</span> <span class="op">+</span> <span class="va">groupsize</span>, data <span class="op">=</span> <span class="va">fox_dat</span>,
              family <span class="op">=</span> <span class="va">gaussian</span>,
              prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
              iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
              file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"b7h5_2"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b7h5_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">groupsize</span> <span class="op">+</span> <span class="va">area</span>, data <span class="op">=</span> <span class="va">fox_dat</span>,
              family <span class="op">=</span> <span class="va">gaussian</span>,
              prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
              iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
              file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"b7h5_3"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b7h5_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">avgfood</span>, data <span class="op">=</span> <span class="va">fox_dat</span>,
              family <span class="op">=</span> <span class="va">gaussian</span>,
              prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
              iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
              file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"b7h5_4"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b7h5_5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">area</span>, data <span class="op">=</span> <span class="va">fox_dat</span>,
              family <span class="op">=</span> <span class="va">gaussian</span>,
              prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
              iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
              file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp7"</span>, <span class="st">"b7h5_5"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Then we can calculate the WAIC for each model and the model comparisons.</p>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b7h5_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b7h5_1</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>
<span class="va">b7h5_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b7h5_2</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>
<span class="va">b7h5_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b7h5_3</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>
<span class="va">b7h5_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b7h5_4</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>
<span class="va">b7h5_5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b7h5_5</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>

<span class="va">comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">b7h5_1</span>, <span class="va">b7h5_2</span>, <span class="va">b7h5_3</span>, <span class="va">b7h5_4</span>, <span class="va">b7h5_5</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>
<span class="va">comp</span>
<span class="co">#&gt;        elpd_diff se_diff</span>
<span class="co">#&gt; b7h5_1  0.0       0.0   </span>
<span class="co">#&gt; b7h5_3 -0.4       1.4   </span>
<span class="co">#&gt; b7h5_2 -0.4       1.7   </span>
<span class="co">#&gt; b7h5_4 -5.2       3.4   </span>
<span class="co">#&gt; b7h5_5 -5.3       3.4</span></code></pre></div>
<p>In general, the models don‚Äôt appear all that different from each other. However, there does seem to be two groups of models: <code>b7h5_1</code>, <code>b7h5_2</code>, and <code>b7h5_3</code> are all nearly identical; and <code>b7h5_4</code> and <code>b7h5_5</code> are nearly identical.</p>
<details><summary>
Code to reproduce
</summary><div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plot_comp</span> <span class="op">&lt;-</span> <span class="va">comp</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"model"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="op">-</span><span class="va">model</span>, <span class="va">as.numeric</span><span class="op">)</span>,
         model <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_inorder</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span>

<span class="va">waic_val</span> <span class="op">&lt;-</span> <span class="va">plot_comp</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">waic</span>, se <span class="op">=</span> <span class="va">se_waic</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>lb <span class="op">=</span> <span class="va">waic</span> <span class="op">-</span> <span class="va">se</span>,
         ub <span class="op">=</span> <span class="va">waic</span> <span class="op">+</span> <span class="va">se</span><span class="op">)</span>

<span class="va">diff_val</span> <span class="op">&lt;-</span> <span class="va">plot_comp</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">waic</span>, se <span class="op">=</span> <span class="va">se_diff</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>se <span class="op">=</span> <span class="va">se</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>lb <span class="op">=</span> <span class="va">waic</span> <span class="op">-</span> <span class="va">se</span>,
         ub <span class="op">=</span> <span class="va">waic</span> <span class="op">+</span> <span class="va">se</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">se</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">waic_val</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">waic</span>, xmin <span class="op">=</span> <span class="va">lb</span>, xmax <span class="op">=</span> <span class="va">ub</span>,
                                                 y <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">diff_val</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">waic</span>, xmin <span class="op">=</span> <span class="va">lb</span>, xmax <span class="op">=</span> <span class="va">ub</span>,
                                                 y <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span>,
                  position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_nudge.html">position_nudge</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">2</span>,
                  color <span class="op">=</span> <span class="st">"#009FB7"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Deviance"</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
</details><div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e7h5-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>To understand why this is, we can return to the DAG for this example.</p>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e7h5-fox-dag-1.png" width="40%" style="display: block; margin: auto;"></div>
<p>The first three models (<code>b7h5_1</code>, <code>b7h5_2</code>, and <code>b7h5_3</code>) all contain <code>groupsize</code> and one or both of <code>area</code> and <code>avgfood</code>. The reason these models is the same is that there are no back-door path from <code>area</code> or <code>avgfood</code> to <code>weight</code>. In other words, the effect of <code>area</code> adjusting for <code>groupsize</code> is the same as the effect of <code>avgfood</code> adjusting for <code>groupsize</code>, because the effect of <code>area</code> is routed entirely through <code>avgfood</code>.</p>
<p>Similarly, the last two models (<code>b7h5_4</code> and <code>b7h5_5</code>) are also nearly identical because of the relationship of <code>area</code> to <code>avgfood</code>. Because the effect of <code>area</code> is routed entirely through <code>avgfood</code>, including only <code>avgfood</code> or <code>area</code> should result in the same inferences.</p>
</div>
<div id="chapter-8" class="section level3" number="4.2.2">
<h3>
<span class="header-section-number">4.2.2</span> Chapter 8<a class="anchor" aria-label="anchor" href="#chapter-8"><i class="fas fa-link"></i></a>
</h3>
<div class="question">
<blockquote>
<p><strong>8E1.</strong> For each of the causal relationships below, name a hypothetical third variable that would lead to an interaction effect.</p>
</blockquote>
<blockquote>
<ol style="list-style-type: decimal">
<li>Bread dough rises because of yeast.</li>
<li>Education leads to higher income.</li>
<li>Gasoline makes a car go.</li>
</ol>
</blockquote>
</div>
<p>For the first, the amount of heat can moderate the relationship between yeast and the amount the dough rises. In the second example, ethnicity may give rise to an interaction, as individuals of some races face more systemic challenges (i.e., it‚Äôs easier for white people with low education to get a job than people of color). Thus, education may have more of an effect for minorities. Finally, a car also requires wheels. Wheels with no gas and gas with no wheels both prevent the car from moving; only with both will the car go.</p>
<div class="question">
<blockquote>
<p><strong>8E2.</strong> Which of the following explanations invokes an interaction?</p>
</blockquote>
<blockquote>
<ol style="list-style-type: decimal">
<li>Caramelizing onions requires cooking over low heat and making sure the onions do not dry out.</li>
<li>A car will go faster when it has more cylinders or when it has better fuel injector.</li>
<li>Most people acquire their political beliefs from their parents, unless they get them instead from their friends.</li>
<li>Intelligent animal species tend to be either highly social or have manipulative appendages (hands, tentacles, etc.).</li>
</ol>
</blockquote>
</div>
<p>The first example is the only one that is, strictly speaking, an interaction. That is, low heat leads to camelization, conditional on the onions not drying out. In the second statement, it is phrased such that either more cylinders or a better fuel injector will result in faster speed. For number three, this is again phrased as an ‚Äúor.‚Äù People acquire beliefs from their parents or their friends. As written, there is nothing to indicate that the influence of the parents‚Äô beliefs depends on the influence of the friends‚Äô beliefs (or vice versa). Finally, the last statement is also phrased as an ‚Äúor.‚Äù There is no indicate that the influence of one factor impacts the influence of the other.</p>
<div class="question">
<blockquote>
<p><strong>8E3.</strong> For each of the explanations in <strong>8E2</strong>, write a linear model that expresses the stated relationship.</p>
</blockquote>
</div>
<p>For onion caramelization, the mathematical model is:</p>
<p><span class="math display">\[
\begin{align}
C_i &amp;\sim \text{Normal}(\mu_i, \sigma) \\
\mu_i &amp;= \alpha + \beta_HH_i + \beta_MM_i + \beta_{HM}H_iM_i
\end{align}
\]</span></p>
<p>The mathematical model for car speed is very similar:</p>
<p><span class="math display">\[
\begin{align}
S_i &amp;\sim \text{Normal}(\mu_i, \sigma) \\
\mu_i &amp;= \alpha + \beta_CC_i + \beta_FF_i
\end{align}
\]</span></p>
<p>There is a similar model for political beliefs:</p>
<p><span class="math display">\[
\begin{align}
B_i &amp;\sim \text{Normal}(\mu_i, \sigma) \\
\mu_i &amp;= \alpha + \beta_PP_i + \beta_FF_i
\end{align}
\]</span></p>
<p>And finally the model for intelligence:</p>
<p><span class="math display">\[
\begin{align}
I_i &amp;\sim \text{Normal}(\mu_i, \sigma) \\
\mu_i &amp;= \alpha + \beta_SS_i + \beta_MM_i
\end{align}
\]</span></p>
<div class="question">
<blockquote>
<p><strong>8M1.</strong> Recall the tulips example from the chapter. Suppose another set of treatments adjusted the temperature in the greenhouse over two levels: cold and hot. The data in the chapter were collected at the cold temperature. You find none of the plants grown under the hot temperature developed any blooms at all, regardless of the water and shade levels. Can you explain this result in terms of interactions between water, shade, and temperature?</p>
</blockquote>
</div>
<p>In the chapter example, we saw that at cool temperatures, the blooms were best predicted by water, shade, and their interaction. Here, we learn that neither water nor light matter at a high temperature. This implies a three-way interaction. Just as in the chapter where water had no effect when there was no light, we see that neither water nor light have an effect when temperature is high.</p>
<div class="question">
<blockquote>
<p><strong>8M2.</strong> Can you invent a regression equation that would make the bloom size zero, whenever the temperature is hot?</p>
</blockquote>
</div>
<p>For this model, we can use the interaction model from the chapter with an additional predictor (<span class="math inline">\(C\)</span>) that is 0 when the temperature is hot and 1 when the temperature is cold.</p>
<p><span class="math display">\[
\begin{align}
B_i &amp;\sim \text{Normal}(\mu_i, \sigma) \\
\mu_i &amp;= C_i \times (\alpha + \beta_WW_i + \beta_SS_i + \beta_{WS}W_iS_i)
\end{align}
\]</span></p>
<div class="question">
<blockquote>
<p><strong>8M3.</strong> In parts of North America, ravens depend upon wolves for their food. This is because ravens are carnivorous but cannot usually kill or open carcasses of prey. Wolves however can and do kill and tear open animals, and they tolerate ravens co-feeding at their kills. This species relationship is generally described as a ‚Äúspecies interaction.‚Äù Can you invent a hypothetical set of data on raven population size in which this relationship would manifest as a statistical interaction? Do you think the biological interaction could be linear? Why or why not?</p>
</blockquote>
</div>
<p>In order to predict raven population size based on wolf population size, we should include data on the territory area for the wolves, the number of wolves, and amount of food available, and finally the number of ravens. This is similar to the types of data included in <code>data(foxes)</code>. I would expect the relationship to be non-linear. When there are no wolves, I would expect there to be no ravens. As the number of wolves increases, the number of ravens would also increase. However, eventually the number of wolves would increase to the point that the wolves exhaust the food supply, leaving no food left for the ravens, at which point the raven population would begin to shrink. Thus, if we created a counter factual plot with wolves on the x-axis and ravens on the y-axis, I would expect to see at linear trend at first, but then the raven population level off or drop when there is a large numbers of wolves.</p>
<div class="question">
<blockquote>
<p><strong>8M4.</strong> Repeat the tulips analysis, but this time use priors that constrain the effect of water to be positive and the effect of shade to be negative. Use prior predictive simulation. What do these prior asumptions mean for the interaction prior, if anything?</p>
</blockquote>
</div>
<p>There are a few issues constraining different coefficients with bounded parameters (especially negative parameters) in {brms}. For some details, see <a href="https://discourse.mc-stan.org/t/negative-prior-distribution/18093/2">this thread</a> on the Stan discourse. To get around this, rather than constrain the shade parameter to be negative, we‚Äôll create a new variable which is the opposite of shade, <code>light</code> and the corresponding <code>light_cent</code>. We can then constrain this parameter to be positive, just as the <code>water_cent</code> parameter is constrained to be positive. Finally, because of the new <code>light</code> variable the positivity constraints on the main effects, we also want to constrain the interaction term to be positive. That is, if both water and light increase, we expect an additional additive effect.</p>
<div class="sourceCode" id="cb173"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">rethinking</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"tulips"</span><span class="op">)</span>

<span class="va">tulip_dat</span> <span class="op">&lt;-</span> <span class="va">tulips</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>light <span class="op">=</span> <span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="va">shade</span>,
         blooms_std <span class="op">=</span> <span class="va">blooms</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">blooms</span><span class="op">)</span>,
         water_cent <span class="op">=</span> <span class="va">water</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">water</span><span class="op">)</span>,
         shade_cent <span class="op">=</span> <span class="va">shade</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">shade</span><span class="op">)</span>,
         light_cent <span class="op">=</span> <span class="va">light</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">light</span><span class="op">)</span><span class="op">)</span>

<span class="va">b8m4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">blooms_std</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">water_cent</span> <span class="op">+</span> <span class="va">light_cent</span> <span class="op">+</span> <span class="va">water_cent</span><span class="op">:</span><span class="va">light_cent</span>,
            data <span class="op">=</span> <span class="va">tulip_dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
            prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.25</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.25</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, lb <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
            iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
            file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp8"</span>, <span class="st">"b8m4"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/fit-method-summary.html">summary</a></span><span class="op">(</span><span class="va">b8m4</span><span class="op">)</span>
<span class="co">#&gt;  Family: gaussian </span>
<span class="co">#&gt;   Links: mu = identity; sigma = identity </span>
<span class="co">#&gt; Formula: blooms_std ~ 1 + water_cent + light_cent + water_cent:light_cent </span>
<span class="co">#&gt;    Data: tulip_dat (Number of observations: 27) </span>
<span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 0; thin = 1;</span>
<span class="co">#&gt;          total post-warmup draws = 8000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Population-Level Effects: </span>
<span class="co">#&gt;                       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS</span>
<span class="co">#&gt; Intercept                 0.36      0.03     0.30     0.41 1.00     7951</span>
<span class="co">#&gt; water_cent                0.21      0.03     0.14     0.27 1.00     7826</span>
<span class="co">#&gt; light_cent                0.11      0.03     0.04     0.18 1.00     5064</span>
<span class="co">#&gt; water_cent:light_cent     0.14      0.04     0.06     0.22 1.00     7552</span>
<span class="co">#&gt;                       Tail_ESS</span>
<span class="co">#&gt; Intercept                 5632</span>
<span class="co">#&gt; water_cent                4256</span>
<span class="co">#&gt; light_cent                2627</span>
<span class="co">#&gt; water_cent:light_cent     3884</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Family Specific Parameters: </span>
<span class="co">#&gt;       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; sigma     0.14      0.02     0.11     0.20 1.00     5469     5185</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span>
<span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></code></pre></div>
<p>Looking at the the posterior predicted blooms, the results are very similar to what we saw in Figure 8.7 from the text. This indicates that the prior constraints did not have a large effect on the predicted values.</p>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_tulip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html">crossing</a></span><span class="op">(</span>water_cent <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span>, 
                      light_cent <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>

<span class="va">points</span> <span class="op">&lt;-</span> <span class="va">tulip_dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html">expand</a></span><span class="op">(</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html">nesting</a></span><span class="op">(</span><span class="va">water_cent</span>, <span class="va">light_cent</span>, <span class="va">blooms_std</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>light_grid <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"light_cent = {light_cent}"</span><span class="op">)</span><span class="op">)</span>

<span class="va">to_string</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/as_labeller.html">as_labeller</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>`-1` <span class="op">=</span> <span class="st">"Light = -1"</span>, `0` <span class="op">=</span> <span class="st">"Light = 0"</span>, 
                           `1` <span class="op">=</span> <span class="st">"Light = 1"</span><span class="op">)</span><span class="op">)</span>

<span class="va">new_tulip</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">b8m4</span>, ndraws <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">water_cent</span>, y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">light_cent</span>, nrow <span class="op">=</span> <span class="fl">1</span>,
             labeller <span class="op">=</span> <span class="va">to_string</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">.draw</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">points</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">blooms_std</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"#009FB7"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Water (centered)"</span>, y <span class="op">=</span> <span class="st">"Blooms (standardized)"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e8m4-2-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>Finally, let‚Äôs look at the prior predictive simulation for this model. Overall the priors might be a little too uninformative, especially for the interaction. The interaction has the most impact in the far right panel of the below figure, and there are many lines that exceed the expected boundaries in this panel.</p>
<div class="sourceCode" id="cb175"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b8m4p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">b8m4</span>, sample_prior <span class="op">=</span> <span class="st">"only"</span>,
                iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp8"</span>, <span class="st">"b8m4p.rds"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; The desired updates require recompiling the model</span>

<span class="va">new_tulip</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">b8m4p</span>, ndraws <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">water_cent</span>, y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">light_cent</span>, nrow <span class="op">=</span> <span class="fl">1</span>,
             labeller <span class="op">=</span> <span class="va">to_string</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">.draw</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Water (centered)"</span>, y <span class="op">=</span> <span class="st">"Blooms (standardized)"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e8m4-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>8H1.</strong> Return to the <code>data(tulips)</code> example in the chapter. Now include the <code>bed</code> variable as a predictor in the interaction model. Don‚Äôt interact <code>bed</code> with the other predictors; just include it as a main effect. Note that <code>bed</code> is categorical. So to use it properly, you will need to either construct dummy variables, or rather an index variable, as explained in Chapter 5.</p>
</blockquote>
</div>
<p>The <code>bed</code> variable is already a factor variable in the <code>tulips</code> data, so we can just add it to the formula in <code><a href="https://rdrr.io/pkg/brms/man/brm.html">brm()</a></code>. To use indicator variables instead of a dummy variable, we remove the separate intercept (i.e., <code>~ 0</code> in the formula below). Because of what‚Äôs coming in the next question, we‚Äôll use <code>light</code> instead of <code>shade</code> for this model also.</p>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b8h1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">blooms_std</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">water_cent</span> <span class="op">+</span> <span class="va">light_cent</span> <span class="op">+</span> <span class="va">bed</span> <span class="op">+</span> 
              <span class="va">water_cent</span><span class="op">:</span><span class="va">light_cent</span>,
            data <span class="op">=</span> <span class="va">tulip_dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
            prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.25</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
            iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
            file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp8"</span>, <span class="st">"b8h1.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/fit-method-summary.html">summary</a></span><span class="op">(</span><span class="va">b8h1</span><span class="op">)</span>
<span class="co">#&gt;  Family: gaussian </span>
<span class="co">#&gt;   Links: mu = identity; sigma = identity </span>
<span class="co">#&gt; Formula: blooms_std ~ 0 + water_cent + light_cent + bed + water_cent:light_cent </span>
<span class="co">#&gt;    Data: tulip_dat (Number of observations: 27) </span>
<span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 0; thin = 1;</span>
<span class="co">#&gt;          total post-warmup draws = 8000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Population-Level Effects: </span>
<span class="co">#&gt;                       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS</span>
<span class="co">#&gt; water_cent                0.21      0.03     0.14     0.27 1.00    11367</span>
<span class="co">#&gt; light_cent                0.11      0.03     0.05     0.17 1.00    12221</span>
<span class="co">#&gt; beda                      0.26      0.04     0.17     0.35 1.00    12912</span>
<span class="co">#&gt; bedb                      0.38      0.04     0.29     0.47 1.00    12297</span>
<span class="co">#&gt; bedc                      0.40      0.04     0.31     0.48 1.00    12459</span>
<span class="co">#&gt; water_cent:light_cent     0.14      0.04     0.07     0.22 1.00    12903</span>
<span class="co">#&gt;                       Tail_ESS</span>
<span class="co">#&gt; water_cent                6156</span>
<span class="co">#&gt; light_cent                6045</span>
<span class="co">#&gt; beda                      5953</span>
<span class="co">#&gt; bedb                      5615</span>
<span class="co">#&gt; bedc                      5556</span>
<span class="co">#&gt; water_cent:light_cent     6107</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Family Specific Parameters: </span>
<span class="co">#&gt;       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; sigma     0.13      0.02     0.10     0.18 1.00     6707     5592</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span>
<span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>8H2.</strong> Use WAIC to compare the model from <strong>8H1</strong> to a model that omits <code>bed</code>. What do you infer from this comparison? Can you reconcile the WAIC results with the posterior distribution of the <code>bed</code> coefficients?</p>
</blockquote>
</div>
<p>For the comparison, we‚Äôll compare <code>b8h1</code> to the model <code>b8m4</code>, which is the model from the chapter, with new prior distributions that constrain the main effect of water to be positive and the main effect of shade to be negative (i.e., the main effect of light is positive).</p>
<p>Model <code>b8h1</code> is the preferred model; however, the standard error of the difference is larger than the magnitude of the difference, indicating that the WAIC is not able to meaningfully differentiate between the two models. For predictive purposes, this means that the inclusion of the <code>bed</code> variable does not significantly improve the model. It should also be noted that both of the models have some exceptionally large penalty values, so these analyses may be unreliable, and we should consider re-fitting the models with a distribution with fatter tails.</p>
<div class="sourceCode" id="cb177"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b8m4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b8m4</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>
<span class="va">b8h1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b8h1</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">b8m4</span>, <span class="va">b8h1</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt;      elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic  se_waic</span>
<span class="co">#&gt; b8h1   0.0       0.0    13.7       3.3          6.2    1.4     -27.3   6.6  </span>
<span class="co">#&gt; b8m4  -1.2       3.0    12.5       3.8          4.3    1.1     -24.9   7.6</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>8H3.</strong> Consider again the <code>data(rugged)</code> data on economic development and terrain ruggedness, examined in this chapter. One of the African countries in that example Seychelles, is far outside the cloud of other nations, being a rare country with both relatively high GDP and high ruggedness. Seychelles is also unusual, in that it is a group of islands far from the coast of mainland Africa, and its main economic activity is tourism.</p>
</blockquote>
<blockquote>
<ol style="list-style-type: lower-alpha">
<li>Focus on model <code>m8.5</code> from the chapter. Use WAIC pointwise penalties and PSIS Pareto <em>k</em> values to measure relative influence of each country. By these criteria, is Seychelles influencing the results? Are there other nations that are relatively influential? If so, can you explain why?</li>
<li>Now use robust regression, as described in the previous chapter. Modify <code>m8.5</code> to se a Student-t distribution with <span class="math inline">\(\nu = 2\)</span>. Does this change the results in a substantial way?</li>
</ol>
</blockquote>
</div>
<p>In the text, model <code>m8.5</code> uses the tulips data, so I‚Äôm assuming this is a typo and we should be looking at model <code>m8.3</code>, which is the interaction model from the terrain ruggedness example in the chapter. So, let‚Äôs first create a {brms} version of model <code>m8.3</code>.</p>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"rugged"</span><span class="op">)</span>
<span class="va">rugged_dat</span> <span class="op">&lt;-</span> <span class="va">rugged</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">country</span>, <span class="va">rgdppc_2000</span>, <span class="va">rugged</span>, <span class="va">cont_africa</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">rgdppc_2000</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>log_gdp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">rgdppc_2000</span><span class="op">)</span>,
         log_gdp_std <span class="op">=</span> <span class="va">log_gdp</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">log_gdp</span><span class="op">)</span>,
         rugged_std <span class="op">=</span> <span class="va">rugged</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">rugged</span><span class="op">)</span>,
         rugged_std_cent <span class="op">=</span> <span class="va">rugged_std</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">rugged_std</span><span class="op">)</span>,
         cid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">cont_africa</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
                      labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"African"</span>, <span class="st">"Not African"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">b8h3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">log_gdp_std</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">*</span> <span class="va">rugged_std_cent</span>,
     <span class="va">a</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">cid</span>,
     <span class="va">b</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">cid</span>,
     nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  data <span class="op">=</span> <span class="va">rugged_dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidAfrican</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidNotAfrican</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidAfrican</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidNotAfrican</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
  iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
  file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp8"</span>, <span class="st">"b8h3.rds"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">b8h3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b8h3</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"loo"</span>, <span class="st">"waic"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/fit-method-summary.html">summary</a></span><span class="op">(</span><span class="va">b8h3</span><span class="op">)</span>
<span class="co">#&gt;  Family: gaussian </span>
<span class="co">#&gt;   Links: mu = identity; sigma = identity </span>
<span class="co">#&gt; Formula: log_gdp_std ~ 0 + a + b * rugged_std_cent </span>
<span class="co">#&gt;          a ~ 0 + cid</span>
<span class="co">#&gt;          b ~ 0 + cid</span>
<span class="co">#&gt;    Data: rugged_dat (Number of observations: 170) </span>
<span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 0; thin = 1;</span>
<span class="co">#&gt;          total post-warmup draws = 8000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Population-Level Effects: </span>
<span class="co">#&gt;                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; a_cidAfrican        0.89      0.02     0.85     0.92 1.00     9876     6334</span>
<span class="co">#&gt; a_cidNotAfrican     1.05      0.01     1.03     1.07 1.00    10083     6572</span>
<span class="co">#&gt; b_cidAfrican        0.13      0.08    -0.02     0.28 1.00     9543     6356</span>
<span class="co">#&gt; b_cidNotAfrican    -0.14      0.05    -0.25    -0.04 1.00     9485     6149</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Family Specific Parameters: </span>
<span class="co">#&gt;       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; sigma     0.11      0.01     0.10     0.12 1.00     8960     6057</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span>
<span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></code></pre></div>
<p>Now let‚Äôs take a look at the Pareto <em>k</em> and <span class="math inline">\(p_{\Tiny\text{WAIC}}\)</span> values from the model. Seychelles does appear to be influential. The Pareto <span class="math inline">\(k\)</span> value is not above the above the 0.7 threshold; however, the <span class="math inline">\(p_{\Tiny\text{WAIC}}\)</span> value is above the 0.4 threshold. No other countries have Pareto <em>k</em> or <span class="math inline">\(p_{\Tiny\text{WAIC}}\)</span> values over the thresholds.</p>
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/yutannihilation/gghighlight/">gghighlight</a></span><span class="op">)</span>

<span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>pareto_k <span class="op">=</span> <span class="va">b8h3</span><span class="op">$</span><span class="va">criteria</span><span class="op">$</span><span class="va">loo</span><span class="op">$</span><span class="va">diagnostics</span><span class="op">$</span><span class="va">pareto_k</span>,
       p_waic <span class="op">=</span> <span class="va">b8h3</span><span class="op">$</span><span class="va">criteria</span><span class="op">$</span><span class="va">waic</span><span class="op">$</span><span class="va">pointwise</span><span class="op">[</span>, <span class="st">"p_waic"</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rowid_to_column</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">"obs"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">rugged_dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">country</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rowid_to_column</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">"obs"</span><span class="op">)</span>,
            by <span class="op">=</span> <span class="st">"obs"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">pareto_k</span>, y <span class="op">=</span> <span class="va">p_waic</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.7</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.4</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/gghighlight.html">gghighlight</a></span><span class="op">(</span><span class="va">pareto_k</span> <span class="op">&gt;</span> <span class="fl">0.7</span> <span class="op">|</span> <span class="va">p_waic</span> <span class="op">&gt;</span> <span class="fl">0.4</span>, n <span class="op">=</span> <span class="fl">1</span>, label_key <span class="op">=</span> <span class="va">country</span>,
              label_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Pareto *k*"</span>, y <span class="op">=</span> <span class="st">"p&lt;sub&gt;WAIC&lt;/sub&gt;"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e8h3-2-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>Now for part (b), we‚Äôll use a Student-t distribution with <span class="math inline">\(\nu = 2\)</span>.</p>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b8h3_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">log_gdp_std</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">*</span> <span class="va">rugged_std_cent</span>,
     <span class="va">a</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">cid</span>,
     <span class="va">b</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">cid</span>,
     nu <span class="op">=</span> <span class="fl">2</span>,
     nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  data <span class="op">=</span> <span class="va">rugged_dat</span>, family <span class="op">=</span> <span class="va">student</span>,
  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidAfrican</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidNotAfrican</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidAfrican</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidNotAfrican</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
  iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
  file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp8"</span>, <span class="st">"b8h3_t.rds"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">b8h3_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b8h3_t</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"loo"</span>, <span class="st">"waic"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>How much does the Student‚Äôs <em>t</em> distribution affect our model? Let‚Äôs look at the posterior distribution of the difference between African and Non-African countries. In the Student‚Äôs <em>t</em> model, the difference actually increased on average. This is because switching the distribution affects all points, not just the high leverage points that were flagged originally. Therefore, it‚Äôs not unexpected that the distribution might shift.</p>
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/spread_draws.html">spread_draws</a></span><span class="op">(</span><span class="va">b8h3</span>, <span class="va">b_b_cidAfrican</span>, <span class="va">b_b_cidNotAfrican</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="va">b_b_cidAfrican</span> <span class="op">-</span> <span class="va">b_b_cidNotAfrican</span><span class="op">)</span>

<span class="va">t_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/spread_draws.html">spread_draws</a></span><span class="op">(</span><span class="va">b8h3_t</span>, <span class="va">b_b_cidAfrican</span>, <span class="va">b_b_cidNotAfrican</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="va">b_b_cidAfrican</span> <span class="op">-</span> <span class="va">b_b_cidNotAfrican</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">n_diff</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">diff</span>, fill <span class="op">=</span> <span class="st">"Normal"</span><span class="op">)</span>,
               color <span class="op">=</span> <span class="cn">NA</span>, alpha <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">t_diff</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">diff</span>, fill <span class="op">=</span> <span class="st">"Student's *t*"</span><span class="op">)</span>,
               color <span class="op">=</span> <span class="cn">NA</span>, alpha <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#009FB7"</span>, <span class="st">"#FED766"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"African &amp;minus; Non-African"</span>, y <span class="op">=</span> <span class="st">"Density"</span>, fill <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e8h3-4-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question code-question">
<blockquote>
<p><strong>8H4.</strong> The values in <code>data(nettle)</code> are data on language diversity in 74 nations.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Data from &lt;span class="citation"&gt;Nettle (&lt;a href="references.html#ref-nettle1998" role="doc-biblioref"&gt;1998&lt;/a&gt;)&lt;/span&gt;&lt;/p&gt;'><sup>1</sup></a> The meaning of each column is given below.</p>
</blockquote>
<blockquote>
<ol style="list-style-type: decimal">
<li>
<code>country</code>: Name of the country</li>
<li>
<code>num.lang</code>: Number of recognized languages spoken</li>
<li>
<code>area</code>: Area in square kilometers</li>
<li>
<code>k.pop</code>: Population, in thousands</li>
<li>
<code>num.stations</code>: Number of weather stations that provided data for the next two columns</li>
<li>
<code>mean.growing.season</code>: Average length of growing season, in months</li>
<li>
<code>sd.growing.season</code>: Standard deviation of length of growing season, in months</li>
</ol>
</blockquote>
<blockquote>
<p>Use these data to evaluate the hypothesis that language diversity is partly a product of food security. The notion is that, in productive ecologies, people don‚Äôt need large social networks to buffer them against risk of food shortfalls. The means cultural groups can be smaller and more self-sufficient, leading to more languages per capita. Use the number of languages per capita as the outcome:</p>
</blockquote>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d</span><span class="op">$</span><span class="va">lang.per.cap</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="va">num.lang</span> <span class="op">/</span> <span class="va">d</span><span class="op">$</span><span class="va">k.pop</span></code></pre></div>
<blockquote>
<p>Use the logarithm of this new variable as your regression outcome. (A count model would be better here, but you‚Äôll learn those later, in Chapter 11.) This problem is open ended, allowing you to decide how you address the hypotheses and the uncertain advice the modeling provides. If you think you need to use WAIC anyplace, please do. If you think you need certain priors, argue for them. If you think you need to plot predictions in a certain way, please do. Just try to honestly evaluate the main effects of both <code>mean.growing.season</code> and <code>sd.growing.season</code>, as well as their two-way interaction. Here are three parts to help.</p>
</blockquote>
<blockquote>
<ol style="list-style-type: lower-alpha">
<li>Evaluate the hypothesis that language diversity, as measured by <code>log(lang.per.cap)</code>, is positively associated with average length of the growing season, <code>mean.growing.season</code>. Consider <code>log(area)</code> in your regression(s) as a covariate (not an interaction). Interpret your results.</li>
</ol>
</blockquote>
</div>
<p>First, let‚Äôs calculate some new variables we‚Äôll need for these models. We‚Äôll also go ahead and standardize everything to make setting the priors a little bit easier.</p>
<div class="sourceCode" id="cb183"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">nettle</span><span class="op">)</span>

<span class="va">nettle</span> <span class="op">&lt;-</span> <span class="va">nettle</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>lang_per_cap <span class="op">=</span> <span class="va">num.lang</span> <span class="op">/</span> <span class="va">k.pop</span>,
         log_lang_per_cap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">lang_per_cap</span><span class="op">)</span>,
         log_area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">area</span><span class="op">)</span>,
         lang_per_cap_std <span class="op">=</span> <span class="fu">standardize</span><span class="op">(</span><span class="va">log_lang_per_cap</span><span class="op">)</span>,
         area_std <span class="op">=</span> <span class="fu">standardize</span><span class="op">(</span><span class="va">log_area</span><span class="op">)</span>,
         mean_growing_std <span class="op">=</span> <span class="fu">standardize</span><span class="op">(</span><span class="va">mean.growing.season</span><span class="op">)</span>,
         sd_growing_std <span class="op">=</span> <span class="fu">standardize</span><span class="op">(</span><span class="va">sd.growing.season</span><span class="op">)</span><span class="op">)</span>

<span class="va">nettle</span>
<span class="co">#&gt; # A tibble: 74 √ó 14</span>
<span class="co">#&gt;    country num.lang   area  k.pop num.stations mean.growing.se‚Ä¶ sd.growing.seas‚Ä¶</span>
<span class="co">#&gt;    &lt;fct&gt;      &lt;int&gt;  &lt;int&gt;  &lt;int&gt;        &lt;int&gt;            &lt;dbl&gt;            &lt;dbl&gt;</span>
<span class="co">#&gt;  1 Algeria       18 2.38e6  25660          102             6.6              2.29</span>
<span class="co">#&gt;  2 Angola        42 1.25e6  10303           50             6.22             1.87</span>
<span class="co">#&gt;  3 Austra‚Ä¶      234 7.71e6  17336          134             6                4.17</span>
<span class="co">#&gt;  4 Bangla‚Ä¶       37 1.44e5 118745           20             7.4              0.73</span>
<span class="co">#&gt;  5 Benin         52 1.13e5   4889            7             7.14             0.99</span>
<span class="co">#&gt;  6 Bolivia       38 1.10e6   7612           48             6.92             2.5 </span>
<span class="co">#&gt;  7 Botswa‚Ä¶       27 5.82e5   1348           10             4.6              1.69</span>
<span class="co">#&gt;  8 Brazil       209 8.51e6 153322          245             9.71             5.87</span>
<span class="co">#&gt;  9 Burkin‚Ä¶       75 2.74e5   9242            6             5.17             1.07</span>
<span class="co">#&gt; 10 CAR           94 6.23e5   3127           13             8.08             1.21</span>
<span class="co">#&gt; # ‚Ä¶ with 64 more rows, and 7 more variables: lang_per_cap &lt;dbl&gt;,</span>
<span class="co">#&gt; #   log_lang_per_cap &lt;dbl&gt;, log_area &lt;dbl&gt;, lang_per_cap_std &lt;dbl&gt;,</span>
<span class="co">#&gt; #   area_std &lt;dbl&gt;, mean_growing_std &lt;dbl&gt;, sd_growing_std &lt;dbl&gt;</span></code></pre></div>
<p>We‚Äôll start by fitting two models, one with only <code>mean_growing_std</code> as a predictor, and one that also includes <code>area_std</code>. We can then compare the models using PSIS-LOO.</p>
<div class="sourceCode" id="cb184"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b8h4a_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">lang_per_cap_std</span> <span class="op">~</span> <span class="va">mean_growing_std</span>,
               data <span class="op">=</span> <span class="va">nettle</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
               prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                         <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                         <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
               iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
               file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp8"</span>, <span class="st">"b8h4a_1.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b8h4a_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">lang_per_cap_std</span> <span class="op">~</span> <span class="va">mean_growing_std</span> <span class="op">+</span> <span class="va">area_std</span>,
               data <span class="op">=</span> <span class="va">nettle</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
               prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                         <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                         <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
               iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
               file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp8"</span>, <span class="st">"b8h4a_2.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b8h4a_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b8h4a_1</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="va">b8h4a_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b8h4a_2</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">b8h4a_1</span>, <span class="va">b8h4a_2</span><span class="op">)</span>
<span class="co">#&gt;         elpd_diff se_diff</span>
<span class="co">#&gt; b8h4a_1  0.0       0.0   </span>
<span class="co">#&gt; b8h4a_2 -0.1       1.6</span></code></pre></div>
<p>We see that the model without area is slightly preferred, but PSIS-LOO isn‚Äôt really able to distinguish between the models very well. For the purpose of this exercise, we‚Äôll continue with model <code>b8h4a_2</code>, which includes both predictors. Visualizing the model, we see that, as expected given the model comparisons, area doesn‚Äôt appear to have much impact. However, there does appear to be a positive relationship between the the mean growing season and the number of languages.</p>
<div class="sourceCode" id="cb185"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_nettle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html">crossing</a></span><span class="op">(</span>area_std <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="fl">4</span>, by <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,
                       mean_growing_std <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="fl">4</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
                       sd_growing_std <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="fl">4</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

<span class="va">to_string</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/as_labeller.html">as_labeller</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>`-4` <span class="op">=</span> <span class="st">"Area = -4"</span>, `-2` <span class="op">=</span> <span class="st">"Area = -2"</span>,
                           `0` <span class="op">=</span> <span class="st">"Area = 0"</span>, 
                           `2` <span class="op">=</span> <span class="st">"Area = 2"</span>, `4` <span class="op">=</span> <span class="st">"Area = 4"</span><span class="op">)</span><span class="op">)</span>

<span class="va">new_nettle</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">b8h4a_2</span>, ndraws <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">mean_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mean_growing_std</span>, y <span class="op">=</span> <span class="va">.epred</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">area_std</span>, nrow <span class="op">=</span> <span class="fl">1</span>, labeller <span class="op">=</span> <span class="va">to_string</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/geom_lineribbon.html">geom_lineribbon</a></span><span class="op">(</span>color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu">ramp_blue</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">0.2</span>, length.out <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,
                    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0.67"</span>, <span class="st">"0.89"</span>, <span class="st">"0.97"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Mean Growing Season (standardized)"</span>,
       y <span class="op">=</span> <span class="st">"Log Languages per Capita (standardized)"</span>,
       fill <span class="op">=</span> <span class="st">"Interval"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e8h4-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<ol start="2" style="list-style-type: lower-alpha">
<li>Now evaluate the hypothesis that language diversity is negatively associated with the standard deviation of length of growing season, <code>sd.growing.season</code>. This hypothesis follows from uncertainty in harvest favoring social insurance through larger social networks and therefore fewer languages. Again, consider <code>log(area)</code> as a covariate (not an interaction). Interpret your results.</li>
</ol>
</blockquote>
</div>
<p>For the second part, we replace <code>mean_growing_std</code> with <code>sd_growing_std</code>. Again, we‚Äôll fit two models and compare with PSIS-LOO.</p>
<div class="sourceCode" id="cb186"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b8h4b_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">lang_per_cap_std</span> <span class="op">~</span> <span class="va">sd_growing_std</span>,
               data <span class="op">=</span> <span class="va">nettle</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
               prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                         <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                         <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
               iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
               file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp8"</span>, <span class="st">"b8h4b_1.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b8h4b_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">lang_per_cap_std</span> <span class="op">~</span> <span class="va">sd_growing_std</span> <span class="op">+</span> <span class="va">area_std</span>,
               data <span class="op">=</span> <span class="va">nettle</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
               prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                         <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                         <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
               iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
               file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp8"</span>, <span class="st">"b8h4b_2.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b8h4b_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b8h4b_1</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="va">b8h4b_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b8h4b_2</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">b8h4b_1</span>, <span class="va">b8h4b_2</span><span class="op">)</span>
<span class="co">#&gt;         elpd_diff se_diff</span>
<span class="co">#&gt; b8h4b_1 0.0       0.0    </span>
<span class="co">#&gt; b8h4b_2 0.0       1.7</span></code></pre></div>
<p>The story here is much the same. PSIS-LOO can‚Äôt really differentiate between the two models, indicating that area doesn‚Äôt add too much information. This is again reflected in the visualization. We see that the expected distribution of regression lines is fairly similar for all levels of area. Additionally, we do see a negative relationship between the standard deviation of the growing season and the number of languages, as the question suggested.</p>
<div class="sourceCode" id="cb187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_nettle</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">b8h4b_2</span>, ndraws <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">mean_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sd_growing_std</span>, y <span class="op">=</span> <span class="va">.epred</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">area_std</span>, nrow <span class="op">=</span> <span class="fl">1</span>, labeller <span class="op">=</span> <span class="va">to_string</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/geom_lineribbon.html">geom_lineribbon</a></span><span class="op">(</span>color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu">ramp_blue</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">0.2</span>, length.out <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,
                    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0.67"</span>, <span class="st">"0.89"</span>, <span class="st">"0.97"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Standard Deviation of Growing Season (standardized)"</span>,
       y <span class="op">=</span> <span class="st">"Log Languages per Capita (standardized)"</span>,
       fill <span class="op">=</span> <span class="st">"Interval"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e8h4-5-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<ol start="3" style="list-style-type: lower-alpha">
<li>Finally, evaluate the hypothesis that <code>mean.growing.season</code> and <code>sd.growing.season</code> interact to synergistically reduce language diversity. The idea is that, in nations with longer average growing seasons, high variance makes storage and redistribution even more important than it would be otherwise. That way, people can cooperate to preserve and protect windfalls to be used during the droughts.</li>
</ol>
</blockquote>
</div>
<p>In the third part of the question, we are asked to add the interaction term. We‚Äôll drop area since it does not appear to have an effect in either of the previous parts of this question.</p>
<div class="sourceCode" id="cb188"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b8h4_c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">lang_per_cap_std</span> <span class="op">~</span> <span class="va">mean_growing_std</span> <span class="op">*</span> <span class="va">sd_growing_std</span>,
              data <span class="op">=</span> <span class="va">nettle</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
              prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
              iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
              file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp8"</span>, <span class="st">"b8h4_c.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/fit-method-summary.html">summary</a></span><span class="op">(</span><span class="va">b8h4_c</span><span class="op">)</span>
<span class="co">#&gt;  Family: gaussian </span>
<span class="co">#&gt;   Links: mu = identity; sigma = identity </span>
<span class="co">#&gt; Formula: lang_per_cap_std ~ mean_growing_std * sd_growing_std </span>
<span class="co">#&gt;    Data: nettle (Number of observations: 74) </span>
<span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 0; thin = 1;</span>
<span class="co">#&gt;          total post-warmup draws = 8000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Population-Level Effects: </span>
<span class="co">#&gt;                                 Estimate Est.Error l-95% CI u-95% CI Rhat</span>
<span class="co">#&gt; Intercept                           0.00      0.09    -0.18     0.19 1.00</span>
<span class="co">#&gt; mean_growing_std                    0.23      0.11     0.01     0.46 1.00</span>
<span class="co">#&gt; sd_growing_std                     -0.23      0.10    -0.43    -0.03 1.00</span>
<span class="co">#&gt; mean_growing_std:sd_growing_std    -0.24      0.11    -0.44    -0.03 1.00</span>
<span class="co">#&gt;                                 Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; Intercept                           8427     5784</span>
<span class="co">#&gt; mean_growing_std                    7513     6080</span>
<span class="co">#&gt; sd_growing_std                      9774     5790</span>
<span class="co">#&gt; mean_growing_std:sd_growing_std     8652     6050</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Family Specific Parameters: </span>
<span class="co">#&gt;       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span class="co">#&gt; sigma     0.89      0.08     0.75     1.06 1.00     7972     5945</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span>
<span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></code></pre></div>
<p>We see that the interaction is negative. What this means can be seen by visualizing the interaction from both directions. This is shown in the following image. In the top row, we plot the expected effect of mean growing season on languages. We see that there is a positive relationship between mean growing season and languages, except when there is high variance in the growing. Similarly, the bottom row shows the expected effect of standard deviation of the growing season on languages. When the mean growing season is short, there is no effect of the variance on languages. When the mean growing season is long, there is a negative relationship between variance and languages.</p>
<details><summary>
Code to reproduce
</summary><div class="sourceCode" id="cb189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>

<span class="va">new_nettle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html">crossing</a></span><span class="op">(</span>mean_growing_std <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span>, by <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,
                       sd_growing_std <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">4</span>, by <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>

<span class="va">int_preds</span> <span class="op">&lt;-</span> <span class="va">new_nettle</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">b8h4_c</span>, ndraws <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">mean_qi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fl">0.97</span><span class="op">)</span>

<span class="va">facet_levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span>, by <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">sd_facets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/along.html">list_along</a></span><span class="op">(</span><span class="va">facet_levels</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">sd_facets</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">points</span> <span class="op">&lt;-</span> <span class="va">nettle</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="va">sd_growing_std</span> <span class="op">-</span> <span class="va">facet_levels</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
  
  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">int_preds</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">sd_growing_std</span> <span class="op">==</span> <span class="va">facet_levels</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mean_growing_std</span>, y <span class="op">=</span> <span class="va">.epred</span>, ymin <span class="op">=</span> <span class="va">.lower</span>,
               ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/geom_lineribbon.html">geom_lineribbon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#99D8E2"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">points</span>,
               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mean_growing_std</span>, y <span class="op">=</span> <span class="va">lang_per_cap_std</span>,
                   alpha <span class="op">=</span> <span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">diff</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span>,
               inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expand_limits.html">expand_limits</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="fl">3.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Mean growing season"</span>, y <span class="op">=</span> <span class="st">"Languages"</span>,
         subtitle <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"SD growing season = {facet_levels[i]}"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span>
      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span>, <span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span>
      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="va">sd_facets</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span>
<span class="op">}</span>

<span class="va">mean_facets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/along.html">list_along</a></span><span class="op">(</span><span class="va">facet_levels</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">mean_facets</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">points</span> <span class="op">&lt;-</span> <span class="va">nettle</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="va">mean_growing_std</span> <span class="op">-</span> <span class="va">facet_levels</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
  
  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">int_preds</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">mean_growing_std</span> <span class="op">==</span> <span class="va">facet_levels</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sd_growing_std</span>, y <span class="op">=</span> <span class="va">.epred</span>, ymin <span class="op">=</span> <span class="va">.lower</span>,
               ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/geom_lineribbon.html">geom_lineribbon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#99D8E2"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">points</span>,
               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sd_growing_std</span>, y <span class="op">=</span> <span class="va">lang_per_cap_std</span>,
                   alpha <span class="op">=</span> <span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">diff</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span>,
               inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expand_limits.html">expand_limits</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="fl">3.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"SD growing season"</span>, y <span class="op">=</span> <span class="st">"Languages"</span>,
         subtitle <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"Mean growing season = {facet_levels[i]}"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span>
      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">20</span>, <span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span>
      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="va">mean_facets</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p</span>
<span class="op">}</span>

<span class="va">sd_patch</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">sd_facets</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">|</span> <span class="va">sd_facets</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">|</span> <span class="va">sd_facets</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="va">mean_patch</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">mean_facets</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">|</span> <span class="va">mean_facets</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">|</span> <span class="va">mean_facets</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>

<span class="va">sd_patch</span> <span class="op">/</span> <span class="va">mean_patch</span></code></pre></div>
</details><div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e8h4-7-1.png" width="100%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>8H5.</strong> Consider the <code>data(Wines2012)</code> data table. These data are expert ratings of 20 different French and American wines by 9 different French and American judges. Your goal is to model <code>score</code>, the subjective rating assigned by each judge to each wine. I recommend standardizing it. In this problem, consider only variation among judges and wines. Construct index variables of <code>judge</code> and <code>wine</code> and then use these index variables to construct a linear regression model. Justify your priors. You should end up with 9 judge parameters and 20 wine parameters. How do you interpret the variation among individual judges and individual wines? Do you notice any patterns, just by plotting the differences? Which judges gave the highest/lowest ratings? Which wines were rated worst/best on average?</p>
</blockquote>
</div>
<p>First, let‚Äôs prepare the data. We‚Äôll standardize the score and create index variables for both <code>judge</code> and <code>wine</code>.</p>
<div class="sourceCode" id="cb190"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Wines2012</span><span class="op">)</span>

<span class="va">wine</span> <span class="op">&lt;-</span> <span class="va">Wines2012</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>score_std <span class="op">=</span> <span class="fu">standardize</span><span class="op">(</span><span class="va">score</span><span class="op">)</span>,
         judge_ind <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">judge</span><span class="op">)</span><span class="op">)</span>,
         wine_ind <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">wine</span><span class="op">)</span><span class="op">)</span>,
         red <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">flight</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span>,
         wine_amer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">wine.amer</span><span class="op">)</span>,
         judge_amer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">judge.amer</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Next, we‚Äôll fit the model, remembering to remove the overall intercept (i.e., <code>~ 0</code>) so that the index variables are estimated correctly. Because the scores have been standardized, we can use the <code>normal(0, 0.5)</code> prior we‚Äôve used previously and which is used throughout much of the text. We‚Äôll also extract the posterior draws so that we can explore the posterior for each judge and wine individually.</p>
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b8h5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">score_std</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">j</span> <span class="op">+</span> <span class="va">w</span>,
               <span class="va">j</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">judge_ind</span>,
               <span class="va">w</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">wine_ind</span>,
               nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
            data <span class="op">=</span> <span class="va">wine</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
            prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">j</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">w</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
            iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
            file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp8"</span>, <span class="st">"b8h5.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">b8h5</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sigma</span>, <span class="op">-</span><span class="va">lp__</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">.chain</span>, <span class="va">.iteration</span>, <span class="va">.draw</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, <span class="st">"type"</span>, <span class="st">"num"</span><span class="op">)</span>, names_sep <span class="op">=</span> <span class="st">"_"</span>,
               values_to <span class="op">=</span> <span class="st">"value"</span>, <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>num <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">num</span>, <span class="st">"ind"</span>, <span class="st">""</span><span class="op">)</span>,
         num <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">num</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Looking at the distributions by judge, we can see that John Foy tends to give the highest scores, whereas Robert Hodgson and Jean-M Cardebat give the lowest scores on average.</p>
<div class="sourceCode" id="cb192"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">draws</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"judge"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>num <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">num</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">wine</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">judge</span>, <span class="va">judge_ind</span><span class="op">)</span>,
            by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"num"</span> <span class="op">=</span> <span class="st">"judge_ind"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">judge</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">judge</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_hdci</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">judge</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">value</span>, xmin <span class="op">=</span> <span class="va">.lower</span>, xmax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/geom_interval.html">geom_interval</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu">ramp_blue</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">0.1</span>, length.out <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,
                     limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="cn">NULL</span>, x <span class="op">=</span> <span class="st">"Parameter Value"</span>, color <span class="op">=</span> <span class="st">"Interval"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/b8h5-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>For wines, B2, J2, D2, D1, and B1 received the highest scores on average, and wine I2 was clearly the lowest rated of the wines. However, overall, there is more variability among the judges than among the wines.</p>
<div class="sourceCode" id="cb193"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">draws</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"wine"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>num <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">num</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">wine</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">wine</span>, <span class="va">wine_ind</span><span class="op">)</span>,
            by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"num"</span> <span class="op">=</span> <span class="st">"wine_ind"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">wine</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">wine</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_hdci</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html">fct_rev</a></span><span class="op">(</span><span class="va">wine</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">value</span>, xmin <span class="op">=</span> <span class="va">.lower</span>, xmax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/geom_interval.html">geom_interval</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu">ramp_blue</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">0.1</span>, length.out <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,
                     limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="cn">NULL</span>, x <span class="op">=</span> <span class="st">"Parameter Value"</span>, color <span class="op">=</span> <span class="st">"Interval"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/b8h5-4-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>8H6.</strong> Now consider three features of the wines and judges:</p>
</blockquote>
<blockquote>
<ol style="list-style-type: decimal">
<li>
<code>flight</code>: Whether the wine is red or white.</li>
<li>
<code>wine.amer</code>: Indicator variable for American wines.</li>
<li>
<code>judge.amer</code>: Indicator variable for American judges.</li>
</ol>
</blockquote>
<blockquote>
<p>Use indicator or index variables to model the influence of these features on the scores. Omit the individual judge and wine index variables from Problem 1. Do not include interaction effects yet. Again justify your priors What do you conclude about the differences among the wines and judges? Try to relate the results to the inferences in the previous problem.</p>
</blockquote>
</div>
<p>We can estimate the {brms} model as defined below. In this definition, we‚Äôre using indicator variables rather than index variables, as that will make the next question a little bit easier. We‚Äôll use our standard <code>normal(0, 0.2)</code> prior for the intercept, since that will have to be near zero given that the <code>score</code> has been standardized. For the coefficients, we have to ask what a reasonable difference in scores would be between New Jersey and French wines, New Jersey and French judges, and red and white wine. One standard deviation seems to be the edge of what might be reasonable, so we‚Äôll use <code>normal(0, 0.5)</code>, as that will leave sufficient probability in the tails. These priors constrain the space to plausible values, but we could probably use tighter priors on the slope parameters if we wanted to get more regularization.</p>
<div class="sourceCode" id="cb194"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b8h6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">score_std</span> <span class="op">~</span> <span class="va">wine_amer</span> <span class="op">+</span> <span class="va">judge_amer</span> <span class="op">+</span> <span class="va">red</span>,
            data <span class="op">=</span> <span class="va">wine</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
            prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
            iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
            file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp8"</span>, <span class="st">"b8h6.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/brms/man/fixef.brmsfit.html">fixef</a></span><span class="op">(</span><span class="va">b8h6</span><span class="op">)</span>
<span class="co">#&gt;             Estimate Est.Error    Q2.5 Q97.5</span>
<span class="co">#&gt; Intercept   -0.01641     0.157 -0.3237 0.287</span>
<span class="co">#&gt; wine_amer1  -0.17688     0.145 -0.4640 0.109</span>
<span class="co">#&gt; judge_amer1  0.22773     0.143 -0.0534 0.503</span>
<span class="co">#&gt; redred      -0.00686     0.145 -0.2873 0.277</span></code></pre></div>
<p>As indicated by the last problem, there is basically no effect of red vs.¬†white wine. There does appear to be a slight preference for French wines; however, there‚Äôs a good deal of posterior density on both sides of 0. This confirms what we found in the last problem: that there is little variation coming from the wines. We do see a slightly stronger effect among judges, with American judges giving higher scores on average.</p>
<div class="question">
<blockquote>
<p><strong>8H7.</strong> Now consider two-way interactions among the three features. You should end up with three different interaction terms in your model. These will be easier to build, if you use indicator variables. Again justify your priors. Explain what each interaction means. Be sure to interpret the model‚Äôs predictions on the outcome scale (<code>mu</code>, the expected score), not on the scale of individual parameters. You can use <code>link</code> to help with this, or just use your knowledge of the linear model instead. What do you conclude about the features and the scores? Can you relate the results of your model(s) to the individual judge and wine inferences from <strong>8H5</strong>?</p>
</blockquote>
</div>
<p>We‚Äôll start by fitting the model. Here I‚Äôve used the same priors as the previous problem for the intercept and main effect parameters. For the interactions, I have specified a <code>normal(0, 0.25)</code> prior. The interaction priors are a little tighter because as we keep subsetting the sample, values can‚Äôt keep getting larger and larger.</p>
<div class="sourceCode" id="cb195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b8h7</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">score_std</span> <span class="op">~</span> <span class="va">wine_amer</span> <span class="op">+</span> <span class="va">judge_amer</span> <span class="op">+</span> <span class="va">red</span> <span class="op">+</span>
              <span class="va">wine_amer</span><span class="op">:</span><span class="va">judge_amer</span> <span class="op">+</span> <span class="va">wine_amer</span><span class="op">:</span><span class="va">red</span> <span class="op">+</span> <span class="va">judge_amer</span><span class="op">:</span><span class="va">red</span>,
            data <span class="op">=</span> <span class="va">wine</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
            prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.25</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>,
                            coef <span class="op">=</span> <span class="va">judge_amer1</span><span class="op">:</span><span class="va">redred</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.25</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>,
                            coef <span class="op">=</span> <span class="va">wine_amer1</span><span class="op">:</span><span class="va">judge_amer1</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.25</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>,
                            coef <span class="op">=</span> <span class="va">wine_amer1</span><span class="op">:</span><span class="va">redred</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
            iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
            file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp8"</span>, <span class="st">"b8h7.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/brms/man/fixef.brmsfit.html">fixef</a></span><span class="op">(</span><span class="va">b8h7</span><span class="op">)</span>
<span class="co">#&gt;                        Estimate Est.Error   Q2.5 Q97.5</span>
<span class="co">#&gt; Intercept               -0.0749     0.176 -0.420 0.274</span>
<span class="co">#&gt; wine_amer1              -0.0553     0.193 -0.419 0.324</span>
<span class="co">#&gt; judge_amer1              0.2258     0.194 -0.158 0.603</span>
<span class="co">#&gt; redred                   0.1028     0.198 -0.280 0.494</span>
<span class="co">#&gt; wine_amer1:judge_amer1  -0.0314     0.186 -0.396 0.325</span>
<span class="co">#&gt; wine_amer1:redred       -0.2335     0.188 -0.596 0.136</span>
<span class="co">#&gt; judge_amer1:redred       0.0410     0.188 -0.323 0.410</span></code></pre></div>
<p>To interpret what all these parameters mean, we can visualize the predicted score for each combination of judge, wine location, and wine type. In this figure we see that all combinations of of judge and wine for white wines. However, there do appear to be some slight differences in the red wines. In general, French judges really don‚Äôt like the American reds, and American judges really do like the French reds.</p>
<div class="sourceCode" id="cb196"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">wine</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">wine_amer</span>, <span class="va">judge_amer</span>, <span class="va">red</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>combo <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{ifelse(judge_amer == 0, 'French', 'American')} judge, "</span>,
                      <span class="st">"{ifelse(wine_amer == 0, 'French', 'American')} wine"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">b8h7</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">median_hdi</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.epred</span>, xmin <span class="op">=</span> <span class="va">.lower</span>, xmax <span class="op">=</span> <span class="va">.upper</span>, y <span class="op">=</span> <span class="va">combo</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">red</span>, nrow <span class="op">=</span> <span class="fl">1</span>, labeller <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/as_labeller.html">as_labeller</a></span><span class="op">(</span><span class="va">str_to_title</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/geom_interval.html">geom_interval</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu">ramp_blue</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">0.1</span>, length.out <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,
                     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0.67"</span>, <span class="st">"0.89"</span>, <span class="st">"0.97"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Value"</span>, y <span class="op">=</span> <span class="cn">NULL</span>, color <span class="op">=</span> <span class="st">"Interval"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e8h7-2-1.png" width="80%" style="display: block; margin: auto;"></div>
</div>
<div id="chapter-9" class="section level3" number="4.2.3">
<h3>
<span class="header-section-number">4.2.3</span> Chapter 9<a class="anchor" aria-label="anchor" href="#chapter-9"><i class="fas fa-link"></i></a>
</h3>
<div class="question">
<blockquote>
<p><strong>9E1.</strong> Which of the following is a requirement of the simple Metropolis algorithm?</p>
</blockquote>
<blockquote>
<ol style="list-style-type: decimal">
<li>The parameters must be discrete.</li>
<li>The likelihood must be Gaussian.</li>
<li>The proposal distribution must be symmetric.</li>
</ol>
</blockquote>
</div>
<p>Only (3) is required.</p>
<div class="question">
<blockquote>
<p><strong>9E2.</strong> Gibbs sampling is more efficient than the Metropolis algorithm. How does it achieve tis extra efficiency? Are there any limitations to the Gibbs sampling strategy?</p>
</blockquote>
</div>
<p>Gibbs sampling is more efficient because it makes smarter proposals. This is accomplished through conjugate priors, which make it possible to get analytical solutions to the posterior for each parameter in the model. However, this is also limiting, because we are constrained in which prior distributions we are able to select. Additionally, like the Metropolis algorithm, Gibbs samplers can get stuck in one area of the posterior if parameters are highly correlated or if the parameters are in a high-dimensional space.</p>
<div class="question">
<blockquote>
<p><strong>9E3.</strong> Which sort of parameters can Hamiltonian Monte Carlo not handle? Can you explain why?</p>
</blockquote>
</div>
<p>Hamiltonian Monte Carlo cannot handle discrete parameters. This is because the method uses a physics simulation to glide an imaginary particle over the surface of the posterior. If parameters are discrete, that breaks the surface and the particle cannot glide.</p>
<div class="question">
<blockquote>
<p><strong>9E4.</strong> Explain the difference between the effective number of samples, <code>n_eff</code> as calculated by Stan, and the actual number of samples.</p>
</blockquote>
</div>
<p>The actual number of samples is simply the number of draws we make from the posterior distribution. These draws may be autocorrelated, so the effective number of samples is an estimate of the number of completely independent (i.e., uncorrelated) draws that would contain the same amount of information. As autocorrelation increases, the number of effective samples decreases. Usually, <code>n_eff</code> will be smaller than the actual number of samples. However, there are times when Stan can make better than independent draws, which would result in an <code>n_eff</code> great than the actual number of samples.</p>
<div class="question">
<blockquote>
<p><strong>9E5.</strong> Which value should <code>Rhat</code> approach, when a chain is sampling the posterior distribution correctly?</p>
</blockquote>
</div>
<p>The <code>Rhat</code> should approach 1 from above. That is, bad chains will result in an <code>Rhat</code> greater than 1.</p>
<div class="question">
<blockquote>
<p><strong>9E6.</strong> Sketch a good trace plot for a Markov chain, one that is effectively sampling from the posterior distribution. What is good about its shape? Then sketch a trace plot for a malfunctioning Markov chain. What about its shape indicates malfunction?</p>
</blockquote>
</div>
<p>Below is an example of a good Markov chain. Here I‚Äôve simulated 3 chains. They are all stationary and mixing well. Additionally, they are all jumbled together, so you can‚Äôt see any patterns of the different chains sampling different spaces.</p>
<div class="sourceCode" id="cb197"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iters</span> <span class="op">&lt;-</span> <span class="fl">1000</span>

<span class="va">good_chain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>.iter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">iters</span><span class="op">)</span>,
                     chain1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">iters</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
                     chain2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">iters</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
                     chain3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">iters</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">.iter</span>, names_to <span class="op">=</span> <span class="st">"chain"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">good_chain</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.iter</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">chain</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_okabeito</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Iteration"</span>, y <span class="op">=</span> <span class="st">"Value"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e9e6-1-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>In contrast this plot shows a bad chain. Here, one of the chains has gotten stuck in a different area of the posterior. All three chains are fairly stationary, but one chain is clearly not mixing with the others. We should rexamine our model to figure out what might be causing this behavior.</p>
<div class="sourceCode" id="cb198"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bad_chain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>.iter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">iters</span><span class="op">)</span>,
                    chain1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">iters</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
                    chain2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">iters</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
                    chain3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">iters</span>, mean <span class="op">=</span> <span class="fl">3</span>, sd <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">.iter</span>, names_to <span class="op">=</span> <span class="st">"chain"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">bad_chain</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.iter</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">chain</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_okabeito</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Iteration"</span>, y <span class="op">=</span> <span class="st">"Value"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e9e6-2-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>9E7.</strong> Repeat the problem above, but now for a trace rank plot.</p>
</blockquote>
</div>
<p>This one is harder, because I like the look of McElreath‚Äôs trace rank plots. Specifically, he uses outline of the histogram only, without lines to separate the individual bars. So I wrote a function called <code>make_trank()</code> that will automate this work. It takes a data frame with one column per parameter and an additional column named <code>Chain</code>. It returns a data frame suitable for making trace rank plots in {ggplot2} with <code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line()</a></code>.</p>
<p>Let‚Äôs look at a good trace rank plot. Here we see a good mixing, with a fairly consistent number of samples from each bin in each chain.</p>
<details><summary>
View <code>make_trank()</code>
</summary><div class="sourceCode" id="cb199"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">make_trank</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">bins</span> <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Chain</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>iteration <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Chain</span>, <span class="va">iteration</span><span class="op">)</span>,
                 names_to <span class="op">=</span> <span class="st">"parameter"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">parameter</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>value_rank <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">bucket_counts</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>value_bucket <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/cut_interval.html">cut_interval</a></span><span class="op">(</span><span class="va">value_rank</span>, n <span class="op">=</span> <span class="va">bins</span>,
                                       labels <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">Chain</span>, <span class="va">parameter</span>, <span class="va">value_bucket</span><span class="op">)</span>
  
  <span class="va">dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Chain</span>, <span class="va">iteration</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>iter_bucket <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/cut_interval.html">cut_interval</a></span><span class="op">(</span><span class="va">iteration</span>, n <span class="op">=</span> <span class="va">bins</span>,
                                      labels <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">bucket_counts</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Chain"</span>, <span class="st">"iter_bucket"</span> <span class="op">=</span> <span class="st">"value_bucket"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Chain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Chain</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</details><div class="sourceCode" id="cb200"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">good_chain</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Chain <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">chain</span>, <span class="st">"chain"</span>, <span class="st">""</span><span class="op">)</span>,
         Chain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">Chain</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Chain</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu">make_trank</span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">25</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">iteration</span>, y <span class="op">=</span> <span class="va">n</span>, color <span class="op">=</span> <span class="va">Chain</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_okabeito</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/waiver.html">waiver</a></span><span class="op">(</span><span class="op">)</span>, n.breaks <span class="op">=</span> <span class="fl">6</span>,
                     labels <span class="op">=</span> <span class="op">~</span><span class="va">.x</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Rank"</span>, y <span class="op">=</span> <span class="st">"Samples"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e9e7-1-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>Now for the bad chain. We know from the trace plot that one chain was sampling values that were higher than the other two chains. This is reflected in the trace rank plot. We can see that the values with the highest ranks nearly all come from one chain, and that chain has none of the low ranks. This is the chains are clearly not mixed, and do not show a consistent number of samples across the bins.</p>
<div class="sourceCode" id="cb201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bad_chain</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Chain <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">chain</span>, <span class="st">"chain"</span>, <span class="st">""</span><span class="op">)</span>,
         Chain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">Chain</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">Chain</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu">make_trank</span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">25</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">iteration</span>, y <span class="op">=</span> <span class="va">n</span>, color <span class="op">=</span> <span class="va">Chain</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_okabeito</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/waiver.html">waiver</a></span><span class="op">(</span><span class="op">)</span>, n.breaks <span class="op">=</span> <span class="fl">6</span>,
                     labels <span class="op">=</span> <span class="op">~</span><span class="va">.x</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Rank"</span>, y <span class="op">=</span> <span class="st">"Samples"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e9e7-2-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>9M1.</strong> Re-estimate the terrain reggedness model from the chapter, but now using a uniform prior for the standard deviation, <code>sigma</code>. The uniform prior should be <code>dunif(0,1)</code>. Use <code>ulam</code> to estimate the posterior. Does the different prior have any detectible influence on the posterior distribution of <code>sigma</code>? Why or why not?</p>
</blockquote>
</div>
<p>We‚Äôll fit two models, first the model from the chapter that uses and exponential prior for sigma. Then the second model which will use the uniform prior.</p>
<div class="sourceCode" id="cb202"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">rugged</span><span class="op">)</span>

<span class="va">rugged_dat</span> <span class="op">&lt;-</span> <span class="va">rugged</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">country</span>, <span class="va">rgdppc_2000</span>, <span class="va">rugged</span>, <span class="va">cont_africa</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">rgdppc_2000</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>log_gdp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">rgdppc_2000</span><span class="op">)</span>,
         log_gdp_std <span class="op">=</span> <span class="va">log_gdp</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">log_gdp</span><span class="op">)</span>,
         rugged_std <span class="op">=</span> <span class="va">rugged</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">rugged</span><span class="op">)</span>,
         rugged_std_cent <span class="op">=</span> <span class="va">rugged_std</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">rugged_std</span><span class="op">)</span>,
         cid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">cont_africa</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,
                      labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"African"</span>, <span class="st">"Not African"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">b9m1_chp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">log_gdp_std</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">*</span> <span class="va">rugged_std_cent</span>,
     <span class="va">a</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">cid</span>,
     <span class="va">b</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">cid</span>,
     nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  data <span class="op">=</span> <span class="va">rugged_dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidAfrican</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidNotAfrican</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidAfrican</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidNotAfrican</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
  iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
  file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp9"</span>, <span class="st">"b9m1-chp.rds"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">b9m1_uni</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">log_gdp_std</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">*</span> <span class="va">rugged_std_cent</span>,
     <span class="va">a</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">cid</span>,
     <span class="va">b</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">cid</span>,
     nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  data <span class="op">=</span> <span class="va">rugged_dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidAfrican</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidNotAfrican</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidAfrican</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidNotAfrican</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">uniform</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
  iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
  file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp9"</span>, <span class="st">"b9m1-uni.rds"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Now let‚Äôs compare the posterior distributions. They are nearly identical. This is because we have enough data to get a good estimate of <code>sigma</code>, regardless of the prior. However, if <code>sigma</code> were greater than 1, the uniform prior would not give the same estimate, as that prior gives 0 probability to values outside of the [0, 1] interval.</p>
<div class="sourceCode" id="cb203"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">b9m1_chp</span>, variable <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="st">"Exponential(1)"</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">b9m1_uni</span>, variable <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="st">"Uniform(0, 1)"</span><span class="op">)</span>
<span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sigma</span>, color <span class="op">=</span> <span class="va">prior</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, key_glyph <span class="op">=</span> <span class="st">"timeseries"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_okabeito</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"&amp;sigma;"</span>, y <span class="op">=</span> <span class="st">"Posterior Density"</span>, color <span class="op">=</span> <span class="st">"Prior"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e9m1-2-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>9M2.</strong> Modify the terrain ruggedness model again. This time, change the prior for <code>b[cid]</code> to <code>dexp(0.3)</code>. What does this do to the posterior distribution? Can you explain it?</p>
</blockquote>
</div>
<p>First we‚Äôll fit the model with the new priors.</p>
<div class="sourceCode" id="cb204"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b9m2_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">log_gdp_std</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">*</span> <span class="va">rugged_std_cent</span>,
     <span class="va">a</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">cid</span>,
     <span class="va">b</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">cid</span>,
     nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  data <span class="op">=</span> <span class="va">rugged_dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidAfrican</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidNotAfrican</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidAfrican</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">cidNotAfrican</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
  iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.95</span>, max_treedepth <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,
  file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp9"</span>, <span class="st">"b9m2-exp.rds"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Now let‚Äôs compare the posterior distributions of the <code>beta</code> parameters. For the first, <span class="math inline">\(\beta_{African}\)</span>, the posteriors are nearly identical. However, the posterior for <span class="math inline">\(\beta_{Not African}\)</span> is quite different. This is because the parameter wants to be negative, as it was in the original model. The new prior constrains the parameter to be positive, so we see all of the posterior density piled up right next to 0.</p>
<div class="sourceCode" id="cb205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">b9m1_chp</span>, variable <span class="op">=</span> <span class="st">"b_b_.*"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"b_b_"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"parameter"</span>,
                 values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="st">"Normal(0, 0.3)"</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">b9m2_exp</span>, variable <span class="op">=</span> <span class="st">"b_b_.*"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"b_b_"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"parameter"</span>,
                 values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="st">"Exponential(0.3)"</span><span class="op">)</span>
<span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">parameter</span>,
                            levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"b_b_cidAfrican"</span>, <span class="st">"b_b_cidNotAfrican"</span><span class="op">)</span>,
                            labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&amp;beta;&lt;sub&gt;African&lt;/sub&gt;"</span>,
                                       <span class="st">"&amp;beta;&lt;sub&gt;Not African&lt;/sub&gt;"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">prior</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">parameter</span>, nrow <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, key_glyph <span class="op">=</span> <span class="st">"timeseries"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_okabeito</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Normal(0, 0.3)"</span>, <span class="st">"Exponential(0.3)"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"&amp;beta;"</span>, y <span class="op">=</span> <span class="st">"Posterior Density"</span>, color <span class="op">=</span> <span class="st">"Prior"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e9m2-2-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>9M3.</strong> Re-estimate one of the Stan models from the chapter, but at different numbers of <code>warmup</code> iterations. Be sure to use the same number of sampling interations in each case. Compare the <code>n_eff</code> values. How much warmup is enough?</p>
</blockquote>
</div>
<p>For simplicity, we‚Äôll use the same terrain-ruggedness example as the previous two problems. We‚Äôll investigate 7 different warm-up lengths, with the number of post-warmup samples fixed to 1,000.</p>
<div class="sourceCode" id="cb206"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">warmup_length</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">250</span>, <span class="fl">500</span>, <span class="fl">1000</span><span class="op">)</span>

<span class="va">b9m3_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="va">warmup_length</span>,
                    <span class="kw">function</span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">b9m1_chp</span><span class="op">$</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">b9m1_chp</span><span class="op">$</span><span class="va">data</span>,
                                 family <span class="op">=</span> <span class="va">gaussian</span>, prior <span class="op">=</span> <span class="va">b9m1_chp</span><span class="op">$</span><span class="va">prior</span>,
                                 chains <span class="op">=</span> <span class="fl">1</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                                 iter <span class="op">=</span> <span class="va">w</span> <span class="op">+</span> <span class="fl">1000</span>, warmup <span class="op">=</span> <span class="va">w</span><span class="op">)</span>
                      
                      <span class="va">mod_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/fit-method-summary.html">summary</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>
                      <span class="va">mod_sum</span><span class="op">$</span><span class="va">fixed</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
                        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">mod_sum</span><span class="op">$</span><span class="va">spec_pars</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
                        <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">"parameter"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
                        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>warmup <span class="op">=</span> <span class="va">w</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
                        <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
                        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">warmup</span>, <span class="va">parameter</span>, <span class="va">Bulk_ESS</span>, <span class="va">Tail_ESS</span><span class="op">)</span>
                    <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html">write_rds</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp9"</span>, <span class="st">"b9m3-sim.rds"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b9m3_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html">read_rds</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp9"</span>, <span class="st">"b9m3-sim.rds"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>With {brms}, rather than one measure of effective sample size (ESS), we get two measures, as described in <span class="citation">Vehtari et al. (<a href="references.html#ref-rhatess" role="doc-biblioref">2021</a>)</span>. Bulk ESS describes the mean of the distribution (i.e., the bulk), and Tail ESS describes the variance (i.e., the tails of the distribution). We can see that for this particular model, both the Bulk ESS and Tail ESS level off fairly quickly, meaning that not much warmup is needed in this particular case.</p>
<div class="sourceCode" id="cb208"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b9m3_sim</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"_ESS"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"type"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>param_label <span class="op">=</span> <span class="va">parameter</span>,
         param_label <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">param_label</span>, <span class="st">"a_cid(.*)$"</span>, <span class="st">"&amp;alpha;&lt;sub&gt;\\1&lt;/sub&gt;"</span><span class="op">)</span>,
         param_label <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">param_label</span>, <span class="st">"b_cid(.*)$"</span>, <span class="st">"&amp;beta;&lt;sub&gt;\\1&lt;/sub&gt;"</span><span class="op">)</span>,
         param_label <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">param_label</span>, <span class="st">"sigma"</span>, <span class="st">"&lt;sub&gt;&amp;sigma;&lt;/sub&gt;"</span><span class="op">)</span>,
         type <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">type</span>, <span class="st">"_"</span>, <span class="st">" "</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">warmup</span>, y <span class="op">=</span> <span class="va">value</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">param_label</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_okabeito</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_x_comma</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Warmup Iterations"</span>, y <span class="op">=</span> <span class="st">"Effective Sample Size"</span>,
       color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e9m3-2-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question code-question">
<blockquote>
<p><strong>9H1.</strong> Run the model below and then inspect the posterior distribution and explain what it is accomplishing.</p>
</blockquote>
<div class="sourceCode" id="cb209"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/ulam.html">ulam</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">alist</a></span><span class="op">(</span>
    <span class="va">a</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,
    <span class="va">b</span> <span class="op">~</span> <span class="fu">dcaucy</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="op">)</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, chains <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<blockquote>
<p>Compare the samples for the parameters <code>a</code> and <code>b</code>. Can you explain the different trace plots? If you are unfamiliar with the Cauchy distribution, you should look it up. The key feature to attend to is that it has no expected value. Can you connect this fact to the trace plot?</p>
</blockquote>
</div>
<p>This model is just sampling prior distributions. Let reproduce this using {brms}. To get prior samples, we set <code>sample_prior = "only"</code>. That, in combination with the non-linear syntax we‚Äôve seen before, lets us duplicate the model from the question.</p>
<div class="sourceCode" id="cb210"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">~</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span>, <span class="va">a</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">b</span> <span class="op">~</span> <span class="fl">1</span>, nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, data <span class="op">=</span> <span class="fl">1</span>,
          prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
                    <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">cauchy</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">b</span><span class="op">)</span><span class="op">)</span>,
          iter <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">1</span>, sample_prior <span class="op">=</span> <span class="st">"only"</span>,
          file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp9"</span>, <span class="st">"b9h1-prior"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Looking at the trace plots, we see that <code>a</code> is sampling as we would expect, given the prior, bouncing around between -3 and 3. The <code>b</code> parameter looks a little odd. However, this is normal for the Cauchy distribution. This distribution has an undefined mean and variance, with very heavy tails. Because of this, it will occasionally jump to extreme values.</p>
<div class="sourceCode" id="cb211"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">mp</span>, variable <span class="op">=</span> <span class="st">"^b_"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"b_"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"param"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>param <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">param</span>, <span class="st">"b_([ab])_Intercept"</span>, <span class="st">"\\1"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.draw</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">param</span>, nrow <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"#009FB7"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e9h1-2-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>9H2.</strong> Recall the divorce rate example from Chapter 5. Repeat that analysis, using <code>ulam</code> this time, fitting models <code>m5.1</code>, <code>m5.2</code>, and <code>m5.3</code>. Use <code>compare</code> to compare the models on the basis of WAIC or PSIS. To use WAIC or PSIS with <code>ulam</code>, you need add the argument <code>log_lik=TRUE</code>. Explain the model comparison results.</p>
</blockquote>
</div>
<p>First, the code to reproduce the three models. Model <code>bm51</code> uses only median age at marriage to predict the divorce rate, <code>bm52</code> uses only marriage rate, and <code>bm53</code> uses both predictors.</p>
<div class="sourceCode" id="cb212"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"WaffleDivorce"</span><span class="op">)</span>

<span class="va">waffle_dat</span> <span class="op">&lt;-</span> <span class="va">WaffleDivorce</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>d <span class="op">=</span> <span class="va">Divorce</span>, m <span class="op">=</span> <span class="va">Marriage</span>, a <span class="op">=</span> <span class="va">MedianAgeMarriage</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">standardize</span><span class="op">)</span><span class="op">)</span>

<span class="va">bm51</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">d</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">a</span>, data <span class="op">=</span> <span class="va">waffle_dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
            prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
            iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
            file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp9"</span>, <span class="st">"b9h2-m51"</span><span class="op">)</span><span class="op">)</span>

<span class="va">bm52</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">d</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">m</span>, data <span class="op">=</span> <span class="va">waffle_dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
            prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
            iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
            file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp9"</span>, <span class="st">"b9h2-m52"</span><span class="op">)</span><span class="op">)</span>

<span class="va">bm53</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">d</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">m</span> <span class="op">+</span> <span class="va">a</span>, data <span class="op">=</span> <span class="va">waffle_dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
            prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
            iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
            file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp9"</span>, <span class="st">"b9h2-m53"</span><span class="op">)</span><span class="op">)</span>

<span class="va">bm51</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">bm51</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span>
<span class="va">bm52</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">bm52</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span>
<span class="va">bm53</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">bm53</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Now let‚Äôs compare. With both the WAIC and PSIS-LOO, the first model with only age at marriage is preferred. However, the score for <code>bm53</code> is nearly the same. This indicates that the two models are not really being differentiated very well.</p>
<div class="sourceCode" id="cb213"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">bm51</span>, <span class="va">bm52</span>, <span class="va">bm53</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>
<span class="co">#&gt;      elpd_diff se_diff</span>
<span class="co">#&gt; bm51  0.0       0.0   </span>
<span class="co">#&gt; bm53 -0.9       0.3   </span>
<span class="co">#&gt; bm52 -6.7       4.6</span>

<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">bm51</span>, <span class="va">bm52</span>, <span class="va">bm53</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="co">#&gt;      elpd_diff se_diff</span>
<span class="co">#&gt; bm51  0.0       0.0   </span>
<span class="co">#&gt; bm53 -0.9       0.3   </span>
<span class="co">#&gt; bm52 -6.6       4.7</span></code></pre></div>
<div class="question code-question">
<blockquote>
<p><strong>9H3.</strong> Sometimes changing a prior for one parameter has unanticipated effects on other parameters. This is because when a parameter is highly correlated with another parameter in the posterior, the prior influences both parameters. Here‚Äôs an example to work and think through.</p>
</blockquote>
<blockquote>
<p>Go back to the leg length example in Chapter 6 and use the code there to simulate height and leg lengths for 100 imagined individuals. Below is the model you fit before, resulting in a highly correlated posterior for the two beta parameters. This time, fit the model using <code>ulam</code>:</p>
</blockquote>
<div class="sourceCode" id="cb214"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m5.8s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/ulam.html">ulam</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">alist</a></span><span class="op">(</span>
    <span class="va">height</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mu</span>, <span class="va">sigma</span><span class="op">)</span>,
    <span class="va">mu</span> <span class="op">&lt;-</span> <span class="va">a</span> <span class="op">+</span> <span class="va">bl</span> <span class="op">*</span> <span class="va">leg_left</span> <span class="op">+</span> <span class="va">br</span> <span class="op">*</span> <span class="va">leg_right</span> ,
    <span class="va">a</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span><span class="op">)</span>,
    <span class="va">bl</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span>,
    <span class="va">br</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span>,
    <span class="va">sigma</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">dexp</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
  <span class="op">)</span>, data <span class="op">=</span> <span class="va">d</span>, chains <span class="op">=</span> <span class="fl">4</span>,
  start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>a <span class="op">=</span><span class="fl">10</span> , bl <span class="op">=</span> <span class="fl">0</span>, br <span class="op">=</span> <span class="fl">0.1</span>, sigma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<blockquote>
<p>Compare the posterior distribution produced by the code above to the posterior distribution produced when you change the prior for <code>br</code> so that it is strictly positive:</p>
</blockquote>
<div class="sourceCode" id="cb215"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m5.8s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/ulam.html">ulam</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">alist</a></span><span class="op">(</span>
    <span class="va">height</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mu</span>, <span class="va">sigma</span><span class="op">)</span>,
    <span class="va">mu</span> <span class="op">&lt;-</span> <span class="va">a</span> <span class="op">+</span> <span class="va">bl</span> <span class="op">*</span> <span class="va">leg_left</span> <span class="op">+</span> <span class="va">br</span> <span class="op">*</span> <span class="va">leg_right</span> ,
    <span class="va">a</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span><span class="op">)</span>,
    <span class="va">bl</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span>,
    <span class="va">br</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span>,
    <span class="va">sigma</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">dexp</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
  <span class="op">)</span>, data <span class="op">=</span> <span class="va">d</span>, chains <span class="op">=</span> <span class="fl">4</span>,
  constraints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>br <span class="op">=</span> <span class="st">"lower=0"</span><span class="op">)</span>,
  start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>a <span class="op">=</span><span class="fl">10</span> , bl <span class="op">=</span> <span class="fl">0</span>, br <span class="op">=</span> <span class="fl">0.1</span>, sigma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<blockquote>
<p>Note the <code>constraints</code> list. What this does is constrain the prior distribution of <code>br</code> so that is has positive probability only above zero. In other words, that prior ensures that the posterior distribution for <code>br</code> will have no probability mass below zero. Compare the two posterior distributions for <code>m5.8s</code> and <code>m5.8s2</code>. What has changed in the posterior distribution of both beta parameters? Can you explain the change induced by the change in prior?</p>
</blockquote>
</div>
<p>Let‚Äôs start by simulating the data we used for those models. As a reminder, there is a strong correlation between the lengths of the two legs.</p>
<div class="sourceCode" id="cb216"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">909</span><span class="op">)</span>

<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100</span>

<span class="va">height</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">10</span>, <span class="fl">2</span><span class="op">)</span> 
<span class="va">leg_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span><span class="op">)</span> 
<span class="va">leg_left</span> <span class="op">&lt;-</span> <span class="va">leg_prop</span> <span class="op">*</span> <span class="va">height</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">0.02</span><span class="op">)</span>
<span class="va">leg_right</span> <span class="op">&lt;-</span> <span class="va">leg_prop</span> <span class="op">*</span> <span class="va">height</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">0.02</span><span class="op">)</span>

<span class="va">leg_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="va">height</span>, <span class="va">leg_left</span>, <span class="va">leg_right</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">leg_dat</span><span class="op">$</span><span class="va">leg_left</span>, <span class="va">leg_dat</span><span class="op">$</span><span class="va">leg_right</span><span class="op">)</span>
<span class="co">#&gt; [1] 1</span></code></pre></div>
<p>Now let‚Äôs fit the two models.</p>
<div class="sourceCode" id="cb217"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bm58s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">height</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">leg_left</span> <span class="op">+</span> <span class="va">leg_right</span>, data <span class="op">=</span> <span class="va">leg_dat</span>,
             family <span class="op">=</span> <span class="va">gaussian</span>,
             prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">leg_left</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">leg_right</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
             iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
             file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp9"</span>, <span class="st">"b9h3-m58s"</span><span class="op">)</span><span class="op">)</span>

<span class="va">bm58s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">height</span> <span class="op">~</span> <span class="va">int</span> <span class="op">+</span> <span class="va">ll</span> <span class="op">+</span> <span class="va">lr</span>,
                 <span class="va">int</span> <span class="op">~</span> <span class="fl">1</span>,
                 <span class="va">ll</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">leg_left</span>,
                 <span class="va">lr</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">leg_right</span>,
                 nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
              data <span class="op">=</span> <span class="va">leg_dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
              prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">int</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, nlpar <span class="op">=</span> <span class="va">ll</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, lb <span class="op">=</span> <span class="fl">0</span>, nlpar <span class="op">=</span> <span class="va">lr</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
              iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
              file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"chp9"</span>, <span class="st">"b9h3-m58s2"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>To examine the posteriors, we‚Äôll first look at the correlations between parameters. In both models, there is a very strong negative correlation between <span class="math inline">\(\beta_L\)</span> and <span class="math inline">\(\beta_R\)</span>. This makes sense given our data. Because the data are so strongly correlated, that they provide basically the same information. So if we take more information from the left leg (i.e., higher values of <span class="math inline">\(\beta_L\)</span>), we necessarily must let less from the right leg. This results in in the negative correlation.</p>
<div class="sourceCode" id="cb218"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">bm58s</span>, variable <span class="op">=</span> <span class="st">"b_leg.*"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="st">"Unconstrained"</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/draws-brms.html">as_draws_df</a></span><span class="op">(</span><span class="va">bm58s2</span>, variable <span class="op">=</span> <span class="st">"b_l[lr]_leg.*"</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>b_leg_left <span class="op">=</span> <span class="va">b_ll_leg_left</span>, b_leg_right <span class="op">=</span> <span class="va">b_lr_leg_right</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="st">"Constrained"</span><span class="op">)</span>
<span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_inorder</a></span><span class="op">(</span><span class="va">prior</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">draws</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">b_leg_right</span>, y <span class="op">=</span> <span class="va">b_leg_left</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">prior</span>, nrow <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"&amp;beta;&lt;sub&gt;R&lt;/sub&gt;"</span>, y <span class="op">=</span> <span class="st">"&amp;beta;&lt;sub&gt;L&lt;/sub&gt;"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e9h3-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>However, looking at the actual distributions reveals in the impact of constraining one parameter to be positive. In the unconstrained model, the distributions are very similar. In the constrained model, <span class="math inline">\(\beta_R\)</span> takes only positive values, and the distributions are mirror images of each other. In order to preserve the negative correlation of the posterior, the change in prior for one parameter has cascaded into the other parameter.</p>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">draws</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"b_"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"param"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">prior</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">param</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span>, key_glyph <span class="op">=</span> <span class="st">"timeseries"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_okabeito</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"&amp;beta;&lt;sub&gt;L&lt;/sub&gt;"</span>, <span class="st">"&amp;beta;&lt;sub&gt;R&lt;/sub&gt;"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"&amp;beta;"</span>, y <span class="op">=</span> <span class="st">"Density"</span>, color <span class="op">=</span> <span class="st">"Parameter"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu">element_markdown</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e9h3-4-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>9H4.</strong> For the two models fit in the previous problem, use WAIC or PSIS to compare the effective numbers of parameters for each model. You will need to use <code>log_lik=TRUE</code> to instruct <code>ulam</code> to compute the terms that both WAIC and PSIS need. Which model has more effective parameters? Why?</p>
</blockquote>
</div>
<p>The number of effective parameters is give by the <code>p_waic</code> and <code>p_loo</code> columns, respectively. The unconstrained model (<code>bm58s</code>) has a large number of effective parameters, 3.2 compared to 2.6. This makes sense given our priors. The second model has a more informative prior, so the parameters are not able to move around as freely and the posterior as a smaller variance.</p>
<div class="sourceCode" id="cb220"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bm58s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">bm58s</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span>
<span class="va">bm58s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">bm58s2</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">bm58s</span>, <span class="va">bm58s2</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt;        elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic  se_waic</span>
<span class="co">#&gt; bm58s2   0.0       0.0   -96.9       5.6          2.6    0.4     193.9  11.2  </span>
<span class="co">#&gt; bm58s   -0.6       0.2   -97.5       5.6          3.2    0.5     195.1  11.3</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">bm58s</span>, <span class="va">bm58s2</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt;        elpd_diff se_diff elpd_loo se_elpd_loo p_loo se_p_loo looic se_looic</span>
<span class="co">#&gt; bm58s2   0.0       0.0   -96.9      5.6         2.6   0.4    193.9  11.2   </span>
<span class="co">#&gt; bm58s   -0.6       0.2   -97.6      5.6         3.2   0.5    195.1  11.3</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>9H5.</strong> Modify the Metropolis algorithm code from the chapter to handle the case that the island populations have a different distribution than the island labels. This means the island‚Äôs number will not be the same as its population.</p>
</blockquote>
</div>
<p>In the original example, the population of each island was 1 to 10 in order. For this problem, we‚Äôll pick a random population order.</p>
<div class="sourceCode" id="cb221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">209</span><span class="op">)</span>

<span class="va">pop_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/model-method-sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, size <span class="op">=</span> <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">pop_size</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Island"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>
<span class="va">pop_size</span>
<span class="co">#&gt;  Island 1  Island 2  Island 3  Island 4  Island 5  Island 6  Island 7  Island 8 </span>
<span class="co">#&gt;         2         3        10         6         8         5         7         9 </span>
<span class="co">#&gt;  Island 9 Island 10 </span>
<span class="co">#&gt;         1         4</span></code></pre></div>
<p>Now we can repeat the simulation from the chapter. The function takes a current island position, <code>island</code>, and the popualtion of the island, and returns the next island. The guts of the function are the same as the <code>for</code> loop from the chapter.</p>
<div class="sourceCode" id="cb222"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">island_sim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">island</span>, <span class="va">...</span>, <span class="va">island_pop</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># flip coin to generate proposal</span>
  <span class="va">proposal</span> <span class="op">&lt;-</span> <span class="va">island</span> <span class="op">+</span> <span class="op">(</span><span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/model-method-sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># loop when we reach the boundary</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">proposal</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span> <span class="va">proposal</span> <span class="op">&lt;-</span> <span class="fl">10L</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">proposal</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span> <span class="va">proposal</span> <span class="op">&lt;-</span> <span class="fl">1L</span>
  
  <span class="co"># decide if we move</span>
  <span class="va">prob</span> <span class="op">&lt;-</span> <span class="va">island_pop</span><span class="op">[</span><span class="va">proposal</span><span class="op">]</span> <span class="op">/</span> <span class="va">island_pop</span><span class="op">[</span><span class="va">island</span><span class="op">]</span>
  <span class="va">island</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">prob</span>, <span class="va">proposal</span>, <span class="va">island</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">island</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We can then use <code><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate()</a></code> to run the function 100,000 times, passing the previous position to <code>island</code> each time. In the summary we can see the proportion of total visits that each island received (<code>visit_prop</code>) and the proportion of the total population that lives on each island (<code>pop_prop</code>). We can see that these two columns are nearly identical, so we are in fact visiting each island in proportion to the populations of the islands.</p>
<div class="sourceCode" id="cb223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">visits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">1e6</span><span class="op">)</span>, <span class="va">island_sim</span>, .init <span class="op">=</span> <span class="fl">10L</span>,
                     island_pop <span class="op">=</span> <span class="va">pop_size</span><span class="op">)</span>

<span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>island <span class="op">=</span> <span class="va">visits</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">island</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>population <span class="op">=</span> <span class="va">pop_size</span>,
         visit_prop <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,
         pop_prop <span class="op">=</span> <span class="va">population</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 10 √ó 5</span>
<span class="co">#&gt;    island      n population visit_prop pop_prop</span>
<span class="co">#&gt;     &lt;int&gt;  &lt;int&gt;      &lt;int&gt;      &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt;  1      1  35867          2     0.0359   0.0364</span>
<span class="co">#&gt;  2      2  53920          3     0.0539   0.0545</span>
<span class="co">#&gt;  3      3 181239         10     0.181    0.182 </span>
<span class="co">#&gt;  4      4 109238          6     0.109    0.109 </span>
<span class="co">#&gt;  5      5 146186          8     0.146    0.145 </span>
<span class="co">#&gt;  6      6  91538          5     0.0915   0.0909</span>
<span class="co">#&gt;  7      7 127965          7     0.128    0.127 </span>
<span class="co">#&gt;  8      8 163814          9     0.164    0.164 </span>
<span class="co">#&gt;  9      9  18102          1     0.0181   0.0182</span>
<span class="co">#&gt; 10     10  72132          4     0.0721   0.0727</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>9H6.</strong> Modify the Metropolis algorithm code from the chapter to write your own simple MCMC estimator for globe tossing data and model from Chapter 2.</p>
</blockquote>
</div>
<p>Like in the previous problem, we‚Äôll start by writing a function for the simulation. This follows the same structure as the previous problem, but rather than moving based on the ratio island populations, we move based on the ratio of the likelihoods for our parameter estimate.</p>
<div class="sourceCode" id="cb224"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">globe_sim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prop</span>, <span class="va">...</span>, <span class="va">n</span>, <span class="va">trials</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># proposal value: random number +/-0.1 from current value of `prop`</span>
  <span class="va">proposal</span> <span class="op">&lt;-</span> <span class="va">prop</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span>
  
  <span class="co"># reflect back when proposal is outside the [0,1] bounds of `prop`</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">proposal</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="va">proposal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">proposal</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">proposal</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="va">proposal</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="op">(</span><span class="va">proposal</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>
  
  <span class="co"># probability of current and proposed values</span>
  <span class="co"># uses uniform prior, but could change `dunif` to some other prior</span>
  <span class="va">prob_current</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">dbinom</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, size <span class="op">=</span> <span class="va">trials</span>, prob <span class="op">=</span> <span class="va">prop</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="va">prop</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="va">prob_proposal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">dbinom</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, size <span class="op">=</span> <span class="va">trials</span>, prob <span class="op">=</span> <span class="va">proposal</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="va">proposal</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
  
  <span class="co"># accept proposal?</span>
  <span class="va">prob_accept</span> <span class="op">&lt;-</span> <span class="va">prob_proposal</span> <span class="op">/</span> <span class="va">prob_current</span>
  <span class="va">prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">prob_accept</span>, <span class="va">proposal</span>, <span class="va">prop</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">prop</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>For fun, we‚Äôll generate three chains so that we can have some more interesting plots to look at. In the Chapter 2 example, we had 6 waters out of 9 total trials, so those values are passed to the <code>n</code> and <code>trials</code> arguments of the function we just created. Finally, I start each chain at a different value, with the hope that they all converge to the same are of the posterior.</p>
<div class="sourceCode" id="cb225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">209</span><span class="op">)</span>

<span class="va">chain1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">1e4</span><span class="op">)</span>, <span class="va">globe_sim</span>, .init <span class="op">=</span> <span class="fl">0.2</span>, n <span class="op">=</span> <span class="fl">6</span>, trials <span class="op">=</span> <span class="fl">9</span><span class="op">)</span>
<span class="va">chain2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">1e4</span><span class="op">)</span>, <span class="va">globe_sim</span>, .init <span class="op">=</span> <span class="fl">0.5</span>, n <span class="op">=</span> <span class="fl">6</span>, trials <span class="op">=</span> <span class="fl">9</span><span class="op">)</span>
<span class="va">chain3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">1e4</span><span class="op">)</span>, <span class="va">globe_sim</span>, .init <span class="op">=</span> <span class="fl">0.8</span>, n <span class="op">=</span> <span class="fl">6</span>, trials <span class="op">=</span> <span class="fl">9</span><span class="op">)</span></code></pre></div>
<p>Let‚Äôs look at the trace rank plot for our chains. We see a fairly stable distribution within each chain, and good mixing between chains, which is exactly what we would want to see!</p>
<div class="sourceCode" id="cb226"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Chain <span class="op">=</span> <span class="fl">1L</span>, p <span class="op">=</span> <span class="va">chain1</span><span class="op">)</span>,
          <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Chain <span class="op">=</span> <span class="fl">2L</span>, p <span class="op">=</span> <span class="va">chain2</span><span class="op">)</span>,
          <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Chain <span class="op">=</span> <span class="fl">3L</span>, p <span class="op">=</span> <span class="va">chain3</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu">make_trank</span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">25</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">iteration</span>, y <span class="op">=</span> <span class="va">n</span>, color <span class="op">=</span> <span class="va">Chain</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_okabeito</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/waiver.html">waiver</a></span><span class="op">(</span><span class="op">)</span>, n.breaks <span class="op">=</span> <span class="fl">6</span>,
                     labels <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/formatc.html">prettyNum</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">*</span> <span class="fl">3</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Rank"</span>, y <span class="op">=</span> <span class="st">"Samples"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e9h6-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>The last step is to actually look at our estimate of the proportion of water. There‚Äôs an expected value of 0.63, with a 95% interval of 0.33 to 0.88.</p>
<div class="sourceCode" id="cb227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">mean_qi</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">chain1</span>, <span class="va">chain2</span>, <span class="va">chain3</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span>
<span class="co">#&gt;       y  ymin ymax .width .point .interval</span>
<span class="co">#&gt; 1 0.633 0.335 0.88   0.95   mean        qi</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>9H7.</strong> Can you write your own Hamiltonian Monte Carlo algorithm for the globe tossing data, using the R code in the chapter? You will have to write your own functions for the likelihood and gradient, but you can use the HMC2 function.</p>
</blockquote>
</div>
<p>There are two functions that we need to re-write if we‚Äôre following the example from the book. <code>U_globe()</code> will be the log-probability of the data, and <code>U_globe_gradient()</code> will be the gradient. We‚Äôll start with <code>U_globe()</code>, which is very similar to what we created in the previous problem.</p>
<div class="sourceCode" id="cb228"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">U_globe</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">q</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">U</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">dbinom</a></span><span class="op">(</span><span class="va">y</span>, size <span class="op">=</span> <span class="va">n</span>, prob <span class="op">=</span> <span class="va">q</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">dunif</a></span><span class="op">(</span><span class="va">q</span>, <span class="fl">0</span>, <span class="fl">1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">U</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The gradient of the <code>U</code> function is given as</p>
<p><span class="math display">\[
\frac{\partial U(y|n,p)}{\partial p}
\]</span>
If we solve this (I cheated and used Mathematica), we get the answer for our gradient:</p>
<p><span class="math display">\[
\frac{\partial \log U(y|n,p)}{\partial p} = \frac{y - np}{p(1-p)}
\]</span></p>
<p>In function form, we define <code>U_globe_gradient()</code> as:</p>
<div class="sourceCode" id="cb229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">U_globe_gradient</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">q</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">G</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">y</span> <span class="op">-</span> <span class="va">n</span> <span class="op">*</span> <span class="va">q</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">q</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">q</span><span class="op">)</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">G</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Finally, we plug our functions into a wrapper function that we can pass to <code><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate()</a></code>, and run 3 chains.</p>
<div class="sourceCode" id="cb230"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">globe_hmc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Q</span>, <span class="va">...</span>, <span class="va">y</span> <span class="op">=</span> <span class="fl">6</span>, <span class="va">n</span> <span class="op">=</span> <span class="fl">9</span>, <span class="va">step</span> <span class="op">=</span> <span class="fl">0.03</span>, <span class="va">L</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/HMC2.html">HMC2</a></span><span class="op">(</span><span class="va">U_globe</span>, <span class="va">U_globe_gradient</span>, <span class="va">step</span>, <span class="va">L</span>, <span class="va">Q</span><span class="op">$</span><span class="va">q</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">209</span><span class="op">)</span>

<span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">6</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">9</span>

<span class="va">chain1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, <span class="va">globe_hmc</span>, .init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>q <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html">keep</a></span><span class="op">(</span><span class="op">~</span><span class="st">"accept"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">accept</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">.x</span><span class="op">$</span><span class="va">q</span>, <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span>
<span class="va">chain2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, <span class="va">globe_hmc</span>, .init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>q <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html">keep</a></span><span class="op">(</span><span class="op">~</span><span class="st">"accept"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">accept</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">.x</span><span class="op">$</span><span class="va">q</span>, <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span>
<span class="va">chain3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/accumulate.html">accumulate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>, <span class="va">globe_hmc</span>, .init <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>q <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html">keep</a></span><span class="op">(</span><span class="op">~</span><span class="st">"accept"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">accept</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">.x</span><span class="op">$</span><span class="va">q</span>, <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Once again, we can look at the trace rank plot. We still get good mixing and consistency, indicating that the chains are mixing well and sampling the same area of the posterior.</p>
<div class="sourceCode" id="cb231"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Chain <span class="op">=</span> <span class="fl">1L</span>, p <span class="op">=</span> <span class="va">chain1</span><span class="op">)</span>,
          <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Chain <span class="op">=</span> <span class="fl">2L</span>, p <span class="op">=</span> <span class="va">chain2</span><span class="op">)</span>,
          <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Chain <span class="op">=</span> <span class="fl">3L</span>, p <span class="op">=</span> <span class="va">chain3</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu">make_trank</span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">25</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">iteration</span>, y <span class="op">=</span> <span class="va">n</span>, color <span class="op">=</span> <span class="va">Chain</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_okabeito</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/waiver.html">waiver</a></span><span class="op">(</span><span class="op">)</span>, n.breaks <span class="op">=</span> <span class="fl">6</span>,
                     labels <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/formatc.html">prettyNum</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">*</span> <span class="fl">3</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Rank"</span>, y <span class="op">=</span> <span class="st">"Samples"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/e9h7-4-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>Looking at our posterior, we ahve an expected value of 0.63, with a 95% interval of 0.35 to 0.87. This is very similar to what we achieved with the Metropolis algorithm.</p>
<div class="sourceCode" id="cb232"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">mean_qi</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">chain1</span>, <span class="va">chain2</span>, <span class="va">chain3</span><span class="op">)</span>, .width <span class="op">=</span> <span class="fl">0.95</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt;       y  ymin  ymax .width .point .interval</span>
<span class="co">#&gt; 1 0.634 0.349 0.874   0.95   mean        qi</span></code></pre></div>
</div>
</div>
<div id="homework-3" class="section level2" number="4.3">
<h2>
<span class="header-section-number">4.3</span> Homework<a class="anchor" aria-label="anchor" href="#homework-3"><i class="fas fa-link"></i></a>
</h2>
<div class="question">
<blockquote>
<p><strong>1.</strong> Revisit the marriage, age, and happiness collider bias example from Chapter 6. Run models <code>m6.9</code> and <code>m6.10</code> again (pages 178‚Äì179). Compare these two models using both PSIS and WAIC. Which model is expected to make better predictions, according to these criteria? On the basis of the causal model, how should you interpret the parameter estimates from the model preferred by PSIS and WAIC?</p>
</blockquote>
</div>
<p>As a reminder, here is the DAG for this example, where <span class="math inline">\(H\)</span> is happiness, <span class="math inline">\(M\)</span> is marriage, and <span class="math inline">\(A\)</span> is age.</p>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/w4h1-1-1.png" width="40%" style="display: block; margin: auto;"></div>
<p>First, let‚Äôs regenerate the data and estimate the models.</p>
<div class="sourceCode" id="cb233"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">sim_happiness</span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1977</span>, N_years <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">age</span> <span class="op">&gt;</span> <span class="fl">17</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>a <span class="op">=</span> <span class="op">(</span><span class="va">age</span> <span class="op">-</span> <span class="fl">18</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">65</span> <span class="op">-</span> <span class="fl">18</span><span class="op">)</span>,
         mid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">married</span> <span class="op">+</span> <span class="fl">1</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"single"</span>, <span class="st">"married"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">b6.9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">happiness</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">mid</span> <span class="op">+</span> <span class="va">a</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
            prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">midmarried</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">midsingle</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
            iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
            file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw4"</span>, <span class="st">"w4h1-6.9"</span><span class="op">)</span><span class="op">)</span>

<span class="va">b6.10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">happiness</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">a</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
             prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, coef <span class="op">=</span> <span class="va">a</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
             iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
             file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw4"</span>, <span class="st">"w4h1-6.10"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Now we‚Äôll compare both PSIS and WAIC. The results from PSIS and WAIC are identical, with both showing a very strong preference for <code>b6.9</code> which includes marriage as a predictor. Thus, if we are interested only in predicting happiness, we should use model <code>b6.9</code>. However, due to the causal model, the coefficients can‚Äôt be interpreted. The coefficient for age is confounded by the collider. Similarly, the coefficient for marriage is odd, because in the DAG, marriage does not cause happiness, it is a cause of happiness. Thus, all of the parameters represents conditional associations. None are causal effects.</p>
<div class="sourceCode" id="cb234"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b6.9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b6.9</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span>
<span class="va">b6.10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">b6.10</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">b6.9</span>, <span class="va">b6.10</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>
<span class="co">#&gt;       elpd_diff se_diff</span>
<span class="co">#&gt; b6.9     0.0       0.0 </span>
<span class="co">#&gt; b6.10 -194.0      17.6</span>
<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">b6.9</span>, <span class="va">b6.10</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="co">#&gt;       elpd_diff se_diff</span>
<span class="co">#&gt; b6.9     0.0       0.0 </span>
<span class="co">#&gt; b6.10 -194.0      17.6</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>2.</strong> Reconsider the urban fox analysis from last week‚Äôs homework. On the basis of PSIS and WAIC scores, which combination of variables best predicts body weight (<span class="math inline">\(W\)</span>, <code>weight</code>)? How would you interpret the estimates from the best scoring model?</p>
</blockquote>
</div>
<p>As a reminder, here is the DAG for the fox data.</p>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/w4h2-1-1.png" width="40%" style="display: block; margin: auto;"></div>
<p>Last week we estimated many models to the fox data. Here are five models that predict weight with various combinations of predictors.</p>
<div class="sourceCode" id="cb235"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">foxes</span><span class="op">)</span>

<span class="va">fox_dat</span> <span class="op">&lt;-</span> <span class="va">foxes</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">area</span>, <span class="va">avgfood</span>, <span class="va">weight</span>, <span class="va">groupsize</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">standardize</span><span class="op">)</span><span class="op">)</span>

<span class="va">fox_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">avgfood</span> <span class="op">+</span> <span class="va">groupsize</span> <span class="op">+</span> <span class="va">area</span>, data <span class="op">=</span> <span class="va">fox_dat</span>,
             family <span class="op">=</span> <span class="va">gaussian</span>,
             prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>,<span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
             iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
             file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw4"</span>, <span class="st">"w4h2-1"</span><span class="op">)</span><span class="op">)</span>

<span class="va">fox_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">avgfood</span> <span class="op">+</span> <span class="va">groupsize</span>, data <span class="op">=</span> <span class="va">fox_dat</span>,
             family <span class="op">=</span> <span class="va">gaussian</span>,
             prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>,<span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
             iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
             file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw4"</span>, <span class="st">"w4h2-2"</span><span class="op">)</span><span class="op">)</span>

<span class="va">fox_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">groupsize</span> <span class="op">+</span> <span class="va">area</span>, data <span class="op">=</span> <span class="va">fox_dat</span>,
             family <span class="op">=</span> <span class="va">gaussian</span>,
             prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>,<span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
             iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
             file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw4"</span>, <span class="st">"w4h2-3"</span><span class="op">)</span><span class="op">)</span>

<span class="va">fox_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">avgfood</span> <span class="op">+</span> <span class="va">area</span>, data <span class="op">=</span> <span class="va">fox_dat</span>,
             family <span class="op">=</span> <span class="va">gaussian</span>,
             prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>,<span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
             iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
             file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw4"</span>, <span class="st">"w4h2-4"</span><span class="op">)</span><span class="op">)</span>

<span class="va">fox_5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">area</span>, data <span class="op">=</span> <span class="va">fox_dat</span>,
             family <span class="op">=</span> <span class="va">gaussian</span>,
             prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>,<span class="op">)</span>,
                       <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
             iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">2000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
             file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw4"</span>, <span class="st">"w4h2-5"</span><span class="op">)</span><span class="op">)</span>

<span class="va">fox_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">fox_1</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span>
<span class="va">fox_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">fox_2</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span>
<span class="va">fox_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">fox_3</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span>
<span class="va">fox_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">fox_4</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span>
<span class="va">fox_5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">fox_5</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Here again, the WAIC and PSIS scores are very similar. Both methods prefer model 1, which includes all three predictors in the model. However, the differences are often smaller than the standard error of difference, so the preference is not overly strong.</p>
<div class="sourceCode" id="cb236"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">fox_1</span>, <span class="va">fox_2</span>, <span class="va">fox_3</span>, <span class="va">fox_4</span>, <span class="va">fox_5</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>
<span class="co">#&gt;       elpd_diff se_diff</span>
<span class="co">#&gt; fox_1  0.0       0.0   </span>
<span class="co">#&gt; fox_3 -0.4       1.4   </span>
<span class="co">#&gt; fox_2 -0.4       1.7   </span>
<span class="co">#&gt; fox_5 -5.3       3.4   </span>
<span class="co">#&gt; fox_4 -5.7       3.3</span>

<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">fox_1</span>, <span class="va">fox_2</span>, <span class="va">fox_3</span>, <span class="va">fox_4</span>, <span class="va">fox_5</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="co">#&gt;       elpd_diff se_diff</span>
<span class="co">#&gt; fox_1  0.0       0.0   </span>
<span class="co">#&gt; fox_3 -0.4       1.4   </span>
<span class="co">#&gt; fox_2 -0.4       1.7   </span>
<span class="co">#&gt; fox_5 -5.3       3.4   </span>
<span class="co">#&gt; fox_4 -5.7       3.3</span></code></pre></div>
<p>We can interpret the coefficients for <code>fox_1</code> using the DAG. First for <code>avgfood</code>. Since, <code>groupsize</code> is in the model, the indirect path from food to weight is closed. Therefore, the coefficient for <code>avgfood</code> represents the direct effect of food on <code>weight</code>. Second, for <code>groupsize</code>, <code>avgfood</code> is a backdoor fork. So by closing this path, the group size coefficient represents the total (and also direct since this is only one path remaining) causal effect of group size on weight.</p>
<p>Finally, <code>area</code> is a little weird. Because <code>avgfood</code> is a pipe, mediating the relationship between <code>area</code> and <code>weight</code>, including <code>avgfood</code> should block the association between <code>area</code> and <code>weight</code>. This is indeed what we see in model 4, which includes only <code>area</code> and <code>avgfood</code>. There is a good deal of posterior probability on both sides of 0, indicating that the effect of <code>area</code> is could plausibly be negative or positive.</p>
<div class="sourceCode" id="cb237"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/brms/man/fixef.brmsfit.html">fixef</a></span><span class="op">(</span><span class="va">fox_4</span><span class="op">)</span>
<span class="co">#&gt;            Estimate Est.Error   Q2.5 Q97.5</span>
<span class="co">#&gt; Intercept -0.000187    0.0845 -0.165 0.166</span>
<span class="co">#&gt; avgfood   -0.148423    0.1740 -0.486 0.191</span>
<span class="co">#&gt; area       0.144857    0.1748 -0.199 0.483</span></code></pre></div>
<p>However, when <code>groupsize</code> is added as in the first model, we see that the association between <code>area</code> and <code>weight</code> increases, even though <code>avgfood</code> should still be blocking the path. Therefore, this indicates that something else may be going on in the data, or our DAG might be incorrect.</p>
<div class="sourceCode" id="cb238"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/brms/man/fixef.brmsfit.html">fixef</a></span><span class="op">(</span><span class="va">fox_1</span><span class="op">)</span>
<span class="co">#&gt;            Estimate Est.Error    Q2.5  Q97.5</span>
<span class="co">#&gt; Intercept -0.000224    0.0818 -0.1600  0.165</span>
<span class="co">#&gt; avgfood    0.294284    0.2156 -0.1308  0.718</span>
<span class="co">#&gt; groupsize -0.632656    0.1860 -0.9978 -0.268</span>
<span class="co">#&gt; area       0.275539    0.1746 -0.0716  0.622</span></code></pre></div>
<div class="question">
<blockquote>
<p><strong>3.</strong> Build a predictive model of the relationship shown on the cover of the book, the relationship between the timing of cherry blossoms and March temperature in the same year. The data are found in <code>data(cherry_blossoms)</code>. Consider at least two functions to predict <code>doy</code> with <code>temp</code>. Compare them with PSIS or WAIC.</p>
<p>Suppose March temperatures reach 9 degrees by the year 2050. What does your best model predict for the predictive distribution of the day-in-year that the cherry trees will blossom?</p>
</blockquote>
</div>
<p>For this exercise, I‚Äôll fit 2 spline models and a linear model. For the spline models I‚Äôll use 30 knots, one model with loose priors and the other with tighter priors.</p>
<div class="sourceCode" id="cb239"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">splines</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">cherry_blossoms</span><span class="op">)</span>
<span class="va">cb_dat</span> <span class="op">&lt;-</span> <span class="va">cherry_blossoms</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">doy</span>, <span class="va">temp</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> 

<span class="va">linear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">doy</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">temp</span>, data <span class="op">=</span> <span class="va">cb_dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
              prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">100</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                        <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
              iter <span class="op">=</span> <span class="fl">2000</span>, warmup <span class="op">=</span> <span class="fl">1000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
              file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw4"</span>, <span class="st">"w4h3-1"</span><span class="op">)</span><span class="op">)</span>

<span class="va">spline_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">doy</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/s.html">s</a></span><span class="op">(</span><span class="va">temp</span>, bs <span class="op">=</span> <span class="st">"bs"</span>, k <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">cb_dat</span>,
                family <span class="op">=</span> <span class="va">gaussian</span>,
                prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">100</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">0</span>, <span class="fl">5.9</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sds</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
                iter <span class="op">=</span> <span class="fl">2000</span>, warmup <span class="op">=</span> <span class="fl">1000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw4"</span>, <span class="st">"w4h3-2"</span><span class="op">)</span><span class="op">)</span>

<span class="va">spline_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">doy</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/s.html">s</a></span><span class="op">(</span><span class="va">temp</span>, bs <span class="op">=</span> <span class="st">"bs"</span>, k <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">cb_dat</span>,
                family <span class="op">=</span> <span class="va">gaussian</span>,
                prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">100</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">0</span>, <span class="fl">5.9</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sds</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
                iter <span class="op">=</span> <span class="fl">2000</span>, warmup <span class="op">=</span> <span class="fl">1000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw4"</span>, <span class="st">"w4h3-3"</span><span class="op">)</span><span class="op">)</span>


<span class="va">linear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">linear</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span>
<span class="va">spline_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">spline_1</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span>
<span class="va">spline_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">spline_2</span>, criterion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"waic"</span>, <span class="st">"loo"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>When comparing the models, both PSIS and WAIC prefer the linear. Although the two spline models perform almost identically, the standard errors of the differences between these models and the linear model are only about one fifth of the difference.</p>
<div class="sourceCode" id="cb240"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">linear</span>, <span class="va">spline_1</span>, <span class="va">spline_2</span>, criterion <span class="op">=</span> <span class="st">"waic"</span><span class="op">)</span>
<span class="co">#&gt;          elpd_diff se_diff</span>
<span class="co">#&gt; linear    0.0       0.0   </span>
<span class="co">#&gt; spline_2 -0.9       0.2   </span>
<span class="co">#&gt; spline_1 -1.0       0.2</span>

<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">linear</span>, <span class="va">spline_1</span>, <span class="va">spline_2</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="co">#&gt;          elpd_diff se_diff</span>
<span class="co">#&gt; linear    0.0       0.0   </span>
<span class="co">#&gt; spline_2 -1.0       0.2   </span>
<span class="co">#&gt; spline_1 -1.0       0.2</span></code></pre></div>
<p>Using our linear model, we can predict the the date of the first bloom with a March temperature of 9. We see expected value is around day 96, with an 89% compatibility interval of 87 to 106. Since 2050 is not a leap year, this corresponds to a first bloom between March 28 and April 16.</p>
<div class="sourceCode" id="cb241"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>temp <span class="op">=</span> <span class="fl">9</span><span class="op">)</span>

<span class="va">preds</span> <span class="op">&lt;-</span> <span class="va">new_dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_predicted_draws</a></span><span class="op">(</span><span class="va">linear</span><span class="op">)</span>

<span class="fu"><a href="http://mjskay.github.io/ggdist/reference/point_interval.html">mean_hdi</a></span><span class="op">(</span><span class="va">preds</span><span class="op">$</span><span class="va">.prediction</span>, .width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.89</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;      y ymin ymax .width .point .interval</span>
<span class="co">#&gt; 1 96.2 86.2  105   0.89   mean       hdi</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">preds</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_sample_slabinterval.html">stat_halfeye</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.89</span>, <span class="fl">0.97</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Day of Year"</span>, y <span class="op">=</span> <span class="st">"Posterior Predictive Density"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/w4h3-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<div class="question">
<blockquote>
<p><strong>4 - OPTIONAL CHALLENGE.</strong> The data in <code>data(Dinosaurs)</code> are body mass estimates at different estimated ages for six different dinosaur species. See <code><a href="https://rdrr.io/pkg/rethinking/man/Dinosaurs.html">?Dinosaurs</a></code> for more details. Choose one or more of these species (at least one, but as many as you like) and model its growth. To be precise: Make a predictive model of body mass using age as a predictor. Consider two or more model types for the function relating age to body mass and score each using PSIS and WAIC.</p>
<p>Which model do you think is best, on predictive grounds? On scientific grounds? If your answers to these questions differ, why?</p>
<p>This is a challenging exercise, because the data are so scarce. But it is also a realistic example, because people publish <em>Nature</em> papers with even less data. So do your best, and I look forward to seeing your growth curves.</p>
</blockquote>
</div>
<p>Not being familiar with biological growth models, this question stumped me. So I‚Äôll be pulling from <a href="https://github.com/rmcelreath/stat_rethinking_2022/blob/main/homework/week04_solutions.pdf">McElreath‚Äôs solution</a>, but translating everything to {tidyverse} and {brms}.</p>
<p>We start by loading the data and normalizing mass to be the proportion of maximum mass within each species. We also create sub-sample of just one dinosaur to more easily illustrate the various models we‚Äôll explore.</p>
<div class="sourceCode" id="cb242"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Dinosaurs</span><span class="op">)</span>

<span class="va">dino_dat</span> <span class="op">&lt;-</span> <span class="va">Dinosaurs</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>species_name <span class="op">=</span> <span class="va">species</span>, species <span class="op">=</span> <span class="va">sp_id</span>, <span class="va">age</span>, <span class="va">mass</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop_mass <span class="op">=</span> <span class="va">mass</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mass</span><span class="op">)</span>,
         species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">one_dino</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">dino_dat</span>, <span class="va">species</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>First up is a straight linear regression. This model looks just like all of the other regressions we‚Äôve fit with {brms} so far.</p>
<div class="sourceCode" id="cb243"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">one_dino_linear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="va">prop_mass</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">age</span>, data <span class="op">=</span> <span class="va">one_dino</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
                       prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,
                                 <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,
                                 <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
                       iter <span class="op">=</span> <span class="fl">2000</span>, warmup <span class="op">=</span> <span class="fl">1000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw4"</span>, <span class="st">"w4h4-one-linear"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Visualizing the model, we see that it actually does a pretty good job of fitting the data points for this one dinosaur, but leads to impossible predictions. For example, ages 0 to about 4 are predicted to have negative mass. Additionally, from a scientific perspective, linear growth doesn‚Äôt make any biological sense.</p>
<div class="sourceCode" id="cb244"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">new_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">16</span>, length.out <span class="op">=</span> <span class="fl">50</span><span class="op">)</span><span class="op">)</span>

<span class="va">new_dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">one_dino_linear</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_lineribbon.html">stat_lineribbon</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fl">0.89</span>, fill <span class="op">=</span> <span class="st">"#009FB7"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span>,
                  color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_lineribbon.html">stat_lineribbon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">one_dino</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">prop_mass</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.05</span><span class="op">)</span>, expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Age"</span>, y <span class="op">=</span> <span class="st">"Mass (normalized)"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/w4h4-3-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>The next model is a classic biological model called the von Bertalanffy growth model <span class="citation">(<a href="references.html#ref-bertalanffy" role="doc-biblioref">1934</a>)</span>. Under this models, organisms grow at a certain rate given the differential equation (my notation shifts a bit from McElreath‚Äôs solution to make the model fitting in {brms} easier):</p>
<p><span class="math display">\[
\frac{dM}{dA} = k(\phi - M)
\]</span></p>
<p>where <span class="math inline">\(M\)</span> is mass, <span class="math inline">\(A\)</span> is age, <span class="math inline">\(k\)</span> is a rate, and <span class="math inline">\(\phi\)</span> is the maximum adult size. Solving the equation gives us:</p>
<p><span class="math display">\[
M(A) = \phi(1 - \exp(-kA))
\]</span></p>
<p>We can define this equation in {brms} using the non-linear syntax, as <a href="https://bookdown.org/content/4857/generalized-linear-madness.html#statistical-model.">described by Solomon Kurz</a>.</p>
<div class="sourceCode" id="cb245"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">one_dino_bio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">prop_mass</span> <span class="op">~</span> <span class="va">phi</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">k</span> <span class="op">*</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span>,
                       <span class="va">phi</span> <span class="op">+</span> <span class="va">k</span> <span class="op">~</span> <span class="fl">1</span>,
                       nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">one_dino</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
                    prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">phi</span><span class="op">)</span>,
                              <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">k</span>, lb <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
                              <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
                    iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">3000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                    control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span>,
                    file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw4"</span>, <span class="st">"w4h4-one-bio"</span><span class="op">)</span><span class="op">)</span>

<span class="va">new_dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">one_dino_bio</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_lineribbon.html">stat_lineribbon</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fl">0.89</span>, fill <span class="op">=</span> <span class="st">"#009FB7"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span>,
                  color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_lineribbon.html">stat_lineribbon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">one_dino</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">prop_mass</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.05</span><span class="op">)</span>, expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Age"</span>, y <span class="op">=</span> <span class="st">"Mass (normalized)"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/w4h4-4-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>This looks worse that our original line, except for the fact that we no longer get implausible predictions. So that‚Äôs a win. The problem is that we want growth to be slow at first and then accelerate around age 5. In the von Bertalanffy growth model, this is accomplished by raising the growth function to a power, <span class="math inline">\(\theta\)</span>:</p>
<p><span class="math display">\[
M(A) = \phi(1 - \exp(-kA))^\theta
\]</span></p>
<p>We can again fit this model using the non-linear {brms} syntax.</p>
<div class="sourceCode" id="cb246"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">one_dino_acc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">prop_mass</span> <span class="op">~</span> <span class="va">phi</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">k</span> <span class="op">*</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">^</span> <span class="va">theta</span>,
                       <span class="va">phi</span> <span class="op">+</span> <span class="va">k</span> <span class="op">+</span> <span class="va">theta</span> <span class="op">~</span> <span class="fl">1</span>,
                       nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">one_dino</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
                    prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">phi</span><span class="op">)</span>,
                              <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">k</span>, lb <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
                              <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">theta</span>, lb <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
                              <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
                    iter <span class="op">=</span> <span class="fl">20000</span>, warmup <span class="op">=</span> <span class="fl">19000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                    control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.999</span>, max_treedepth <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,
                    file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw4"</span>, <span class="st">"w4h4-one-acc"</span><span class="op">)</span><span class="op">)</span>

<span class="va">new_dat</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">one_dino_acc</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">.epred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_lineribbon.html">stat_lineribbon</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fl">0.89</span>, fill <span class="op">=</span> <span class="st">"#009FB7"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span>,
                  color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_lineribbon.html">stat_lineribbon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">one_dino</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">prop_mass</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.05</span><span class="op">)</span>, expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Age"</span>, y <span class="op">=</span> <span class="st">"Mass (normalized)"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/w4h4-5-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>This looks pretty good! Comparing our models with PSIS, we see that the accelerated growth model is preferred, even after taking the standard errors into consideration.</p>
<div class="sourceCode" id="cb247"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">one_dino_linear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">one_dino_linear</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="va">one_dino_bio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">one_dino_bio</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="va">one_dino_acc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/add_criterion.html">add_criterion</a></span><span class="op">(</span><span class="va">one_dino_acc</span>, criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>

<span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span><span class="op">(</span><span class="va">one_dino_linear</span>, <span class="va">one_dino_bio</span>, <span class="va">one_dino_acc</span>,
            criterion <span class="op">=</span> <span class="st">"loo"</span><span class="op">)</span>
<span class="co">#&gt;                 elpd_diff se_diff</span>
<span class="co">#&gt; one_dino_acc     0.0       0.0   </span>
<span class="co">#&gt; one_dino_linear -2.8       0.5   </span>
<span class="co">#&gt; one_dino_bio    -4.4       0.8</span></code></pre></div>
<p>Now let‚Äôs fit that model to all of the dinosaurs in our data set. The only difference here is that we know index <code>phi</code>, <code>k</code>, and <code>theta</code> by species so that each will get their own curve.</p>
<div class="sourceCode" id="cb248"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_dinos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">prop_mass</span> <span class="op">~</span> <span class="va">phi</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">k</span> <span class="op">*</span> <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">^</span> <span class="va">theta</span>,
                    <span class="va">phi</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">species</span>,
                    <span class="va">k</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">species</span>,
                    <span class="va">theta</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">species</span>,
                    nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dino_dat</span>, family <span class="op">=</span> <span class="va">gaussian</span>,
                 prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">phi</span><span class="op">)</span>,
                           <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">k</span>, lb <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
                           <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="va">theta</span>, lb <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
                           <span class="fu"><a href="https://rdrr.io/pkg/brms/man/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html">exponential</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,
                 iter <span class="op">=</span> <span class="fl">10000</span>, warmup <span class="op">=</span> <span class="fl">9000</span>, chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
                 control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span>,
                 file <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"fits"</span>, <span class="st">"hw4"</span>, <span class="st">"w4h4-all"</span><span class="op">)</span><span class="op">)</span>

<span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">dino_dat</span>, <span class="va">species_name</span>, <span class="va">species</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html">expand_grid</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">16</span>, length.out <span class="op">=</span> <span class="fl">50</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="http://mjskay.github.io/tidybayes/reference/add_predicted_draws.html">add_epred_draws</a></span><span class="op">(</span><span class="va">all_dinos</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/ggdag/man/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">.epred</span>, fill <span class="op">=</span> <span class="va">species_name</span>, color <span class="op">=</span> <span class="va">species_name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_lineribbon.html">stat_lineribbon</a></span><span class="op">(</span>.width <span class="op">=</span> <span class="fl">0.89</span>, alpha <span class="op">=</span> <span class="fl">0.6</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_lineribbon.html">stat_lineribbon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dino_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">prop_mass</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_d</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"turbo"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_d</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"turbo"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2.05</span><span class="op">)</span>, expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Age"</span>, y <span class="op">=</span> <span class="st">"Mass (normalized)"</span>, fill <span class="op">=</span> <span class="st">"Species"</span>,
       color <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span>

<span class="va">p</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/w4h4-7-1.png" width="80%" style="display: block; margin: auto;"></div>
<p>There‚Äôs a lot of uncertainty in each curve, which isn‚Äôt unexpected given how few data points we have. To me it‚Äôs a little easier to digest if we split each species into it‚Äôs own plot. Overall, it looks like our models are doing a pretty good job of estimating the dinosaur growth!</p>
<div class="sourceCode" id="cb249"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">species_name</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span>, color <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="04-overfitting-mcmc_files/figure-html/w4h4-8-1.png" width="95%" style="display: block; margin: auto;"></div>

</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="causes-confounds-colliders.html"><span class="header-section-number">3</span> Causes, Confounds &amp; Colliders</a></div>
<div class="next"><a href="generalized-linear-models.html"><span class="header-section-number">5</span> Generalized Linear Models</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#overfitting-mcmc"><span class="header-section-number">4</span> Overfitting / MCMC</a></li>
<li><a class="nav-link" href="#lectures-3"><span class="header-section-number">4.1</span> Lectures</a></li>
<li>
<a class="nav-link" href="#exercises-3"><span class="header-section-number">4.2</span> Exercises</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#chapter-7"><span class="header-section-number">4.2.1</span> Chapter 7</a></li>
<li><a class="nav-link" href="#chapter-8"><span class="header-section-number">4.2.2</span> Chapter 8</a></li>
<li><a class="nav-link" href="#chapter-9"><span class="header-section-number">4.2.3</span> Chapter 9</a></li>
</ul>
</li>
<li><a class="nav-link" href="#homework-3"><span class="header-section-number">4.3</span> Homework</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/wjakethompson/sr2-solutions/blob/main/04-overfitting-mcmc.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/wjakethompson/sr2-solutions/edit/main/04-overfitting-mcmc.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Statistical Rethinking: Solutions (2nd Edition)</strong>" was written by Jake Thompson. It was last built on 2022-02-21.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
